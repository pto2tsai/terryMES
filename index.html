<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MES Lite V3.1</title>
    <style>
        /* ---------------------------------- */
        /* CSS: V3.1 穩定與清晰導航版 */
        /* ---------------------------------- */
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            
            --primary: #2196f3; 
            --accent: #00bcd4;  
            --success: #4caf50; 
            --warning: #ff9800; 
            --danger: #ef5350;  
            
            --nav-width: 80px; /* 加寬導航列以容納文字 */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: row;
            overflow: hidden;
        }

        /* --- 導航列 (改良版：圖示+文字) --- */
        .nav-bar {
            width: var(--nav-width);
            height: 100vh;
            background-color: #000;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 20px; z-index: 2000; /* 最高層級 */
            box-shadow: 2px 0 5px rgba(0,0,0,0.5); flex-shrink: 0;
            border-right: 1px solid #333;
        }
        
        .nav-group {
            display: flex; flex-direction: column; gap: 30px; margin-bottom: auto; width: 100%; align-items: center;
        }

        .nav-btn {
            background: none; border: none; cursor: pointer; 
            padding: 10px 5px;
            color: var(--text-sub); 
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            width: 100%;
            transition: all 0.1s;
        }
        
        .nav-btn svg { width: 28px; height: 28px; fill: currentColor; }
        .nav-btn span { font-size: 0.75rem; font-weight: bold; }

        .nav-btn:active { color: var(--accent); transform: scale(0.95); background: #222; }
        .nav-btn.active { color: var(--primary); border-right: 3px solid var(--primary); }

        .version-tag { font-size: 0.6rem; color: #444; margin-bottom: 10px; writing-mode: vertical-lr; }

        /* --- 主容器 --- */
        .container {
            flex: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        
        .screen { 
            display: none; width: 100%; max-width: 600px; 
            /* 移除動畫以增加穩定性 */
        }

        /* --- 登入畫面 --- */
        .login-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 90vh; width: 100%;
        }
        .login-title { font-size: 1.8rem; margin-bottom: 10px; color: var(--accent); letter-spacing: 2px; font-weight: bold; }
        
        .pin-dots {
            font-size: 3rem; letter-spacing: 15px; color: white;
            margin-bottom: 20px; height: 50px; line-height: 50px;
            text-align: center; min-width: 200px;
            text-shadow: 0 0 10px var(--primary);
        }

        /* --- 圓形鍵盤 (優化點擊) --- */
        .circle-keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 15px; margin-bottom: 20px;
        }
        .circle-btn {
            width: 75px; height: 75px; border-radius: 50%;
            background-color: #2a2a2a; color: white;
            font-size: 2rem; font-weight: bold;
            border: 2px solid #444;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none;
            box-shadow: 0 4px 0 #000;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .circle-btn:active { 
            transform: translateY(4px); 
            box-shadow: 0 0 0 #000; 
            background-color: #444;
            border-color: #888;
        }
        .circle-btn.clear { color: var(--danger); border-color: var(--danger); font-size: 1.2rem; }
        .circle-btn.ok { background-color: var(--success); color: black; border-color: var(--success); font-size: 1.2rem; }

        /* --- 一般按鈕 --- */
        .large-btn {
            width: 100%; padding: 18px; margin: 8px 0;
            font-size: 1.3rem; font-weight: bold;
            border-radius: 12px; border: none; cursor: pointer;
            color: white; background-color: var(--btn-bg);
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative; z-index: 10; /* 確保可點擊 */
        }
        .large-btn:active { 
            transform: translateY(4px); 
            box-shadow: 0 0 0 rgba(0,0,0,0.5); 
        }
        .btn-confirm { background-color: var(--success); color: #000; }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: #424242; border: 1px solid #555; }

        /* --- 排程列表 --- */
        .queue-item {
            background: #1e1e1e; border: 1px solid #444; border-left: 6px solid #444;
            padding: 18px; border-radius: 10px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; position: relative;
        }
        .queue-item:active { background: #333; transform: scale(0.99); }
        
        /* 進行中樣式 */
        .queue-item.active-job { 
            background: #1b5e20; 
            border-color: #66bb6a; 
            border-left-color: #00e676;
        }
        
        .q-info h3 { margin: 0 0 6px 0; font-size: 1.3rem; color: white; }
        .q-info p { margin: 0; color: #bbb; font-size: 1rem; }
        
        /* 狀態標籤 */
        .status-tag {
            font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #333; color: #aaa;
        }
        .active-job .status-tag { background: #00e676; color: black; font-weight: bold; }

        /* --- 計時畫面 --- */
        .timer-box {
            text-align: center; margin: 30px 0; padding: 20px;
            background: #000; border-radius: 20px; border: 1px solid #333;
        }
        .timer-val { font-size: 4rem; font-weight: bold; color: var(--accent); font-variant-numeric: tabular-nums; letter-spacing: 2px; }
        
        .job-card-large {
            background: #222; padding: 20px; border-radius: 15px;
            text-align: center; border: 1px solid #444; margin-bottom: 10px;
        }

        /* --- 生管表格 --- */
        .admin-panel { width: 100%; background: #111; padding: 15px; border-radius: 10px; }
        .admin-input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; margin-bottom: 10px; font-size: 1rem; border-radius: 5px;}

        /* --- Loading --- */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; /* 最高 */
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RWD */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            /* 手機版導航列改到底部，方便拇指操作，或保持頂部但優化 */
            .nav-bar { 
                width: 100%; height: 65px; flex-direction: row; padding: 0 10px; 
                border-right: none; border-top: 1px solid #333;
                order: 2; /* 放到最下面 (App 風格) */
            }
            .nav-group { flex-direction: row; justify-content: space-around; width: 100%; }
            .container { order: 1; padding-bottom: 10px; } /* 內容在上面 */
            .version-tag { display: none; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- 1. 登入 (ATM 風格) -->
        <div id="screen-login" class="screen" style="display: block;">
            <div class="login-wrapper">
                <div class="login-title">MES LITE <span style="font-size:0.8rem; color:#555;">V3.1</span></div>
                <div style="color:#888; margin-bottom: 10px;">請輸入識別碼 / ENTER PIN</div>
                
                <div id="pin-display" class="pin-dots"></div>
                <div id="login-msg" style="color: var(--danger); height: 20px;"></div>

                <div class="circle-keypad">
                    <div class="circle-btn" onclick="inputPin('1')">1</div>
                    <div class="circle-btn" onclick="inputPin('2')">2</div>
                    <div class="circle-btn" onclick="inputPin('3')">3</div>
                    <div class="circle-btn" onclick="inputPin('4')">4</div>
                    <div class="circle-btn" onclick="inputPin('5')">5</div>
                    <div class="circle-btn" onclick="inputPin('6')">6</div>
                    <div class="circle-btn" onclick="inputPin('7')">7</div>
                    <div class="circle-btn" onclick="inputPin('8')">8</div>
                    <div class="circle-btn" onclick="inputPin('9')">9</div>
                    <div class="circle-btn clear" onclick="inputPin('C')">C</div>
                    <div class="circle-btn" onclick="inputPin('0')">0</div>
                    <div class="circle-btn ok" onclick="inputPin('OK')">OK</div>
                </div>

                <div class="diagnostic-info" style="margin-top:20px; font-size:0.8rem; color:#444;">GAS: <span id="gas-status">Checking...</span></div>
            </div>
        </div>

        <!-- 2. 工單列表 (Queue) -->
        <div id="screen-queue" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin:0; color:var(--primary);">📋 待辦工單</h2>
                <div style="color: var(--accent); font-weight: bold;">
                    <span id="user-name">User</span>
                </div>
            </div>

            <!-- 進行中區域 -->
            <div id="active-section" style="margin-bottom: 20px; display: none;">
                <div style="font-size:0.9rem; color:var(--success); margin-bottom:5px; font-weight:bold;">🔥 進行中 (RUNNING)</div>
                <div id="active-list"></div>
            </div>

            <!-- 待辦區域 -->
            <div style="font-size:0.9rem; color:#888; margin-bottom:5px;">待辦事項 (To Do)</div>
            
            <!-- 強制刷新按鈕 -->
            <button class="large-btn btn-secondary" style="padding: 10px; font-size: 1rem; margin-bottom: 10px;" onclick="syncQueue()">🔄 重新整理列表</button>
            
            <div id="queue-list"></div>
        </div>

        <!-- 3. 人數輸入 (Manpower) -->
        <div id="screen-manpower" class="screen">
            <h2 style="text-align:center; color:var(--accent);">👥 開工設定</h2>
            <p style="text-align:center; color:#aaa;">本次投入多少人力？</p>
            <div id="manpower-val" style="font-size: 4rem; color: var(--success); margin: 20px 0; text-align:center; font-weight:bold;">0</div>
            
            <div class="circle-keypad">
                <div class="circle-btn" onclick="inputMan('1')">1</div>
                <div class="circle-btn" onclick="inputMan('2')">2</div>
                <div class="circle-btn" onclick="inputMan('3')">3</div>
                <div class="circle-btn" onclick="inputMan('4')">4</div>
                <div class="circle-btn" onclick="inputMan('5')">5</div>
                <div class="circle-btn" onclick="inputMan('6')">6</div>
                <div class="circle-btn" onclick="inputMan('7')">7</div>
                <div class="circle-btn" onclick="inputMan('8')">8</div>
                <div class="circle-btn" onclick="inputMan('9')">9</div>
                <div class="circle-btn clear" onclick="inputMan('C')">C</div>
                <div class="circle-btn" onclick="inputMan('0')">0</div>
                <div class="circle-btn ok" onclick="inputMan('OK')">GO</div>
            </div>
            <button class="large-btn btn-secondary" onclick="showScreen('queue')">取消 (Cancel)</button>
        </div>

        <!-- 4. 計時畫面 (Working) -->
        <div id="screen-working" class="screen" style="display: flex; flex-direction: column;">
            <div class="job-card-large">
                <div style="color:#4caf50; font-size:0.9rem; font-weight:bold; letter-spacing:1px;">● 正在執行 (RUNNING)</div>
                <h2 id="work-prod" style="margin:10px 0; font-size:1.8rem; color:white;">產品名稱</h2>
                <div id="work-op" style="color:var(--accent); font-size:1.4rem; font-weight:bold;">工序名稱</div>
                <div id="work-id" style="color:#555; font-size:0.8rem; margin-top:10px;">ID</div>
            </div>

            <div class="timer-box">
                <div class="timer-val" id="timer">00:00:00</div>
                <div style="color:#888; margin-top:10px;">目前人數: <span id="work-man" style="color:white; font-weight:bold; font-size:1.2rem;">4</span></div>
            </div>

            <div style="margin-top:auto;">
                <button class="large-btn btn-confirm" style="height: 80px; font-size: 1.8rem;" onclick="finishJob()">🏁 完成 (Finish)</button>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <button class="large-btn btn-secondary" onclick="adjustManpower()">👥 調整人數</button>
                    <button class="large-btn btn-secondary" onclick="showScreen('queue')">⬅ 暫離 (Back)</button>
                </div>
            </div>
        </div>

        <!-- 5. 生管後台 -->
        <div id="screen-admin" class="screen">
            <h2>🛠️ 生管控制台</h2>
            <div class="admin-panel">
                <h3>新增工單</h3>
                <input id="admin-mwo" class="admin-input" placeholder="總工單號 (MWO-xxx)">
                <input id="admin-prod" class="admin-input" placeholder="產品名稱">
                <input id="admin-op" class="admin-input" placeholder="工序名稱">
                <button class="large-btn btn-confirm" onclick="adminAddJob()">發布工單</button>
                <button class="large-btn btn-danger" style="margin-top:20px;" onclick="adminReset()">⚠️ 重置所有資料</button>
            </div>
            <div style="margin-top:20px;">
                <h3>目前排程</h3>
                <div id="admin-list"></div>
            </div>
        </div>

    </div>

    <!-- 導航列 (手機版在底部，電腦版在左側) -->
    <div class="nav-bar">
        <div class="nav-group">
            <button class="nav-btn" onclick="showScreen('queue')">
                <svg viewBox="0 0 24 24"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"/></svg>
                <span>工單列表</span>
            </button>
            
            <!-- 只有在特定畫面顯示返回，這裡簡化為固定顯示，由 JS 控制是否有效 -->
            
            <button class="nav-btn" onclick="logout()">
                <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                <span>登出</span>
            </button>
        </div>
        <div class="version-tag">V3.1</div>
    </div>

    <div id="loading-mask"><div class="spinner"></div><div style="color:white; margin-top:10px;">處理中...</div></div>

    <script>
        // ================= CONFIG =================
        // 🚨 請務必替換為您的 GAS Webhook URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyP9sYjwQ3pM7MMkrbiWTaUKmIeUcWhtWzPEqyhBlpHds7NfK6I49TTbEg4DWGsutBytA/exec";
        const TOKEN = "MES_LITE_2025";

        // ================= STATE =================
        let appData = { queue: [], activeJobs: {}, history: [], templates: [] };
        let uiState = { screen: 'login', pin: '', user: null, lang: 'zh', targetWoId: null, tempVal: '0' };
        
        // 預設資料
        const DEMO_QUEUE = [
            { wo_id: 'DEMO-001', master: 'TEST-A', prod_zh: '鮭魚分切', prod_vn: 'Cá hồi', op_zh: '分切', op_vn: 'Cắt lát', rank: 1 },
            { wo_id: 'DEMO-002', master: 'TEST-A', prod_zh: '中段厚切', prod_vn: 'Lát dày', op_zh: '真空', op_vn: 'Hút chân không', rank: 2 }
        ];

        // ================= INIT =================
        function init() {
            loadStorage();
            // 安全檢查：如果沒有資料，載入 Demo
            if (!appData.queue || appData.queue.length === 0) {
                appData.queue = JSON.parse(JSON.stringify(DEMO_QUEUE));
                saveStorage();
            }

            if (GAS_URL.includes("YOUR_GAS")) document.getElementById('gas-status').textContent = "URL 未設定";
            else document.getElementById('gas-status').textContent = "Ready";

            showScreen('login');
            
            // Timer Loop
            setInterval(() => {
                if(uiState.screen === 'working') updateTimerDisplay();
            }, 1000);
        }

        function loadStorage() {
            try {
                const raw = localStorage.getItem('mes_v3_data');
                if (raw) appData = JSON.parse(raw);
            } catch(e) { console.error("Load error", e); }
        }

        function saveStorage() {
            localStorage.setItem('mes_v3_data', JSON.stringify(appData));
        }

        // ================= NAVIGATION =================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById('screen-' + id).style.display = 'block';
            uiState.screen = id;

            if (id === 'queue') renderQueue();
            if (id === 'admin') renderAdmin();
            
            // 導航列控制
            const nav = document.querySelector('.nav-bar');
            if (id === 'login') nav.style.display = 'none';
            else nav.style.display = 'flex';
        }

        function logout() {
            if(confirm("確定登出？")) {
                uiState.user = null;
                uiState.pin = '';
                document.getElementById('pin-display').textContent = '_ _ _ _';
                showScreen('login');
            }
        }

        // ================= LOGIN =================
        function inputPin(key) {
            if(key === 'C') uiState.pin = '';
            else if(key === 'OK') {
                if(uiState.pin === '9999') {
                    uiState.user = { name: 'Admin', role: 'admin' };
                    showScreen('admin');
                } else if(uiState.pin === '1234' || uiState.pin === '5678') {
                    uiState.lang = (uiState.pin === '1234') ? 'vn' : 'zh';
                    uiState.user = { name: uiState.lang==='vn'?'Nguyễn':'陳主管', role: 'op' };
                    document.getElementById('user-name').textContent = uiState.user.name;
                    showScreen('queue');
                } else {
                    document.getElementById('login-msg').textContent = "密碼錯誤";
                    uiState.pin = '';
                }
            } else {
                if(uiState.pin.length < 4) uiState.pin += key;
            }
            
            const dots = uiState.pin.length > 0 ? '● '.repeat(uiState.pin.length) : '_ _ _ _';
            document.getElementById('pin-display').textContent = dots;
        }

        // ================= QUEUE & LIST =================
        function renderQueue() {
            const list = document.getElementById('queue-list');
            const activeList = document.getElementById('active-list');
            const activeSec = document.getElementById('active-section');
            
            list.innerHTML = ''; activeList.innerHTML = '';
            let hasActive = false;

            // 1. Active Jobs
            Object.keys(appData.activeJobs).forEach(id => {
                const job = appData.queue.find(q => q.wo_id === id);
                if(job) {
                    const session = appData.activeJobs[id];
                    const div = document.createElement('div');
                    div.className = 'queue-item active-job';
                    div.innerHTML = `
                        <div class="q-info">
                            <div class="status-tag">執行中</div>
                            <h3>${uiState.lang==='vn'?job.prod_vn:job.prod_zh} - ${uiState.lang==='vn'?job.op_vn:job.op_zh}</h3>
                            <p>👥 ${session.manpower} | ${job.master}</p>
                        </div>
                        <div style="font-size:1.5rem;">▶️</div>
                    `;
                    div.onclick = () => openWorkingScreen(id);
                    activeList.appendChild(div);
                    hasActive = true;
                }
            });
            activeSec.style.display = hasActive ? 'block' : 'none';

            // 2. Todo Jobs
            const todo = appData.queue.filter(q => !appData.activeJobs[q.wo_id]);
            if(todo.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">無待辦工單</div>';
            
            todo.forEach(job => {
                const div = document.createElement('div');
                div.className = 'queue-item';
                div.innerHTML = `
                    <div class="q-info">
                        <h3>${uiState.lang==='vn'?job.prod_vn:job.prod_zh} - ${uiState.lang==='vn'?job.op_vn:job.op_zh}</h3>
                        <p>${job.master}</p>
                        <div class="q-id">${job.wo_id}</div>
                    </div>
                `;
                // Fix: Ensure ID is passed correctly
                div.onclick = () => prepareJob(job.wo_id);
                list.appendChild(div);
            });
        }
        
        function syncQueue() {
            // 模擬同步：重新載入 Storage
            loadStorage();
            renderQueue();
            alert("已刷新列表");
        }

        // ================= WORKING FLOW =================
        function prepareJob(id) {
            if(!id) return alert("工單 ID 錯誤");
            uiState.targetWoId = id;
            uiState.tempVal = '0';
            document.getElementById('manpower-val').textContent = '0';
            showScreen('manpower');
        }

        function inputMan(key) {
            if(key === 'C') uiState.tempVal = '0';
            else if(key === 'OK') {
                const val = parseInt(uiState.tempVal);
                if(val > 0) startSession(uiState.targetWoId, val);
                else alert("人數需大於 0");
            } else {
                uiState.tempVal = (uiState.tempVal === '0' ? key : uiState.tempVal + key);
            }
            document.getElementById('manpower-val').textContent = uiState.tempVal;
        }

        function startSession(woId, manpower) {
            const now = Date.now();
            appData.activeJobs[woId] = {
                startISO: new Date().toISOString(),
                lastUpdate: now,
                accTime: 0,
                manpower: manpower
            };
            saveStorage();
            openWorkingScreen(woId);
        }

        function openWorkingScreen(woId) {
            uiState.targetWoId = woId;
            const job = appData.queue.find(j => j.wo_id === woId);
            const session = appData.activeJobs[woId];
            
            if(!job || !session) { showScreen('queue'); return; }

            document.getElementById('work-prod').textContent = uiState.lang==='vn' ? job.prod_vn : job.prod_zh;
            document.getElementById('work-op').textContent = uiState.lang==='vn' ? job.op_vn : job.op_zh;
            document.getElementById('work-id').textContent = woId;
            document.getElementById('working-manpower').textContent = session.manpower;
            
            updateTimerDisplay();
            showScreen('working');
        }

        function updateTimerDisplay() {
            if (uiState.screen !== 'working' || !uiState.targetWoId) return;
            const session = appData.activeJobs[uiState.targetWoId];
            if (!session) return;

            const diff = Date.now() - session.lastUpdate;
            const sec = Math.floor(diff / 1000);
            const h = String(Math.floor(sec / 3600)).padStart(2,'0');
            const m = String(Math.floor((sec % 3600) / 60)).padStart(2,'0');
            const s = String(sec % 60).padStart(2,'0');
            document.getElementById('working-timer').textContent = `${h}:${m}:${s}`;
        }

        function adjustManpower() {
            const current = appData.activeJobs[uiState.targetWoId].manpower;
            const next = prompt("輸入新的人數:", current);
            if(next && parseInt(next) > 0) {
                const now = Date.now();
                const session = appData.activeJobs[uiState.targetWoId];
                session.accTime += (now - session.lastUpdate) * session.manpower; 
                session.lastUpdate = now;
                session.manpower = parseInt(next);
                saveStorage();
                document.getElementById('working-manpower').textContent = session.manpower;
            }
        }
        
        function backToQueue() { showScreen('queue'); }

        // ================= FINISH & SUBMIT =================
        async function finishJob() {
            if(!confirm("確定完成並送出工單？")) return;

            document.getElementById('loading-mask').style.display = 'flex';
            
            const session = appData.activeJobs[uiState.targetWoId];
            const job = appData.queue.find(j => j.wo_id === uiState.targetWoId);
            
            // 計算
            const now = Date.now();
            const totalMs = session.accTime + ((now - session.lastUpdate) * session.manpower);
            const totalHours = totalMs / 3600000.0;
            
            // 反推 Start Time 供後端使用
            const effectiveDuration = totalMs / session.manpower;
            const effectiveStart = new Date(now - effectiveDuration).toISOString();

            const payload = {
                token: TOKEN,
                action: 'LOG_WORK',
                wo_id: uiState.targetWoId,
                operation_name: job.op_zh,
                supervisor_pin: uiState.pin,
                manpower_count: session.manpower,
                start_time: effectiveStart,
                // 數量預設 0 (Time Only Mode)
                qty_good: 0, qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0
            };

            try {
                await fetch(GAS_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(payload)
                });
                
                // 成功
                delete appData.activeJobs[uiState.targetWoId];
                // 移除已完成的工單
                appData.queue = appData.queue.filter(q => q.wo_id !== uiState.targetWoId);
                saveStorage();
                
                document.getElementById('loading-mask').style.display = 'none';
                showScreen('queue');

            } catch(e) {
                alert("連線失敗，請檢查網路");
                document.getElementById('loading-mask').style.display = 'none';
            }
        }

        // ================= ADMIN =================
        function adminAddJob() {
            const mwo = document.getElementById('admin-mwo').value;
            const prod = document.getElementById('admin-prod').value;
            const op = document.getElementById('admin-op').value;
            
            if(mwo && prod && op) {
                appData.queue.push({
                    wo_id: `${mwo}-Q${Date.now()}`,
                    master: mwo, prod_zh: prod, prod_vn: prod,
                    op_zh: op, op_vn: op, rank: appData.queue.length+1
                });
                saveStorage();
                renderAdmin();
                alert("已新增");
                // 清空
                document.getElementById('admin-prod').value = '';
                document.getElementById('admin-op').value = '';
            }
        }

        function renderAdmin() {
            const div = document.getElementById('admin-list');
            div.innerHTML = appData.queue.map(q => `
                <div style="border-bottom:1px solid #333; padding:10px;">${q.master} - ${q.prod_zh} - ${q.op_zh}</div>
            `).join('');
        }

        function adminReset() {
            if(confirm("重置所有資料？")) { localStorage.clear(); location.reload(); }
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>