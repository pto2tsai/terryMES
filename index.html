<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MES Lite V4.2 Admin Layout</title>
    <style>
        /* ---------------------------------- */
        /* CSS: V4.2 ç”Ÿç®¡é›™æ¬„ä½ˆå±€å„ªåŒ–ç‰ˆ */
        /* ---------------------------------- */
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            
            --primary: #2196f3; 
            --accent: #00bcd4;  
            --success: #4caf50; 
            --warning: #ff9800; 
            --danger: #f44336;  
            
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: row;
            overflow: hidden;
        }

        /* --- å°èˆªåˆ— --- */
        .nav-bar {
            width: 80px;
            height: 100vh;
            background-color: #000;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 20px; z-index: 1000;
            border-right: 1px solid #333;
            flex-shrink: 0;
        }
        
        .nav-btn {
            background: none; border: none; cursor: pointer; 
            padding: 15px 5px; margin-bottom: 20px;
            color: var(--text-sub); 
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            width: 100%;
        }
        
        .nav-btn svg { width: 32px; height: 32px; fill: currentColor; }
        .nav-btn span { font-size: 0.75rem; font-weight: bold; }
        .nav-btn:active { color: var(--accent); background: #222; }

        .version-tag { font-size: 0.6rem; color: #444; margin-top: auto; margin-bottom: 10px; writing-mode: vertical-lr; }

        /* --- ä¸»å®¹å™¨ --- */
        .container {
            flex: 1; padding: 10px; overflow-y: auto;
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        
        .screen { 
            display: none; width: 100%; max-width: 100%; 
        }

        /* --- çµ±ä¸€ ATM åœ“å½¢éµç›¤ --- */
        .pin-display {
            font-size: 3rem; letter-spacing: 10px; color: var(--accent);
            margin-bottom: 20px; height: 60px; line-height: 60px;
            text-align: center; border-bottom: 2px solid #333; width: 100%;
        }
        
        .circle-keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 15px; margin: 0 auto 20px auto; width: 100%; max-width: 350px;
        }
        .circle-btn {
            width: 80px; height: 80px; border-radius: 50%;
            background-color: #2a2a2a; color: white;
            font-size: 2rem; font-weight: bold;
            border: 2px solid #444;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none;
            margin: 0 auto;
        }
        .circle-btn:active { background-color: #555; border-color: #888; transform: translateY(2px); }
        .circle-btn.clear { color: var(--danger); border-color: var(--danger); font-size: 1.2rem; }
        .circle-btn.ok { background-color: var(--success); color: #000; border-color: var(--success); font-size: 1.2rem; }

        /* --- ä¸€èˆ¬æŒ‰éˆ• --- */
        .large-btn {
            width: 100%; padding: 15px; margin: 8px 0;
            font-size: 1.3rem; font-weight: bold;
            border-radius: 10px; border: none; cursor: pointer;
            color: white; background-color: var(--btn-bg);
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            position: relative;
        }
        .large-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-confirm { background-color: var(--success); color: #000; }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: #424242; border: 1px solid #555; }

        /* --- æ’ç¨‹åˆ—è¡¨ --- */
        .queue-item {
            background: #1e1e1e; border: 1px solid #444; border-left: 6px solid #444;
            padding: 15px; border-radius: 10px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .queue-item:active { background: #333; }
        .queue-item.active-job { 
            background: #1b5e20; border-color: #66bb6a; border-left-color: #00e676;
        }
        .q-info h3 { margin: 0 0 5px 0; font-size: 1.3rem; color: white; }
        .q-info p { margin: 0; color: #bbb; font-size: 1rem; }
        
        /* --- è¨ˆæ™‚ç•«é¢ --- */
        .timer-box {
            text-align: center; margin: 20px 0; padding: 20px;
            background: #000; border-radius: 15px; border: 1px solid #333;
        }
        .timer-val { font-size: 4rem; font-weight: bold; color: var(--accent); font-variant-numeric: tabular-nums; }
        
        .job-card-large {
            background: #222; padding: 15px; border-radius: 15px;
            text-align: center; border: 1px solid #444; margin-bottom: 10px;
        }

        /* --- ç”Ÿç®¡å¾Œå° --- */
        .admin-dashboard-layout {
            display: flex; flex-direction: column; gap: 20px;
        }

        .admin-panel, .admin-list-panel { 
            width: 100%; background: #111; padding: 15px; border-radius: 10px; 
            border: 1px solid #333;
        }
        /* ç”Ÿç®¡å³å´åˆ—è¡¨å°ˆç”¨æ¨£å¼ */
        .admin-list-panel {
            max-height: 70vh; 
            overflow-y: auto;
        }

        .admin-input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; margin-bottom: 10px; font-size: 1rem; border-radius: 5px;}
        
        .sub-item-row { display: grid; grid-template-columns: 1fr 1fr 40px; gap: 5px; margin-bottom: 8px; }
        .btn-row-delete { background: #444; border: 1px solid #666; color: #ccc; border-radius: 4px; cursor: pointer; }
        .template-area { background: #222; padding: 10px; border-radius: 8px; border: 1px dashed #444; margin-bottom: 15px; }

        /* å ±è¡¨è¡¨æ ¼ */
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .report-table th { background: #333; color: var(--primary); padding: 8px; text-align: left; }
        .report-table td { border-bottom: 1px solid #444; padding: 8px; }
        .report-total { font-weight: bold; color: var(--success); }
        
        /* Checkbox */
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px; 
            padding: 10px; background: #222; border-radius: 5px; border: 1px solid #444;
        }
        .checkbox-wrapper input { width: 20px; height: 20px; accent-color: var(--success); }

        /* --- Loading --- */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RWD æ‰‹æ©Ÿç‰ˆ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .nav-bar { 
                width: 100%; height: 65px; flex-direction: row; padding: 0 10px; 
                border-right: none; border-top: 1px solid #333; order: 2;
            }
            .container { order: 1; padding-bottom: 10px; }
            .nav-btn { margin-bottom: 0; flex-direction: column; padding: 5px; }
            .nav-icons { flex-direction: row; justify-content: space-around; width: 100%; gap: 0; }
            .version-tag { display: none; }
            .sub-item-row { grid-template-columns: 1fr; gap: 5px; border-bottom: 1px solid #333; padding-bottom: 5px; }
            .btn-row-delete { grid-column: 1 / -1; padding: 8px; margin-top: 2px; }
            /* æ‰‹æ©Ÿç‰ˆå †ç–Šé¡¯ç¤º */
            .admin-dashboard-layout { display: flex; flex-direction: column; }
        }

        /* RWD é›»è…¦ç‰ˆå„ªåŒ– (V4.2 æ–°å¢) */
        @media (min-width: 769px) {
            .container {
                max-width: 1000px; /* åŠ å¯¬å®¹å™¨ */
                background-color: var(--bg-color);
                box-shadow: 0 0 30px rgba(0,0,0,0.8); 
                margin: 20px 0;
                height: calc(100vh - 40px); 
                border-radius: 20px;
                overflow: hidden; 
                padding-left: 80px; /* é¿é–‹å°èˆªåˆ— */
                width: 100%;
            }
            .nav-bar {
                position: absolute; left: 0; top: 0; height: 100%; width: 80px;
                border-radius: 20px 0 0 20px;
            }
            /* ç”Ÿç®¡æ§åˆ¶å°é›™æ¬„ä½ˆå±€ */
            .admin-dashboard-layout {
                display: grid;
                grid-template-columns: 1fr 1fr; /* å·¦å³å„åŠ */
                gap: 20px;
                height: 100%;
                overflow: hidden;
            }
            .admin-panel {
                height: 100%;
                overflow-y: auto;
            }
            .admin-list-panel {
                height: 100%;
                max-height: none; /* ç§»é™¤é«˜åº¦é™åˆ¶ï¼Œè·Ÿéš¨çˆ¶å®¹å™¨ */
            }
            /* ä¸€èˆ¬æ“ä½œç•«é¢é™åˆ¶å¯¬åº¦ï¼Œä¿æŒå±…ä¸­ç¾è§€ */
            .login-box, #screen-queue, #screen-manpower, #screen-working, #screen-finish {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
            }
            .keypad { max-width: 500px; gap: 15px; }
            .key-btn { font-size: 2rem; padding: 25px 0; }
            .job-item { padding: 20px; }
            .job-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- 1. ç™»å…¥ (ATM é¢¨æ ¼) -->
        <div id="screen-login" class="screen" style="display: block;">
            <div class="login-wrapper">
                <div class="login-title">MES LITE <span style="font-size:0.8rem; color:#555;">V4.2</span></div>
                <div style="color:#888; margin-bottom: 10px;">è«‹è¼¸å…¥è­˜åˆ¥ç¢¼ / ENTER PIN</div>
                
                <div id="pin-display" class="pin-display">_ _ _ _</div>
                <div id="login-msg" style="color: var(--danger); height: 20px; margin-bottom:10px;"></div>

                <div id="login-keypad"></div>

                <div style="margin-top:20px; font-size:0.8rem; color:#444;">
                    Status: <span id="cloud-status">Connecting...</span>
                </div>
            </div>
        </div>

        <!-- 2. å·¥å–®åˆ—è¡¨ (Queue) -->
        <div id="screen-queue" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin:0; color:var(--primary);">ğŸ“‹ å¾…è¾¦å·¥å–®</h2>
                <div style="color: var(--accent); font-weight: bold;">
                    <span id="user-name">User</span>
                </div>
            </div>
            <div class="cloud-status" id="last-sync-time"></div>

            <div id="active-section" style="margin-bottom: 20px; display: none;">
                <div style="font-size:0.9rem; color:var(--success); margin-bottom:5px; font-weight:bold;">ğŸ”¥ é€²è¡Œä¸­ (RUNNING)</div>
                <div id="active-list"></div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div style="font-size:0.9rem; color:#888;">å¾…è¾¦äº‹é … (To Do) <span id="last-sync-time" style="font-size:0.7rem; color:#555;"></span></div>
                <button onclick="syncData()" style="background:none; border:1px solid #555; color:#888; border-radius:4px; padding:4px 8px; font-size:0.8rem;">ğŸ”„ é›²ç«¯åŒæ­¥</button>
            </div>
            <div id="queue-list"></div>
        </div>

        <!-- 3. äººæ•¸è¼¸å…¥ -->
        <div id="screen-manpower" class="screen">
            <h2 id="manpower-title" style="text-align:center; color:var(--accent);">ğŸ‘¥ é–‹å·¥è¨­å®š</h2>
            <p id="manpower-desc" style="text-align:center; color:#aaa;">æœ¬æ¬¡æŠ•å…¥å¤šå°‘äººåŠ›ï¼Ÿ</p>
            <div id="manpower-display" class="pin-display">0</div>
            <div id="manpower-keypad"></div>
            <button class="large-btn btn-secondary" onclick="cancelManpower()">å–æ¶ˆ (Cancel)</button>
        </div>

        <!-- 4. è¨ˆæ™‚ç•«é¢ -->
        <div id="screen-working" class="screen" style="display: flex; flex-direction: column;">
            <div class="job-card-large">
                <div style="color:#4caf50; font-size:0.9rem; font-weight:bold; letter-spacing:1px;">â— æ­£åœ¨åŸ·è¡Œ (CLOUD)</div>
                <h2 id="work-prod" style="margin:10px 0; font-size:1.8rem; color:white;">ç”¢å“åç¨±</h2>
                <div id="work-op" style="color:var(--accent); font-size:1.4rem; font-weight:bold;">å·¥åºåç¨±</div>
                <div id="work-id" style="color:#555; font-size:0.8rem; margin-top:10px;">ID</div>
                <!-- æ•¸æ“šè¦æ±‚æç¤º -->
                <div id="work-req-data" style="color:#ff9800; font-size:0.9rem; margin-top:5px; display:none;">âš ï¸ çµæŸæ™‚éœ€è¼¸å…¥æ•¸æ“š</div>
            </div>
            <div class="timer-box">
                <div class="timer-val" id="timer">00:00:00</div>
                <div style="color:#888; margin-top:10px;">ç›®å‰äººæ•¸: <span id="work-man" style="color:white; font-weight:bold; font-size:1.2rem;">4</span></div>
            </div>
            <div style="margin-top:auto;">
                <button class="large-btn btn-confirm" style="height: 80px; font-size: 1.8rem;" onclick="endJob()">ğŸ å®Œæˆ (Finish)</button>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <button class="large-btn btn-secondary" onclick="adjustManpower()">ğŸ‘¥ èª¿æ•´äººæ•¸</button>
                    <button class="large-btn btn-secondary" onclick="showScreen('queue')">â¬… æš«é›¢</button>
                </div>
            </div>
        </div>

        <!-- 5. æ•¸é‡è¼¸å…¥/ç¢ºèª -->
        <div id="screen-finish" class="screen">
            <div id="finish-instruction" style="font-size: 1.5rem; text-align: center; margin-bottom: 10px; color: var(--accent); font-weight: bold;"></div>
            <div id="qty-display" class="pin-display">0</div>
            <div id="finish-summary" style="text-align: left; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;"></div>
            <div id="finish-keypad"></div>
        </div>

        <!-- 6. ç”Ÿç®¡å¾Œå° (V4.2 é›™æ¬„ä½ˆå±€) -->
        <div id="screen-admin" class="screen" style="width: 100%; max-width: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0;">ğŸ› ï¸ ç”Ÿç®¡æ§åˆ¶å°</h2>
                <button onclick="logout()" style="background:#333; color:#ccc; border:none; padding:5px 10px; border-radius:4px;">é€€å‡º</button>
            </div>

            <div class="admin-header">
                <button class="admin-tab active" onclick="showAdminTab('create')">å»ºç«‹å·¥å–®</button>
                <button class="admin-tab" onclick="showAdminTab('history')">å·¥æ™‚å ±è¡¨</button>
            </div>
            
            <!-- å»ºç«‹å·¥å–® Tab (é›™æ¬„ä½ˆå±€å®¹å™¨) -->
            <div id="admin-tab-create">
                <div class="admin-dashboard-layout">
                    
                    <!-- å·¦æ¬„ï¼šè¼¸å…¥èˆ‡è¨­å®š -->
                    <div class="admin-panel">
                        <div class="template-area">
                            <label style="color:#aaa; font-size:0.8rem;">ğŸ“‚ ç¯„æœ¬ç®¡ç†</label>
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <select id="admin-template" class="admin-input" style="margin:0; flex:1;" onchange="loadTemplate()">
                                    <option value="">-- è¼‰å…¥ç¯„æœ¬ --</option>
                                </select>
                                <button class="btn-danger" style="padding:0 15px; border-radius:4px; border:none; cursor:pointer;" onclick="deleteTemplate()">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <h3>æ–°å¢å·¥å–® (Batch)</h3>
                        
                        <input id="admin-mwo" class="admin-input" placeholder="ç¸½å·¥å–®è™Ÿ (ä¾‹: MWO-2025-A)">
                        <input type="number" id="admin-weight" class="admin-input" placeholder="åŸæ–™ç¸½é‡ (KG)">
                        
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="admin-req-data">
                            <label for="admin-req-data" style="color:#fff; font-size:0.9rem; cursor:pointer;">è¦æ±‚ç¾å ´è¼¸å…¥ç”Ÿç”¢æ•¸æ“š (Input Required)</label>
                        </div>

                        <div style="border-top:1px solid #333; margin:15px 0; padding-top:10px;">
                            <label style="color:#888; font-size:0.9rem;">å·¥åºæ¸…å–®</label>
                            <div id="admin-sub-items"></div>
                            <button onclick="addAdminRow()" style="width:100%; padding:10px; background:#333; border:1px dashed #555; color:#ccc; margin-top:10px; cursor:pointer;">+ æ–°å¢ä¸€è¡Œ</button>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                            <button class="large-btn btn-secondary" style="font-size:1rem;" onclick="saveTemplate()">ğŸ’¾ å­˜ç‚ºç¯„æœ¬</button>
                            <button class="large-btn btn-confirm" style="font-size:1rem;" onclick="publishWorkOrders()">ğŸš€ ç™¼å¸ƒå·¥å–®</button>
                        </div>
                        <button class="large-btn btn-danger" style="margin-top:20px; font-size:1rem; background:#300; border-color:#500;" onclick="adminReset()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                    </div>

                    <!-- å³æ¬„ï¼šç›®å‰æ’ç¨‹åˆ—è¡¨ -->
                    <div class="admin-list-panel">
                        <h3>ç›®å‰æ’ç¨‹é è¦½ (<span id="queue-count">0</span> ç­†)</h3>
                        <div id="admin-list"></div>
                    </div>
                </div>
            </div>

            <!-- åŒ¯å‡ºå ±è¡¨ Tab -->
            <div id="admin-tab-history" style="display:none;">
                <div class="admin-panel">
                    <h3>ğŸ“Š äººå·¥æ™‚æ•¸ç¸½è¨ˆè¡¨</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="color:#888; font-size:0.8rem;">çµ±è¨ˆç¶­åº¦:</span>
                        <select id="report-group-by" onchange="renderSummaryTable()" style="background:#222; color:white; border:1px solid #555; padding:5px; border-radius:4px;">
                            <option value="by-op">ä¾å·¥åº (By Operation)</option>
                            <option value="by-master">ä¾ç¸½å·¥å–® (By Master WO)</option>
                        </select>
                    </div>
                    <div id="summary-table-container" style="margin-top:15px;"></div>
                    <button class="large-btn btn-secondary" style="margin-top:20px;" onclick="renderSummaryTable()">ğŸ”„ åˆ·æ–°çµ±è¨ˆ</button>
                </div>
                <div style="margin-top:20px;">
                    <h3>ğŸ“œ è©³ç´°ç´€éŒ„åˆ—è¡¨</h3>
                    <div id="history-list" style="font-size:0.8rem; color:#aaa;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- å°èˆªåˆ— -->
    <div class="nav-bar">
        <div class="nav-icons">
            <button class="nav-btn" onclick="showScreen('queue')">
                <svg viewBox="0 0 24 24"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"/></svg>
                <span>å·¥å–®</span>
            </button>
            <button class="nav-btn" onclick="logout()">
                <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                <span>ç™»å‡º</span>
            </button>
        </div>
        <div class="version-tag">V4.2</div>
    </div>

    <div id="loading-mask"><div class="spinner"></div><div style="color:white; margin-top:10px;">é›²ç«¯åŒæ­¥ä¸­...</div></div>

    <script>
        // ğŸš¨ è«‹å‹™å¿…æ›¿æ›ç‚ºæ‚¨çš„ GAS Webhook URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyP9sYjwQ3pM7MMkrbiWTaUKmIeUcWhtWzPEqyhBlpHds7NfK6I49TTbEg4DWGsutBytA/exec";
        const TOKEN = "MES_LITE_2025";

        let appData = { queue: [], activeJobs: {}, history: [], templates: [] }; 
        let uiState = { screen: 'login', pin: '', user: null, lang: 'zh', targetWoId: null, tempVal: '0', finishStep: 0, finishCache: {}, isAdjusting: false };
        let syncTimer = null;

        const I18N = {
            zh: { welcome: 'ä½ å¥½', running: 'é€²è¡Œä¸­', waiting: 'å¾…è¾¦', finish: 'å®Œæˆ', back: 'æš«é›¢', confirm: 'ç¢ºèªé€å‡º', step_reject: 'âŒ è¼¸å…¥æè€— (KG)', step_collar: 'ä¸‹å·´é‡é‡ (KG)', step_tail: 'å°¾æ®µé‡é‡ (KG)', step_total: 'âœ… è‰¯å“/ç¸½é‡ (KG)', summary: 'ğŸ“‹ è«‹ç¢ºèªè³‡æ–™' },
            vn: { welcome: 'Xin chÃ o', running: 'Äang cháº¡y', waiting: 'Chá»', finish: 'HoÃ n táº¥t', back: 'Quay láº¡i', confirm: 'XÃ¡c nháº­n', step_reject: 'âŒ Há»ng (KG)', step_collar: 'Cáº±m (KG)', step_tail: 'ÄuÃ´i (KG)', step_total: 'âœ… Tá»•ng (KG)', summary: 'ğŸ“‹ XÃ¡c nháº­n' }
        };

        function init() {
            loadStorage(); // å…ˆè¼‰å…¥æœ¬åœ°ç·©å­˜
            renderATMKeypad('login-keypad', handleLoginInput);
            renderATMKeypad('manpower-keypad', handleManpowerInput);
            renderATMKeypad('finish-keypad', handleFinishInput);
            
            if (GAS_URL.includes("YOUR")) alert("è«‹è¨­å®š GAS URL!");
            
            showScreen('login');
            syncData(true); // å•Ÿå‹•å³åˆ»åŒæ­¥
            
            syncTimer = setInterval(() => {
                if (uiState.user) syncData(true); 
            }, 10000);

            setInterval(() => { if(uiState.screen === 'working') updateTimerDisplay(); }, 1000);
        }

        function loadStorage() {
            try {
                const raw = localStorage.getItem('mes_v4_data');
                if (raw) appData = JSON.parse(raw);
                if (!appData.templates) appData.templates = [];
                if (!appData.history) appData.history = [];
                if (Array.isArray(appData.activeJobs)) appData.activeJobs = {};
            } catch(e) { console.error(e); }
        }

        function saveStorage() { localStorage.setItem('mes_v4_data', JSON.stringify(appData)); }

        // --- CLOUD SYNC ---
        async function syncData(silent = false) {
            if (!silent) document.getElementById('loading-mask').style.display = 'flex';
            document.getElementById('cloud-status').textContent = "Syncing...";

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    // ä½¿ç”¨ text/plain é¿å… CORS preflight
                    headers: { 'Content-Type': 'text/plain' }, 
                    body: JSON.stringify({ action: 'GET_STATE', token: TOKEN })
                });
                const data = await res.json();

                if (data.success) {
                    appData.queue = data.queue || [];
                    
                    const cloudActiveMap = {};
                    if (data.active) {
                        data.active.forEach(job => {
                            cloudActiveMap[job.wo_id] = job;
                            if (!appData.activeJobs[job.wo_id]) {
                                appData.activeJobs[job.wo_id] = {
                                    ...job,
                                    lastUpdate: Date.now(),
                                    accTime: job.accTime || 0
                                };
                            } else {
                                appData.activeJobs[job.wo_id].manpower = job.manpower;
                                appData.activeJobs[job.wo_id].req_data = job.req_data;
                            }
                        });
                    }
                    
                    Object.keys(appData.activeJobs).forEach(id => {
                        if (!cloudActiveMap[id]) delete appData.activeJobs[id];
                    });

                    saveStorage();
                    document.getElementById('cloud-status').textContent = "Connected âœ…";
                    document.getElementById('last-sync-time').textContent = new Date().toLocaleTimeString();
                    
                    if (uiState.screen === 'queue') renderQueue();
                    if (uiState.screen === 'admin') renderAdminList();
                } else {
                    throw new Error(data.message || "Unknown Error");
                }
            } catch (e) {
                console.error("Sync failed", e);
                document.getElementById('cloud-status').textContent = "Offline âš ï¸";
                if (!silent) {
                    // å¦‚æœä¸æ˜¯éœé»˜åŒæ­¥ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    alert("é€£ç·šéŒ¯èª¤: " + e.message);
                }
            } finally {
                if (!silent) document.getElementById('loading-mask').style.display = 'none';
            }
        }

        async function sendAction(payload, silent = false) {
            if(!silent) document.getElementById('loading-mask').style.display = 'flex';
            payload.token = TOKEN;
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                const text = await res.text(); // å…ˆè®€å–ç‚ºæ–‡å­—ï¼Œé¿å… JSON è§£æéŒ¯èª¤
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error("Server response not JSON: " + text.substring(0, 50));
                }

                if (data.success) {
                    await syncData(true);
                    return true;
                } else {
                    alert("Server Error: " + data.message);
                    return false;
                }
            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤: " + e.message);
                return false;
            } finally {
                if(!silent) document.getElementById('loading-mask').style.display = 'none';
            }
        }

        // --- Navigation ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(e => e.style.display = 'none');
            document.getElementById('screen-' + id).style.display = 'block';
            uiState.screen = id;
            
            const nav = document.querySelector('.nav-bar');
            if (id === 'login') nav.style.display = 'none'; else nav.style.display = 'flex';

            if (id === 'queue') {
                renderQueue();
                syncData(true); 
            }
            if (id === 'admin') renderAdminCreate();
        }

        function logout() { if(confirm("ç™»å‡º?")) { uiState.user = null; showScreen('login'); } }

        // --- Login ---
        function handleLoginInput(key) {
            if (key === 'C') uiState.pin = '';
            else if (key === 'OK') {
                if (uiState.pin === '9999') {
                    uiState.user = { name: 'Admin', role: 'admin' }; showScreen('admin');
                } else if (['1234', '5678'].includes(uiState.pin)) {
                    uiState.lang = (uiState.pin === '1234') ? 'vn' : 'zh';
                    uiState.user = { name: 'ä¸»ç®¡', pin: uiState.pin };
                    document.getElementById('user-name').textContent = uiState.user.name;
                    showScreen('queue');
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤"); uiState.pin = '';
                }
            } else {
                if (uiState.pin.length < 4) uiState.pin += key;
            }
            document.getElementById('pin-display').textContent = uiState.pin.length > 0 ? 'â— '.repeat(uiState.pin.length) : '_ _ _ _';
        }

        // --- Queue ---
        function renderQueue() {
            const list = document.getElementById('queue-list');
            const activeList = document.getElementById('active-list');
            const activeSec = document.getElementById('active-section');
            list.innerHTML = ''; activeList.innerHTML = '';
            
            let hasActive = false;
            Object.keys(appData.activeJobs).forEach(id => {
                const session = appData.activeJobs[id]; 
                const div = document.createElement('div');
                div.className = 'queue-item active-job';
                div.innerHTML = `<div class="q-info"><h3>${session.prod} - ${session.op}</h3><p>ğŸ‘¥ ${session.manpower} | ${session.master}</p></div><div style="font-size:1.5rem;">â–¶ï¸</div>`;
                div.onclick = () => openWorkingScreen(id);
                activeList.appendChild(div);
                hasActive = true;
            });
            activeSec.style.display = hasActive ? 'block' : 'none';

            if (appData.queue.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">ç„¡å¾…è¾¦å·¥å–®</div>';
            appData.queue.forEach(job => {
                const div = document.createElement('div');
                div.className = 'queue-item';
                div.innerHTML = `<div class="q-info"><h3>${uiState.lang==='vn'?job.prod_zh:job.prod_zh} - ${uiState.lang==='vn'?job.op_zh:job.op_zh}</h3><p>${job.master}</p></div>`;
                div.onclick = () => prepareJob(job.wo_id);
                list.appendChild(div);
            });
        }

        // --- Work Flow ---
        function prepareJob(id) {
            uiState.targetWoId = id;
            uiState.isAdjusting = false;
            uiState.tempVal = '0';
            document.querySelector('#screen-manpower h2').textContent = "ğŸ‘¥ é–‹å·¥è¨­å®š";
            document.getElementById('manpower-display').textContent = '0';
            showScreen('manpower');
        }

        function adjustManpower() {
            uiState.isAdjusting = true; uiState.tempVal = '0';
            document.querySelector('#screen-manpower h2').textContent = "ğŸ‘¥ èª¿æ•´äººæ•¸";
            document.getElementById('manpower-display').textContent = '0';
            showScreen('manpower');
        }

        function cancelManpower() {
            if (uiState.isAdjusting) showScreen('working'); else showScreen('queue');
        }

        function handleManpowerInput(key) {
            if (key === 'C') uiState.tempVal = '0';
            else if (key === 'OK') {
                const val = parseInt(uiState.tempVal);
                if (val > 0) {
                    if (uiState.isAdjusting) doUpdateManpower(val);
                    else doStartJob(val);
                } else alert("> 0");
            } else {
                uiState.tempVal = (uiState.tempVal === '0' ? key : uiState.tempVal + key);
            }
            document.getElementById('manpower-display').textContent = uiState.tempVal;
        }

        async function doStartJob(manpower) {
            const job = appData.queue.find(j => j.wo_id === uiState.targetWoId);
            const success = await sendAction({
                action: 'START_JOB',
                wo_id: uiState.targetWoId,
                master: job.master,
                prod: job.prod_zh,
                op: job.op_zh,
                pin: uiState.user.pin,
                manpower: manpower,
                start_time: new Date().toISOString(),
                req_data: job.req_data // å‚³é€è¨­å®š
            });
            if (success) openWorkingScreen(uiState.targetWoId);
        }

        async function doUpdateManpower(newManpower) {
            const job = appData.activeJobs[uiState.targetWoId];
            const now = Date.now();
            const start = new Date(job.lastUpdate || job.startISO); 
            const segmentMs = now - start;
            const segmentHours = (segmentMs / 3600000.0) * job.manpower;
            const newAcc = (job.accTime || 0) + segmentHours;

            const success = await sendAction({
                action: 'UPDATE_JOB',
                wo_id: uiState.targetWoId,
                manpower: newManpower,
                start_time: new Date(now).toISOString(), 
                acc_time: newAcc
            });
            
            if(success) openWorkingScreen(uiState.targetWoId);
        }

        function openWorkingScreen(id) {
            uiState.targetWoId = id;
            const job = appData.activeJobs[id];
            if (!job) { showScreen('queue'); return; }

            document.getElementById('work-prod').textContent = job.prod;
            document.getElementById('work-op').textContent = job.op;
            document.getElementById('work-id').textContent = id;
            document.getElementById('work-man').textContent = job.manpower;
            
            const reqEl = document.getElementById('work-req-data');
            reqEl.style.display = job.req_data ? 'block' : 'none';

            updateTimerDisplay();
            showScreen('working');
        }

        function updateTimerDisplay() {
            if (uiState.screen !== 'working') return;
            const job = appData.activeJobs[uiState.targetWoId];
            if (!job) return;

            const lastUpdate = new Date(job.startISO); 
            const now = new Date();
            const diff = Math.floor((now - lastUpdate) / 1000);
            
            const h = String(Math.floor(diff/3600)).padStart(2,'0');
            const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
            const s = String(diff%60).padStart(2,'0');
            document.getElementById('timer').textContent = `${h}:${m}:${s}`;
        }

        function backToQueue() { showScreen('queue'); }

        // ================= FINISH =================
        function endJob() {
            const session = appData.activeJobs[uiState.targetWoId];
            const job = appData.queue.find(j => j.wo_id === uiState.targetWoId);
            // fallback logic in case job is not in queue (already in active)
            // We need to trust session data for req_data
            const isSlicing = session.op.indexOf('åˆ†åˆ‡') >= 0;
            
            if (session.req_data || isSlicing) {
                uiState.finishStep = 1; 
            } else {
                uiState.finishStep = 99; 
            }

            uiState.finishCache = { reject:0, collar:0, tail:0, good:0 };
            uiState.tempVal = '0';
            updateFinishUI();
            showScreen('finish');
        }

        function updateFinishUI() {
            const step = uiState.finishStep;
            const instr = document.getElementById('finish-instruction');
            const display = document.getElementById('qty-display');
            const summary = document.getElementById('finish-summary');
            const keypad = document.getElementById('finish-keypad');

            summary.style.display = 'none'; keypad.style.display = 'grid'; display.style.display = 'block';

            if (step === 1) instr.textContent = I18N[uiState.lang].step_reject;
            else if (step === 2) instr.textContent = I18N[uiState.lang].step_collar;
            else if (step === 3) instr.textContent = I18N[uiState.lang].step_tail;
            else if (step === 4) instr.textContent = I18N[uiState.lang].step_total;
            else if (step === 99) {
                instr.textContent = I18N[uiState.lang].summary;
                display.style.display = 'none';
                summary.style.display = 'block';
                summary.innerHTML = `
                    <div style="text-align:center; padding:20px;">
                        <div style="font-size:1.2rem; color:var(--success); margin-bottom:10px;">ç¢ºèªçµæŸå·¥å–®ï¼Ÿ</div>
                        <div style="color:#888;">${uiState.finishCache.good > 0 ? '(åŒ…å«ç”Ÿç”¢æ•¸æ“š)' : '(åƒ…å·¥æ™‚)'}</div>
                    </div>
                    <div style="text-align:center; margin-top:10px; color:var(--accent);">æŒ‰ OK é€å‡º</div>
                `;
            }
            if (step !== 99) display.textContent = uiState.tempVal;
        }

        function handleFinishInput(key) {
            if (key === 'C') { uiState.tempVal = '0'; updateFinishUI(); return; }
            if (key === 'OK') {
                const val = parseFloat(uiState.tempVal);
                const step = uiState.finishStep;
                if (step === 99) { doFinishJob(); return; }

                if (step === 1) uiState.finishCache.reject = val;
                else if (step === 2) uiState.finishCache.collar = val;
                else if (step === 3) uiState.finishCache.tail = val;
                else if (step === 4) uiState.finishCache.good = val;

                uiState.tempVal = '0';
                // Logic: if slicing (4 steps) else if req_data (1 step + total)
                // Simplified: Always follow sequence 1->2->3->4->99 for now.
                // If not slicing, user enters 0 for collar/tail
                if (step === 1) uiState.finishStep = 2;
                else if (step === 2) uiState.finishStep = 3;
                else if (step === 3) uiState.finishStep = 4;
                else if (step === 4) uiState.finishStep = 99;
                updateFinishUI();
                return;
            }
            uiState.tempVal = (uiState.tempVal === '0' ? key : uiState.tempVal + key);
            updateFinishUI();
        }

        async function doFinishJob() {
            const job = appData.activeJobs[uiState.targetWoId];
            const now = new Date();
            const start = new Date(job.startISO); 
            const segmentMs = now - start;
            const segmentHours = (segmentMs / 3600000.0) * job.manpower;
            const finalTotalHours = (job.accTime || 0) + segmentHours;

            await sendAction({
                action: 'FINISH_JOB',
                wo_id: uiState.targetWoId,
                op: job.op,
                pin: job.pin,
                manpower: job.manpower,
                total_hours: finalTotalHours.toFixed(3),
                qty_good: uiState.finishCache.good,
                qty_reject: uiState.finishCache.reject,
                collar: uiState.finishCache.collar,
                tail: uiState.finishCache.tail
            });
            
            delete appData.activeJobs[uiState.targetWoId];
            saveStorage();
            showScreen('queue');
        }

        // ================= ADMIN =================
        function renderAdminCreate() {
            const container = document.getElementById('admin-sub-items');
            if (!container.innerHTML) addAdminRow();
            updateTemplateDropdown();
            renderAdminList();
        }
        function updateTemplateDropdown() {
            const sel = document.getElementById('admin-template');
            sel.innerHTML = '<option value="">-- é¸æ“‡è¼‰å…¥ --</option>';
            appData.templates.forEach((t, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }
        function addAdminRow(prod='', op='') {
            const container = document.getElementById('admin-sub-items');
            const div = document.createElement('div');
            div.className = 'sub-item-row';
            div.innerHTML = `<input class="admin-input prod" placeholder="ç”¢å“" value="${prod}"><input class="admin-input op" placeholder="å·¥åº" value="${op}"><button class="btn-row-delete" onclick="this.parentElement.remove()">X</button>`;
            container.appendChild(div);
        }
        function saveTemplate() {
            const mwo = document.getElementById('admin-mwo').value;
            if(!mwo) return alert("éœ€è¼¸å…¥ç¸½å·¥å–®è™Ÿåšç‚ºç¯„æœ¬å");
            const items = [];
            document.querySelectorAll('#admin-sub-items .sub-item-row').forEach(row => {
                const prod = row.querySelector('.prod').value; const op = row.querySelector('.op').value;
                if(prod && op) items.push({prod, op});
            });
            if(items.length === 0) return alert("è‡³å°‘éœ€ä¸€é …å·¥åº");
            const existIdx = appData.templates.findIndex(t => t.name === mwo);
            if(existIdx >= 0) {
                if(!confirm(`ç¯„æœ¬ ${mwo} å·²å­˜åœ¨ï¼Œè¦†è“‹ï¼Ÿ`)) return;
                appData.templates[existIdx] = { name: mwo, items: items };
            } else { appData.templates.push({ name: mwo, items: items }); }
            saveStorage(); updateTemplateDropdown(); alert("ç¯„æœ¬å·²å„²å­˜");
        }
        function loadTemplate() {
            const idx = document.getElementById('admin-template').value;
            if(idx === "") return;
            const tmpl = appData.templates[idx];
            document.getElementById('admin-mwo').value = tmpl.name;
            document.getElementById('admin-sub-items').innerHTML = '';
            tmpl.items.forEach(i => addAdminRow(i.prod, i.op));
        }
        function deleteTemplate() {
            const idx = document.getElementById('admin-template').value;
            if(idx === "") return alert("è«‹é¸æ“‡è¦åˆªé™¤çš„ç¯„æœ¬");
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ")) {
                appData.templates.splice(idx, 1); saveStorage(); updateTemplateDropdown();
                document.getElementById('admin-template').value = "";
            }
        }
        function publishWorkOrders() {
            const mwo = document.getElementById('admin-mwo').value;
            const weight = document.getElementById('admin-weight').value;
            const reqData = document.getElementById('admin-req-data').checked;
            if(!mwo) return alert("ç¼ºå–®è™Ÿ");
            const jobs = [];
            let count = 0;
            document.querySelectorAll('#admin-sub-items .sub-item-row').forEach(row => {
                const prod = row.querySelector('.prod').value; const op = row.querySelector('.op').value;
                if(prod && op) {
                    count++;
                    jobs.push({
                        wo_id: `${mwo}-Q${Date.now()}-${count}`,
                        master: mwo, prod_zh: prod, op_zh: op, rank: count, st: 1.0,
                        total_weight: weight, req_data: reqData
                    });
                }
            });
            
            sendAction({ action: 'ADD_JOBS', jobs: jobs });
            alert(`å·²é€å‡ºç™¼å¸ƒè«‹æ±‚ (${count}ç­†)`);
            
            document.getElementById('admin-mwo').value = '';
            document.getElementById('admin-sub-items').innerHTML = '';
            addAdminRow();
        }
        function renderAdminList() {
            const div = document.getElementById('admin-list');
            div.innerHTML = appData.queue.map(q => `<div style="border-bottom:1px solid #333; padding:5px;">${q.master} - ${q.prod_zh} - ${q.op_zh}</div>`).join('');
        }
        function adminReset() { if(confirm("é‡ç½®è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        function renderSummaryTable() {
            const container = document.getElementById('summary-table-container');
            const groupBy = document.getElementById('report-group-by').value; 
            container.innerHTML = '';
            if (!appData.history || appData.history.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center;">å°šç„¡æ­·å²è³‡æ–™</div>'; return;
            }
            const summary = {};
            appData.history.forEach(log => {
                let key = (groupBy === 'by-master') ? (log.wo_id.split('-')[0] || 'æœªçŸ¥å·¥å–®') : (log.operation_name || 'æœªçŸ¥å·¥åº'); 
                if (!summary[key]) { summary[key] = { count: 0, totalHours: 0 }; }
                summary[key].count++;
                summary[key].totalHours += parseFloat(log.total_hours || 0);
            });
            let html = `<table class="report-table"><thead><tr><th>${groupBy === 'by-master' ? 'ç¸½å·¥å–®è™Ÿ' : 'å·¥åºåç¨±'}</th><th>æ¬¡æ•¸</th><th style="text-align:right;">ç¸½äººæ™‚ (Hr)</th></tr></thead><tbody>`;
            let grandTotal = 0;
            for (const [key, data] of Object.entries(summary)) {
                html += `<tr><td>${key}</td><td>${data.count}</td><td style="text-align:right; color:#4caf50;">${data.totalHours.toFixed(2)}</td></tr>`;
                grandTotal += data.totalHours;
            }
            html += `<tr style="border-top: 2px solid #555;"><td colspan="2" style="text-align:right; font-weight:bold;">ç¸½è¨ˆ:</td><td style="text-align:right; font-weight:bold; color:#00bcd4; font-size:1.1rem;">${grandTotal.toFixed(2)}</td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        function showAdminTab(tab) {
            if(tab === 'create') {
                document.getElementById('admin-tab-create').style.display = 'block';
                document.getElementById('admin-tab-history').style.display = 'none';
            } else {
                document.getElementById('admin-tab-create').style.display = 'none';
                document.getElementById('admin-tab-history').style.display = 'block';
                const histList = document.getElementById('history-list');
                histList.innerHTML = appData.history.slice().reverse().map(h => {
                    return `<div style="border-bottom:1px solid #333; padding:5px;">${h.wo_id} - ${h.operation_name} (${h.total_hours}hr)</div>`;
                }).join('');
                renderSummaryTable();
            }
            document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function renderATMKeypad(elementId, callback) {
            const el = document.getElementById(elementId);
            el.innerHTML = ''; el.className = 'circle-keypad';
            ['1','2','3','4','5','6','7','8','9','C','0','OK'].forEach(k => {
                const btn = document.createElement('div');
                btn.textContent = k;
                if(k==='C') btn.className='circle-btn clear'; else if(k==='OK') btn.className='circle-btn ok'; else btn.className = 'circle-btn';
                btn.addEventListener('click', (e) => { e.preventDefault(); callback(k); });
                el.appendChild(btn);
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>