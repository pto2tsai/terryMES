<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MES Lite 現場工時系統</title>
    <style>
        /* ---------------------------------- */
        /* CSS: V2.5 現場主管體驗優化版 */
        /* ---------------------------------- */
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            
            --primary: #2196f3; /* 藍色：一般操作 */
            --accent: #00bcd4;  /* 青色：強調 */
            --success: #4caf50; /* 綠色：進行中/確認 */
            --warning: #ff9800; /* 橘色：結束/暫停 */
            --danger: #f44336;  /* 紅色：錯誤/刪除 */
            
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 頂部導航 (固定) --- */
        .nav-bar {
            height: var(--nav-height);
            background-color: #000000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .nav-brand { font-size: 1.2rem; font-weight: bold; color: var(--accent); letter-spacing: 1px; }
        .nav-user { font-size: 0.9rem; color: var(--text-sub); text-align: right; }
        .nav-btn {
            background: #333; border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.2s;
        }
        .nav-btn:active { background: #555; }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- 主容器 (可捲動) --- */
        .container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 20px;
            max-width: 800px; /* 限制最大寬度，大螢幕置中 */
            margin: 0 auto;
            width: 100%;
        }

        /* --- 畫面切換 --- */
        .screen { display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 卡片樣式 --- */
        .card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 1px solid #333;
        }

        /* --- 登入畫面 --- */
        .login-box {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 80vh;
        }
        .pin-dots {
            font-size: 3rem; letter-spacing: 10px; color: var(--accent);
            margin: 20px 0; min-height: 60px;
        }

        /* --- 排程列表 (List View) --- */
        .section-title {
            font-size: 1rem; color: var(--text-sub); margin: 10px 0 5px 5px; text-transform: uppercase; letter-spacing: 1px;
        }
        
        /* 進行中任務卡片 (置頂) */
        .active-job-card {
            background: linear-gradient(135deg, #1b5e20 0%, #0d3310 100%);
            border: 2px solid var(--success);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border { 0% { border-color: #4caf50; } 50% { border-color: #81c784; } 100% { border-color: #4caf50; } }

        .job-item {
            display: flex; align-items: center;
            padding: 15px;
            background-color: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid var(--primary); /* 預設藍色 */
            cursor: pointer;
            transition: transform 0.1s;
        }
        .job-item:active { transform: scale(0.98); background-color: #2a2a2a; }
        
        .job-left { flex: 0 0 50px; font-size: 1.4rem; font-weight: bold; color: var(--text-sub); text-align: center; }
        .job-main { flex: 1; padding: 0 15px; }
        .job-title { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 4px; }
        .job-sub { font-size: 0.9rem; color: #aaa; }
        .job-meta { font-size: 0.8rem; color: #666; margin-top: 4px; }
        .job-status { font-size: 1.5rem; }

        /* --- 計時畫面 (Working) --- */
        .timer-display {
            font-size: 4.5rem; font-weight: bold; color: var(--accent);
            text-align: center; margin: 20px 0; font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(0, 188, 212, 0.3);
        }
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .info-box {
            background: #252525; padding: 15px; border-radius: 8px; text-align: center;
        }
        .info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .info-value { font-size: 1.4rem; font-weight: bold; color: #fff; }

        /* --- 鍵盤 (Keypad) --- */
        .keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 400px; margin: 0 auto;
        }
        .key-btn {
            background-color: #333; color: white;
            font-size: 1.6rem; font-weight: bold;
            padding: 20px 0; border-radius: 8px; border: none;
            box-shadow: 0 4px 0 #111; cursor: pointer;
        }
        .key-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #111; }
        .key-confirm { background-color: var(--success); color: black; box-shadow: 0 4px 0 #2e7d32; }
        .key-clear { background-color: var(--danger); color: white; box-shadow: 0 4px 0 #c62828; }

        /* --- 底部操作列 (Bottom Actions) --- */
        .bottom-actions {
            margin-top: auto; /* 推到底部 */
            display: grid; grid-template-columns: 1fr 2fr; gap: 10px;
            padding-top: 20px;
        }
        .action-btn {
            padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 8px; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary { background-color: #424242; }
        .btn-primary { background-color: var(--warning); color: black; } /* 結束通常用醒目顏色 */
        .btn-blue { background-color: var(--primary); }

        /* --- 數量輸入/確認頁 --- */
        .input-instruction {
            font-size: 1.5rem; text-align: center; margin-bottom: 20px; color: var(--accent); font-weight: bold;
        }
        .input-value-display {
            background: #000; color: var(--success); font-size: 3rem; text-align: center;
            padding: 10px; border: 2px solid #333; border-radius: 8px; margin-bottom: 20px;
        }
        .summary-list {
            text-align: left; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px;
        }
        .summary-item {
            display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 10px 0;
        }
        .summary-item:last-child { border-bottom: none; }

        /* --- 生管後台 --- */
        .admin-header { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .admin-tab { 
            background: transparent; color: #888; border: 1px solid #555; padding: 8px 16px; border-radius: 20px; white-space: nowrap; 
        }
        .admin-tab.active { background: var(--primary); color: black; border-color: var(--primary); font-weight: bold; }
        
        /* Loading & Alert */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader {
            width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 電腦版優化 */
        @media (min-width: 768px) {
            .keypad { max-width: 500px; gap: 15px; }
            .key-btn { font-size: 2rem; padding: 25px 0; }
            .job-item { padding: 20px; }
            .job-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- 頂部導航 -->
    <div class="nav-bar">
        <button class="nav-btn" onclick="handleNavBack()" id="nav-back-btn" style="visibility: hidden;">
            <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>
        <div class="nav-brand">MES Lite <span style="font-size:0.7rem; color:#555;">V2.5</span></div>
        <button class="nav-btn" onclick="logout()" id="nav-logout-btn" style="visibility: hidden;">
            <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        </button>
    </div>

    <div class="container">
        
        <!-- 1. 登入畫面 -->
        <div id="screen-login" class="screen">
            <div class="login-box">
                <div style="margin-bottom: 20px; color: var(--text-sub);">請輸入識別碼 / ENTER PIN</div>
                <div id="pin-display" class="pin-dots">_ _ _ _</div>
                <div id="login-msg" style="color: var(--danger); height: 20px; margin-bottom: 10px;"></div>
                <div class="keypad" id="login-keypad">
                    <!-- JS 生成 -->
                </div>
                <div style="margin-top: 30px; font-size: 0.8rem; color: #444;">
                    GAS Status: <span id="gas-status" style="color: var(--success);">Ready</span>
                </div>
            </div>
        </div>

        <!-- 2. 待辦排程 (Dashboard) -->
        <div id="screen-queue" class="screen">
            <div class="user-welcome" style="margin-bottom: 15px; color: var(--accent); font-weight: bold;">
                👋 <span id="user-name-display">User</span>
            </div>
            
            <div id="active-jobs-section" style="display: none;">
                <div class="section-title">🔥 進行中 (RUNNING)</div>
                <div id="active-jobs-list"></div>
            </div>

            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span>📋 待辦清單 (QUEUE)</span>
                <button onclick="forceReload()" style="background:none; border:1px solid #555; color:#888; border-radius:4px; padding:2px 8px; font-size:0.8rem;">↻ 刷新</button>
            </div>
            
            <!-- 過濾器 -->
            <select id="queue-filter" onchange="renderQueue()" style="width: 100%; padding: 12px; background: #222; color: white; border: 1px solid #444; border-radius: 8px; margin-bottom: 10px; font-size: 1rem;">
                <option value="ALL">全部顯示 (Show All)</option>
            </select>

            <div id="queue-list">
                <!-- JS 生成 -->
            </div>
        </div>

        <!-- 3. 人數輸入 -->
        <div id="screen-manpower" class="screen">
            <div class="input-instruction">
                <div>👥 本次投入人數?</div>
                <div style="font-size: 1rem; color: #888;">How many workers?</div>
            </div>
            <div id="manpower-display" class="input-value-display">0</div>
            <div class="keypad" id="manpower-keypad"></div>
        </div>

        <!-- 4. 計時畫面 (Working) -->
        <div id="screen-working" class="screen" style="display: flex; flex-direction: column;">
            <div class="card active-job-card" style="text-align: center;">
                <div style="font-size: 0.9rem; color: #cfd8dc; margin-bottom: 5px;">正在執行 (Running)</div>
                <div id="working-prod" style="font-size: 1.5rem; font-weight: bold;">產品名稱</div>
                <div id="working-op" style="font-size: 1.1rem; color: #a5d6a7;">工序名稱</div>
            </div>

            <div class="timer-display" id="working-timer">00:00:00</div>

            <div class="info-grid">
                <div class="info-box">
                    <div class="info-label">工單號</div>
                    <div class="info-value" id="working-woid" style="font-size: 1rem;">-</div>
                </div>
                <div class="info-box">
                    <div class="info-label">目前人數</div>
                    <div class="info-value" id="working-manpower">-</div>
                </div>
            </div>

            <div class="bottom-actions">
                <button class="action-btn btn-secondary" onclick="backToQueue()">
                    <span>⬅ 暫離 (Back)</span>
                </button>
                <button class="action-btn btn-primary" onclick="endJob()">
                    <span>🏁 完成 (Finish)</span>
                </button>
            </div>
            
            <button onclick="adjustManpower()" style="width: 100%; background: none; border: 1px dashed #555; color: #888; padding: 10px; margin-top: 15px; border-radius: 8px;">
                👥 調整人數 (Change Manpower)
            </button>
        </div>

        <!-- 5. 數量輸入/確認 -->
        <div id="screen-finish" class="screen">
            <div class="input-instruction" id="finish-instruction">
                <!-- JS 動態填入：輸入良品/不良品/確認 -->
            </div>
            
            <div id="qty-display" class="input-value-display">0</div>
            
            <div id="finish-summary" class="summary-list" style="display: none;">
                <!-- 總結確認清單 -->
            </div>

            <div class="keypad" id="finish-keypad"></div>
        </div>

        <!-- 6. 生管後台 (Admin) -->
        <div id="screen-admin" class="screen">
            <h2>🛠️ 生管控制台</h2>
            <div class="admin-header">
                <button class="admin-tab active" onclick="showAdminTab('create')">建立工單</button>
                <button class="admin-tab" onclick="showAdminTab('history')">匯出報表</button>
            </div>

            <!-- 建立工單 Tab -->
            <div id="admin-tab-create">
                <div class="card">
                    <label style="color:#aaa; font-size:0.8rem;">總工單 ID (Master WO)</label>
                    <input type="text" id="admin-mwo" placeholder="MWO-2025..." style="width:100%; padding:10px; margin:5px 0 15px; background:#333; border:1px solid #555; color:white; border-radius:4px;">
                    
                    <label style="color:#aaa; font-size:0.8rem;">快速範本 (Templates)</label>
                    <select id="admin-template" onchange="loadTemplate()" style="width:100%; padding:10px; background:#333; border:1px solid #555; color:white; border-radius:4px; margin-bottom: 10px;">
                        <option value="">-- 選擇載入 --</option>
                    </select>

                    <div id="admin-sub-items">
                        <!-- JS 動態生成輸入框 -->
                    </div>
                    
                    <button onclick="addAdminRow()" style="width:100%; padding:10px; background:#444; border:1px dashed #666; color:#ccc; margin-top:10px;">+ 新增項目</button>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                    <button class="action-btn btn-secondary" onclick="saveTemplate()">儲存範本</button>
                    <button class="action-btn btn-blue" onclick="publishWorkOrders()">🚀 發布工單</button>
                </div>
                <button onclick="resetData()" style="width:100%; margin-top:20px; padding:10px; background:#300; color:#f88; border:none; border-radius:4px;">⚠️ 重置系統資料</button>
            </div>

            <!-- 匯出報表 Tab -->
            <div id="admin-tab-history" style="display:none;">
                <div id="history-list" style="font-size:0.8rem;"></div>
                <button class="action-btn btn-blue" style="width:100%; margin-top:15px;" onclick="exportReport()">計算勾選項目</button>
            </div>
        </div>

    </div>

    <!-- Loading Mask -->
    <div id="loading-mask">
        <div class="loader"></div>
        <div style="color: white; margin-top: 15px; font-size: 1.2rem;">處理中...</div>
    </div>

    <script>
        // ================= CONFIG =================
        // 🚨 請務必替換為您的 GAS Webhook URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyP9sYjwQ3pM7MMkrbiWTaUKmIeUcWhtWzPEqyhBlpHds7NfK6I49TTbEg4DWGsutBytA/exec";
        const SECURITY_TOKEN = "MES_LITE_2025";
        
        // ================= STATE =================
        let appData = {
            queue: [],          // 待辦工單
            activeJobs: {},     // 進行中: { wo_id: { startTime, manpower, ... } }
            history: [],        // 已完成紀錄
            templates: []       // 生管範本
        };

        let uiState = {
            screen: 'login',
            pin: '',
            user: null,
            lang: 'zh',         // 'zh' | 'vn'
            targetWoId: null,   // 當前操作的工單ID
            tempManpower: 0,    // 暫存人數
            tempQty: '',        // 暫存輸入數字
            finishStep: 0,      // 0:None, 1:Reject, 2:Collar, 3:Tail, 4:Total, 99:Confirm
            finishCache: {}     // 暫存結算數據
        };
        
        let timerInterval = null;

        // 預設工單 (若無資料時顯示)
        const DEMO_QUEUE = [
            { wo_id: 'TEST-Q1', master: 'DEMO', prod_zh: '鮭魚分切', prod_vn: 'Cá hồi', op_zh: '分切/分料', op_vn: 'Cắt lát', rank: 1, st: 1.0 },
            { wo_id: 'TEST-Q2', master: 'DEMO', prod_zh: '中段厚切', prod_vn: 'Lát dày', op_zh: '真空包裝', op_vn: 'Hút chân không', rank: 2, st: 0.5 }
        ];

        const I18N = {
            zh: { welcome: '你好', running: '進行中', waiting: '待辦', finish: '完成', back: '暫離', confirm: '確認送出', step_reject: '❌ 輸入損耗 (KG)', step_collar: '下巴重量 (KG)', step_tail: '尾段重量 (KG)', step_total: '✅ 良品/總重 (KG)', summary: '📋 請確認資料' },
            vn: { welcome: 'Xin chào', running: 'Đang chạy', waiting: 'Chờ', finish: 'Hoàn tất', back: 'Quay lại', confirm: 'Xác nhận', step_reject: '❌ Hỏng (KG)', step_collar: 'Cằm (KG)', step_tail: 'Đuôi (KG)', step_total: '✅ Tổng (KG)', summary: '📋 Xác nhận' }
        };

        // ================= INIT & STORAGE =================
        function init() {
            loadStorage();
            // 如果是第一次，載入 Demo
            if (appData.queue.length === 0 && Object.keys(appData.activeJobs).length === 0) {
                appData.queue = JSON.parse(JSON.stringify(DEMO_QUEUE));
                saveStorage();
            }
            
            // 檢查 URL 是否設定
            if (GAS_URL.includes("YOUR_GAS")) alert("⚠️ 請先設定 GAS Webhook URL！");
            else document.getElementById('gas-status').textContent = "Connected";

            renderKeypad('login-keypad', handleLoginInput);
            showScreen('login');
            
            // 自動刷新
            setInterval(() => {
                if(uiState.screen === 'working') updateTimerDisplay();
            }, 1000);
        }

        function loadStorage() {
            const raw = localStorage.getItem('mes_v2_data');
            if (raw) {
                try { appData = JSON.parse(raw); } catch(e) { console.error("Data corrupted", e); }
            }
        }

        function saveStorage() {
            localStorage.setItem('mes_v2_data', JSON.stringify(appData));
        }

        // ================= NAVIGATION & SCREEN =================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById('screen-' + id).style.display = 'block';
            uiState.screen = id;

            // 導航按鈕控制
            const backBtn = document.getElementById('nav-back-btn');
            const logoutBtn = document.getElementById('nav-logout-btn');
            
            if (id === 'login') {
                backBtn.style.visibility = 'hidden';
                logoutBtn.style.visibility = 'hidden';
            } else {
                logoutBtn.style.visibility = 'visible';
                // 如果在子頁面顯示返回
                backBtn.style.visibility = (id === 'queue' || id === 'admin') ? 'hidden' : 'visible';
            }

            // 畫面特定初始化
            if (id === 'queue') renderQueue();
            if (id === 'admin') renderAdminCreate();
        }

        function handleNavBack() {
            if (uiState.screen === 'working' || uiState.screen === 'manpower' || uiState.screen === 'finish') {
                showScreen('queue');
            }
        }

        function logout() {
            if(confirm("確定登出？")) {
                uiState.user = null;
                uiState.pin = '';
                document.getElementById('pin-display').textContent = '_ _ _ _';
                showScreen('login');
            }
        }

        // ================= LOGIN LOGIC =================
        function handleLoginInput(key) {
            if (key === 'C') {
                uiState.pin = '';
            } else if (key === 'OK') {
                if (uiState.pin === '9999') {
                    // 生管登入
                    uiState.user = { name: 'Admin', role: 'admin' };
                    showScreen('admin');
                } else if (uiState.pin === '1234' || uiState.pin === '5678') {
                    // 現場主管登入
                    uiState.lang = (uiState.pin === '1234') ? 'vn' : 'zh';
                    uiState.user = { name: (uiState.lang==='vn'?'Nguyễn':'陳主管'), role: 'supervisor' };
                    document.getElementById('user-name-display').textContent = `${I18N[uiState.lang].welcome}, ${uiState.user.name}`;
                    showScreen('queue');
                } else {
                    document.getElementById('login-msg').textContent = "PIN Error / 密碼錯誤";
                    uiState.pin = '';
                }
            } else {
                if (uiState.pin.length < 4) uiState.pin += key;
            }
            // Update UI
            const dots = uiState.pin.length > 0 ? '● '.repeat(uiState.pin.length) : '_ _ _ _';
            document.getElementById('pin-display').textContent = dots;
        }

        // ================= QUEUE LOGIC =================
        function renderQueue() {
            const activeList = document.getElementById('active-jobs-list');
            const queueList = document.getElementById('queue-list');
            const activeSection = document.getElementById('active-jobs-section');
            const filter = document.getElementById('queue-filter');

            activeList.innerHTML = '';
            queueList.innerHTML = '';

            // 1. 渲染進行中任務 (Active Jobs)
            const activeIds = Object.keys(appData.activeJobs);
            if (activeIds.length > 0) {
                activeSection.style.display = 'block';
                activeIds.forEach(woId => {
                    const job = appData.queue.find(q => q.wo_id === woId) || { prod_zh:'未知', op_zh:'未知' }; // Fallback
                    const session = appData.activeJobs[woId];
                    const card = createJobCard(job, true, session);
                    activeList.appendChild(card);
                });
            } else {
                activeSection.style.display = 'none';
            }

            // 2. 更新過濾器選項
            const masters = [...new Set(appData.queue.map(j => j.master))];
            const currentFilter = filter.value;
            filter.innerHTML = `<option value="ALL">全部顯示 (Show All)</option>`;
            masters.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                filter.appendChild(opt);
            });
            filter.value = currentFilter; // Restore selection

            // 3. 渲染待辦清單
            const filtered = appData.queue.filter(j => !appData.activeJobs[j.wo_id] && (filter.value === 'ALL' || j.master === filter.value));
            
            if (filtered.length === 0) {
                queueList.innerHTML = `<div style="text-align:center; color:#555; padding:20px;">📭 無待辦工單 (No Jobs)</div>`;
            } else {
                filtered.forEach(job => {
                    queueList.appendChild(createJobCard(job, false));
                });
            }
        }

        function createJobCard(job, isActive, session) {
            const div = document.createElement('div');
            div.className = isActive ? 'job-item active-job-card' : 'job-item';
            
            const prodName = uiState.lang === 'vn' ? job.prod_vn : job.prod_zh;
            const opName = uiState.lang === 'vn' ? job.op_vn : job.op_zh;
            
            // 如果是進行中，顯示計時
            let statusHtml = '';
            if (isActive) {
                statusHtml = `<div class="job-status">▶️</div>`; // Play icon
                div.onclick = () => openWorkingScreen(job.wo_id);
            } else {
                div.onclick = () => startJobFlow(job.wo_id);
            }

            div.innerHTML = `
                <div class="job-left">Q${job.rank}</div>
                <div class="job-main">
                    <div class="job-title">${prodName}</div>
                    <div class="job-sub">${opName}</div>
                    <div class="job-meta">${job.master} ${isActive ? '| 👥 '+session.manpower : ''}</div>
                </div>
                ${statusHtml}
            `;
            return div;
        }

        // ================= JOB FLOW =================
        function startJobFlow(woId) {
            uiState.targetWoId = woId;
            // Reset Input
            uiState.tempQty = '0';
            renderKeypad('manpower-keypad', handleManpowerInput);
            document.getElementById('manpower-display').textContent = '0';
            showScreen('manpower');
        }

        function handleManpowerInput(key) {
            if (key === 'C') uiState.tempQty = '0';
            else if (key === 'OK') {
                const val = parseInt(uiState.tempQty);
                if (val > 0) {
                    // 開始計時
                    startSession(uiState.targetWoId, val);
                } else {
                    alert("0?");
                }
            } else {
                uiState.tempQty = (uiState.tempQty === '0' ? key : uiState.tempQty + key);
            }
            document.getElementById('manpower-display').textContent = uiState.tempQty;
        }

        function startSession(woId, manpower) {
            const now = Date.now();
            // 記錄 Session
            appData.activeJobs[woId] = {
                startISO: new Date().toISOString(), // 傳給後端用
                lastUpdate: now,                    // 前端計算分段用
                accTime: 0,                         // 累積工時 (毫秒)
                manpower: manpower
            };
            saveStorage();
            openWorkingScreen(woId);
        }

        function openWorkingScreen(woId) {
            uiState.targetWoId = woId;
            const job = appData.queue.find(j => j.wo_id === woId);
            const session = appData.activeJobs[woId];
            
            if (!job || !session) { alert("Error loading job"); showScreen('queue'); return; }

            // UI Update
            document.getElementById('working-prod').textContent = uiState.lang==='vn' ? job.prod_vn : job.prod_zh;
            document.getElementById('working-op').textContent = uiState.lang==='vn' ? job.op_vn : job.op_zh;
            document.getElementById('working-woid').textContent = woId;
            document.getElementById('working-manpower').textContent = session.manpower;
            
            updateTimerDisplay();
            showScreen('working');
        }

        function updateTimerDisplay() {
            if (uiState.screen !== 'working' || !uiState.targetWoId) return;
            const session = appData.activeJobs[uiState.targetWoId];
            if (!session) return;

            // 簡單顯示當前這一段的時間，或總時間 (這裡簡化為顯示本次登入後的持續時間，實際工時後端會算)
            const diff = Date.now() - session.lastUpdate; 
            // 格式化 HH:MM:SS
            const sec = Math.floor(diff / 1000);
            const h = Math.floor(sec / 3600).toString().padStart(2,'0');
            const m = Math.floor((sec % 3600) / 60).toString().padStart(2,'0');
            const s = (sec % 60).toString().padStart(2,'0');
            document.getElementById('working-timer').textContent = `${h}:${m}:${s}`;
        }

        function backToQueue() {
            showScreen('queue');
        }

        function adjustManpower() {
            // 簡單實作：直接跳回人數輸入，輸入後更新 session
            const current = appData.activeJobs[uiState.targetWoId].manpower;
            const newVal = prompt(`目前 ${current} 人。請輸入新的人數：`, current);
            if (newVal && parseInt(newVal) > 0) {
                // 結算舊工時
                const now = Date.now();
                const session = appData.activeJobs[uiState.targetWoId];
                const duration = now - session.lastUpdate;
                session.accTime += duration * session.manpower; // 累積 (時間x人)
                
                // 更新狀態
                session.lastUpdate = now;
                session.manpower = parseInt(newVal);
                saveStorage();
                
                // 刷新 UI
                document.getElementById('working-manpower').textContent = session.manpower;
            }
        }

        // ================= FINISH LOGIC =================
        function endJob() {
            // 判斷是否為分切工序 (需要四步輸入)
            const job = appData.queue.find(j => j.wo_id === uiState.targetWoId);
            const isSlicing = (job.op_zh.indexOf('分切') >= 0);

            uiState.finishStep = isSlicing ? 1 : 4; // 1=Reject, 4=Total(Good)
            uiState.finishCache = { reject:0, collar:0, tail:0, good:0 };
            uiState.tempQty = '0';
            
            updateFinishUI();
            renderKeypad('finish-keypad', handleFinishInput);
            showScreen('finish');
        }

        function updateFinishUI() {
            const step = uiState.finishStep;
            const instr = document.getElementById('finish-instruction');
            const display = document.getElementById('qty-display');
            const summary = document.getElementById('finish-summary');
            const keypad = document.getElementById('finish-keypad');

            summary.style.display = 'none';
            keypad.style.display = 'grid';
            display.style.display = 'block';

            if (step === 1) instr.textContent = I18N[uiState.lang].step_reject;
            else if (step === 2) instr.textContent = I18N[uiState.lang].step_collar;
            else if (step === 3) instr.textContent = I18N[uiState.lang].step_tail;
            else if (step === 4) instr.textContent = I18N[uiState.lang].step_total;
            else if (step === 99) {
                instr.textContent = I18N[uiState.lang].summary;
                display.style.display = 'none';
                summary.style.display = 'block';
                // Build Summary HTML
                summary.innerHTML = `
                    <div class="summary-item"><span>良品 (Good)</span><span>${uiState.finishCache.good}</span></div>
                    <div class="summary-item"><span>損耗 (Reject)</span><span>${uiState.finishCache.reject}</span></div>
                    ${uiState.finishCache.collar > 0 ? `<div class="summary-item"><span>下巴 (Collar)</span><span>${uiState.finishCache.collar}</span></div>` : ''}
                    ${uiState.finishCache.tail > 0 ? `<div class="summary-item"><span>尾段 (Tail)</span><span>${uiState.finishCache.tail}</span></div>` : ''}
                    <div style="text-align:center; margin-top:10px; color:var(--success);">Press OK to Confirm</div>
                `;
            }
            
            if (step !== 99) display.textContent = uiState.tempQty;
        }

        function handleFinishInput(key) {
            if (key === 'C') {
                uiState.tempQty = '0';
                updateFinishUI();
                return;
            }
            
            if (key === 'OK') {
                const val = parseFloat(uiState.tempQty);
                const step = uiState.finishStep;

                if (step === 99) { submitData(); return; } // 最終送出

                // 儲存數值
                if (step === 1) uiState.finishCache.reject = val;
                else if (step === 2) uiState.finishCache.collar = val;
                else if (step === 3) uiState.finishCache.tail = val;
                else if (step === 4) uiState.finishCache.good = val;

                // 下一步
                uiState.tempQty = '0';
                if (step === 1) uiState.finishStep = 2;
                else if (step === 2) uiState.finishStep = 3;
                else if (step === 3) uiState.finishStep = 4;
                else if (step === 4) uiState.finishStep = 99; // Go to confirm
                
                updateFinishUI();
                return;
            }

            // 數字輸入
            uiState.tempQty = (uiState.tempQty === '0' ? key : uiState.tempQty + key);
            updateFinishUI();
        }

        async function submitData() {
            // 顯示 Loading
            document.getElementById('loading-mask').style.display = 'flex';
            
            const session = appData.activeJobs[uiState.targetWoId];
            const job = appData.queue.find(j => j.wo_id === uiState.targetWoId);
            
            // 計算最終工時
            const now = Date.now();
            const lastDuration = now - session.lastUpdate;
            const totalMs = session.accTime + (lastDuration * session.manpower);
            // 反推後端需要的格式: start_time
            // Backend logic: (End - Start) * Manpower. 
            // 這裡簡化：我們直接送出 man_hours 欄位給 GAS 比較好，但為了相容舊 GAS 代碼，我們用 totalMs 反推一個 start_time
            // 假設後端用的是 session.manpower (最後人數)，那時間長度要是 totalMs / lastManpower
            const effectiveDuration = totalMs / session.manpower;
            const effectiveStart = new Date(now - effectiveDuration).toISOString();

            const payload = {
                token: SECURITY_TOKEN,
                wo_id: uiState.targetWoId,
                operation_name: job.op_zh,
                supervisor_pin: uiState.pin,
                manpower_count: session.manpower,
                start_time: effectiveStart, // Hack for backend calculation
                qty_good: uiState.finishCache.good,
                qty_reject: uiState.finishCache.reject,
                actual_collar_qty: uiState.finishCache.collar,
                actual_tail_qty: uiState.finishCache.tail
            };

            try {
                // 發送 (使用 no-cors 避免簡單請求問題，或者 text/plain)
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // 重要：GAS Webhook 常用此模式
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 成功處理
                delete appData.activeJobs[uiState.targetWoId];
                // 加入歷史紀錄
                appData.history.push({ ...payload, end_time: new Date().toISOString() });
                saveStorage();
                
                document.getElementById('loading-mask').style.display = 'none';
                showScreen('queue');

            } catch (e) {
                alert("Network Error (但資料已暫存本地)");
                console.error(e);
                document.getElementById('loading-mask').style.display = 'none';
                showScreen('queue');
            }
        }

        // ================= ADMIN LOGIC =================
        function renderAdminCreate() {
            const container = document.getElementById('admin-sub-items');
            // 如果是空的，加一行
            if (!container.innerHTML) addAdminRow();
            
            // 渲染範本下拉
            const sel = document.getElementById('admin-template');
            sel.innerHTML = '<option value="">-- 選擇範本 --</option>';
            appData.templates.forEach((t, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }

        function addAdminRow(prod='', op='') {
            const container = document.getElementById('admin-sub-items');
            const div = document.createElement('div');
            div.className = 'sub-item-row';
            div.innerHTML = `
                <input class="admin-input prod" placeholder="產品 (鮭魚...)" value="${prod}">
                <input class="admin-input op" placeholder="工序 (真空...)" value="${op}">
                <button class="btn-delete" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function saveTemplate() {
            const mwo = document.getElementById('admin-mwo').value;
            if(!mwo) return alert("需輸入總工單號做為範本名");
            
            const items = [];
            document.querySelectorAll('#admin-sub-items .sub-item-row').forEach(row => {
                items.push({ 
                    prod: row.querySelector('.prod').value, 
                    op: row.querySelector('.op').value 
                });
            });
            
            appData.templates.push({ name: mwo, items: items });
            saveStorage();
            renderAdminCreate();
            alert("範本已儲存");
        }

        function loadTemplate() {
            const idx = document.getElementById('admin-template').value;
            if(idx === "") return;
            const tmpl = appData.templates[idx];
            document.getElementById('admin-mwo').value = tmpl.name + "-NEW";
            document.getElementById('admin-sub-items').innerHTML = '';
            tmpl.items.forEach(i => addAdminRow(i.prod, i.op));
        }

        function publishWorkOrders() {
            const mwo = document.getElementById('admin-mwo').value;
            if(!mwo) return alert("缺單號");
            
            let count = 0;
            document.querySelectorAll('#admin-sub-items .sub-item-row').forEach(row => {
                const prod = row.querySelector('.prod').value;
                const op = row.querySelector('.op').value;
                if(prod && op) {
                    count++;
                    appData.queue.push({
                        wo_id: `${mwo}-Q${Date.now()}-${count}`,
                        master: mwo,
                        prod_zh: prod, prod_vn: prod, // 簡化：中越文相同
                        op_zh: op, op_vn: op,
                        rank: appData.queue.length + 1,
                        st: 1.0
                    });
                }
            });
            saveStorage();
            alert(`已發布 ${count} 張工單`);
            document.getElementById('admin-mwo').value = '';
            document.getElementById('admin-sub-items').innerHTML = '';
            addAdminRow();
        }
        
        function resetData() {
            if(confirm("Reset all data?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function showAdminTab(tab) {
            if(tab === 'create') {
                document.getElementById('admin-tab-create').style.display = 'block';
                document.getElementById('admin-tab-history').style.display = 'none';
            } else {
                document.getElementById('admin-tab-create').style.display = 'none';
                document.getElementById('admin-tab-history').style.display = 'block';
                renderHistory();
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = appData.history.map(h => `
                <div style="border-bottom:1px solid #333; padding:10px;">
                    <div>${h.operation_name} - ${h.wo_id}</div>
                    <div style="color:#666; font-size:0.8rem;">${h.start_time}</div>
                </div>
            `).join('');
        }

        // ================= HELPERS =================
        function renderKeypad(id, handler) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            ['7','8','9','4','5','6','1','2','3','C','0','OK'].forEach(k => {
                const btn = document.createElement('button');
                btn.className = `key-btn ${k==='OK'?'key-confirm':''} ${k==='C'?'key-clear':''}`;
                btn.textContent = k;
                btn.onclick = () => handler(k);
                el.appendChild(btn);
            });
        }

        // Start
        init();
        
        function forceReload() {
            location.reload();
        }
    </script>
</body>
</html>