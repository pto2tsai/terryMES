<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MES Lite ç°¡æ˜“å·¥æ™‚æ¡é›†</title>
    <style>
        /* ---------------------------------- */
        /* CSS: éŸ¿æ‡‰å¼æ¥µç°¡é¢¨æ ¼ (V2.4 Stability Fix) */
        /* ---------------------------------- */
        :root {
            --bg-color: #0b1a2c;
            --text-color: #ffffff;
            --primary-color: #00bcd4;
            --btn-bg: #1a3449;
            --btn-active: #007bff;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #ff5722;
            --panel-bg: #112233;
            --nav-width: 70px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            text-align: center;
            display: flex; flex-direction: row;
            overflow: hidden;
        }

        /* å°èˆªåˆ— */
        .nav-bar {
            width: var(--nav-width);
            height: 100vh;
            background-color: #050b14;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        .nav-icons {
            display: flex; flex-direction: column; gap: 25px; margin-bottom: auto;
        }

        .nav-btn {
            background: none; border: none; cursor: pointer; padding: 12px;
            color: var(--primary-color); display: flex; align-items: center; justify-content: center;
            border-radius: 12px; transition: background 0.2s, transform 0.1s;
            touch-action: manipulation;
        }
        .nav-btn:active { background-color: rgba(255,255,255,0.1); transform: scale(0.95); }
        .nav-btn svg { width: 36px; height: 36px; fill: currentColor; }

        /* å°èˆªæ¨™é¡Œ (é è¨­åœ¨å´é‚Šæ¬„éš±è—ï¼Œé¿å…éæ“ ) */
        .nav-title {
            font-size: 1.2rem; color: var(--primary-color); font-weight: bold;
            display: none; 
        }

        .version-tag {
            font-size: 0.7rem; color: #555; margin-bottom: 10px; writing-mode: vertical-lr;
        }

        .container {
            flex-grow: 1; padding: 10px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            position: relative; display: flex; flex-direction: column;
        }

        .screen { display: none; min-height: 90vh; padding-bottom: 50px; width: 100%; }

        h1 { font-size: 1.5rem; color: var(--primary-color); margin: 5px 0; }
        
        .large-btn {
            padding: 12px; margin: 4px; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; border: 2px solid var(--primary-color); border-radius: 8px;
            background-color: var(--btn-bg); color: white; transition: all 0.1s;
            line-height: 1.2; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            touch-action: manipulation;
        }
        .large-btn:active { background-color: var(--btn-active); transform: scale(0.96); }
        .large-btn.disabled { background-color: #555; border-color: #777; cursor: not-allowed; opacity: 0.6; }

        .large-select {
            width: 98%; font-size: 1.1rem; padding: 10px; margin-bottom: 10px;
            background-color: var(--btn-bg); color: white; border: 2px solid var(--primary-color);
            border-radius: 8px; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300bcd4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 16px auto;
        }

        #queue-list-container { display: grid; gap: 8px; padding: 2px; }
        .queue-item {
            text-align: left; border-color: var(--success-color); position: relative;
            padding: 12px 15px;
            min-height: auto; display: flex; flex-direction: column; justify-content: center;
            border-radius: 8px; border: 1px solid var(--success-color);
            background-color: var(--btn-bg); cursor: pointer;
            touch-action: manipulation;
        }
        .queue-item:active { transform: scale(0.98); }
        .queue-item.active-job {
            background-color: #1b5e20; border-color: #66bb6a; border-width: 2px;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        
        .status-badge {
            position: absolute; top: 8px; right: 8px; background-color: #00e676;
            color: #000; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;
            display: none;
        }
        .queue-item.active-job .status-badge { display: block; }

        .q-num { font-size: 1.3rem; font-weight: bold; color: var(--primary-color); margin-right: 8px; float: left;}
        .main-lang { font-size: 1.1rem; font-weight: bold; display: block; margin-bottom: 4px; }
        .aux-lang { font-size: 0.9rem; color: #ccc; display: block; margin-bottom: 4px;}
        .wo-details { font-size: 0.9rem; color: #b2dfdb; border-top: 1px solid #444; margin-top: 5px; padding-top: 5px; }

        .empty-message {
            grid-column: 1 / -1;
            padding: 40px;
            color: #888;
            font-size: 1.2rem;
            border: 2px dashed #444;
            border-radius: 10px;
            margin-top: 20px;
        }

        .pin-display {
            font-size: 3rem; letter-spacing: 5px; margin: 10px auto;
            height: 50px; line-height: 50px; border-bottom: 3px dashed var(--primary-color);
            color: #ffd700; max-width: 250px;
        }
        .error { color: var(--error-color); font-size: 1.1rem; margin-top: 5px; font-weight: bold; min-height: 1.2em; }

        .keypad-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
            width: 100%; max-width: 400px; margin: 5px auto;
        }
        .keypad-grid .large-btn { font-size: 1.5rem; padding: 15px; margin: 0; }

        .btn-confirm { background-color: var(--success-color); border-color: var(--success-color); font-size: 1.3rem; }
        .btn-back { background-color: #607d8b; border-color: #78909c; }
        .btn-adjust { background-color: #3f51b5; border-color: #5c6bc0; }
        .btn-reset { background-color: #d32f2f; border-color: #b71c1c; font-size: 1rem; width: 100%; margin-top: 10px;}

        .diagnostic-info { font-size: 0.6rem; color: #555; margin-top: 5px; }
        .url-alert { background-color: #581515; border: 2px solid var(--error-color); padding: 10px; margin-bottom: 10px; border-radius: 5px; font-size: 0.9rem; color: white; text-align: left; font-weight: bold; display: none; }

        /* ç”Ÿç®¡ç•«é¢ */
        .planner-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #050b14;
            padding: 10px;
            border-radius: 10px;
        }
        .tab-btn {
            background-color: transparent;
            color: #888;
            padding: 12px 25px;
            font-size: 1.2rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            max-width: 200px;
            font-weight: bold;
        }
        .tab-btn.active {
            background-color: var(--primary-color);
            color: #000;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }
        .tab-btn:not(.active) { border-color: #333; color: #aaa; }
        .tab-btn:not(.active):hover { border-color: #555; color: #fff; }
        
        .admin-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { border: 1px solid #444; padding: 6px; text-align: left; }
        .admin-table th { background-color: var(--primary-color); color: black; }
        .admin-table tr:nth-child(even) { background-color: #1a3449; }
        .admin-panel { 
            background-color: var(--panel-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left; 
            max-height: 65vh; overflow-y: auto; border: 1px solid #333;
        }
        .admin-input { width: 100%; padding: 10px; margin: 5px 0 10px 0; background: #000; border: 1px solid #555; color: white; font-size: 1rem; border-radius: 5px;}
        .sub-item-row { display: grid; grid-template-columns: 1fr 1fr 40px; gap: 5px; margin-bottom: 5px; align-items: center; }
        .btn-delete { background-color: #e91e63; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-add-line { background-color: #4caf50; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; width: 100%; }
        .summary-box { background-color: var(--success-color); color: black; padding: 10px; border-radius: 10px; margin-top: 15px; font-weight: bold; font-size: 1.1rem; }
        .history-section { border-top: 1px solid #444; margin-top: 10px; padding-top: 10px; }
        .last-updated { font-size: 0.7rem; color: #555; margin-top: 5px; }

        /* Loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 2000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color);
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
        
        /* åˆ·æ–°æŒ‰éˆ• */
        .refresh-btn {
            position: absolute; top: 10px; right: 10px;
            background: #333; color: white; border: 1px solid #555;
            padding: 5px 10px; border-radius: 5px; cursor: pointer;
            z-index: 100;
        }

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
        @media (min-width: 768px) {
            body { background-color: #2b2b2b; align-items: center; justify-content: center;}
            .nav-bar {
                position: absolute; left: 0; top: 0; height: 100%; width: 80px;
                border-radius: 20px 0 0 20px;
            }
            .container {
                max-width: 750px; background-color: var(--bg-color);
                box-shadow: 0 0 30px rgba(0,0,0,0.8); margin: 20px 0;
                height: calc(100vh - 40px); border-radius: 20px;
                overflow: hidden; padding-left: 80px;
                width: 100%;
            }
            h1 { font-size: 2rem; }
            .keypad-grid { gap: 10px; max-width: 450px; }
            .admin-table { font-size: 1rem; }
            #queue-list-container { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 767px) {
            body { flex-direction: column; }
            .nav-bar {
                width: 100%; height: 50px; flex-direction: row; padding: 0 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            }
            .nav-icons { flex-direction: row; gap: 15px; margin-bottom: 0; }
            .version-tag { writing-mode: horizontal-tb; margin-bottom: 0; margin-left: auto; }
            .nav-title { display: block; } /* æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæ¨™é¡Œ */
            
            .container { padding: 5px; padding-top: 55px; height: 100vh; margin: 0; border-radius: 0; width: 100%; }
            #queue-list-container { grid-template-columns: 1fr; }
            .sub-item-row { grid-template-columns: 1fr; }
            .keypad-grid .large-btn { padding: 12px; font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <div id="nav-bar" class="nav-bar" style="display:none;">
        <div class="nav-icons">
            <button class="nav-btn" onclick="backToQueue()" title="è¿”å›åˆ—è¡¨">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <button class="nav-btn" onclick="goHome()" title="å›åˆ°ä¸»ç•«é¢">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            </button>
            <button class="nav-btn" onclick="logout()" title="ç™»å‡º">
                <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </button>
        </div>
        <!-- V2.4 æ–°å¢ï¼šè£œå›æ¨™é¡Œå…ƒç´ ï¼Œä½†åœ¨ CSS ä¸­è¨­å®šé›»è…¦ç‰ˆéš±è—ï¼Œæ‰‹æ©Ÿç‰ˆé¡¯ç¤º -->
        <div class="nav-title" id="nav-title-display">MES Lite</div>
        <div class="version-tag">V2.4</div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">è™•ç†ä¸­ / Processing...</div>
    </div>

    <div class="container">
        <!-- ç•«é¢ 1: ç™»å…¥ -->
        <div id="screen-login" class="screen" style="display: block;">
            <div class="login-wrapper">
                <h1>MES LITE <span style="font-size:0.8rem; color:#aaa;">V2.4</span></h1>
                <div style="font-size: 1rem; margin-bottom: 5px;">
                    <span data-i18n="login_prompt">è«‹è¼¸å…¥ PIN</span> <span style="color:#aaa;">(ç”Ÿç®¡:9999)</span>
                </div>
                <div class="pin-display" id="pin-input"></div>
                <div id="login-error" class="error"></div>
                
                <div id="keypad" class="keypad-grid"></div>
                
                <div id="url-alert-box" class="url-alert">ğŸš¨ è«‹è¨­å®š GAS URL</div>
                <div class="diagnostic-info">GAS: <span id="api-base-url-display">N/A</span></div>
            </div>
        </div>

        <!-- ç•«é¢ 1.5: ç”Ÿç®¡ä¸»é é¢ -->
        <div id="screen-planner" class="screen">
            <h1>ğŸ“‹ ç”Ÿç®¡æ§åˆ¶å°</h1>
            <div class="planner-tabs">
                <button class="tab-btn active" id="btn-tab-queue" onclick="switchPlannerTab('tab-queue')">å·¥å–®ç·¨è¼¯</button>
                <button class="tab-btn" id="btn-tab-report" onclick="switchPlannerTab('tab-report')">å ±è¡¨è¼¸å‡º</button>
            </div>
            <!-- Tab 1 -->
            <div id="tab-queue" class="planner-tab-content">
                <div class="admin-panel">
                    <h3>â• å»ºç«‹ç¸½å·¥å–®</h3>
                    <div class="history-section">
                        <label style="color: #aaa;">ğŸ“‚ ç¯„æœ¬ (Templates):</label>
                        <div style="display:flex; gap:5px;">
                            <select id="mwo-history-select" class="large-select" style="font-size:1rem; padding:8px; margin-bottom:5px;" onchange="loadMWOFromHistory()">
                                <option value="">-- é¸æ“‡ç¯„æœ¬ --</option>
                            </select>
                            <button class="btn-delete" style="height:40px;" onclick="deleteTemplate()" title="åˆªé™¤ç¯„æœ¬">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <label>ç¸½å·¥å–® ID:</label>
                    <input type="text" id="batch-mwo" class="admin-input" placeholder="ä¾‹å¦‚: MWO-A">
                    <h4>å­å·¥å–®é …ç›®</h4>
                    <div id="sub-items-container"></div>
                    <button class="btn-add-line" onclick="addSubItemRow()">+ æ–°å¢é …ç›®</button>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="large-btn" style="width:50%; font-size:1.1rem; background-color:#607d8b; border-color:#78909c;" onclick="saveBatchTemplateOnly()">åƒ…å„²å­˜ç¯„æœ¬</button>
                        <button class="large-btn btn-confirm" style="width:50%; font-size:1.1rem;" onclick="saveBatchWorkOrder()">ç¢ºèªé€å‡º</button>
                    </div>
                    <button class="large-btn btn-reset" onclick="resetAllData()">âš ï¸ é‡ç½®ä¸¦æ¢å¾©é è¨­è³‡æ–™ (ä¿®å¾©ç©ºç™½)</button>
                </div>
                <h3>ç›®å‰æ’ç¨‹ (<span id="queue-count">0</span> ç­†)</h3>
                <div style="overflow-x:auto;">
                    <table class="admin-table" id="admin-queue-table">
                        <thead><tr><th>ç¸½å·¥å–®</th><th>ç”¢å“</th><th>å·¥åº</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="admin-queue-body"></tbody>
                    </table>
                </div>
            </div>
            <!-- Tab 2 -->
            <div id="tab-report" class="planner-tab-content" style="display:none;">
                <div class="admin-panel">
                    <h3>ğŸ“Š å·²å®Œæˆç´€éŒ„</h3>
                    <button class="large-btn" style="width:100%; font-size:1.2rem; background-color:#2196f3;" onclick="calculateReport()">è¨ˆç®—é¸å–ç¸½å·¥æ™‚</button>
                </div>
                <div id="report-summary" class="summary-box" style="display:none;">
                    ç¸½äººæ™‚: <span id="sum-manhours">0</span> å°æ™‚<br>è‰¯å“: <span id="sum-good">0</span> | æè€—: <span id="sum-reject">0</span>
                </div>
                <div style="overflow-x:auto;">
                    <table class="admin-table" id="admin-report-table">
                        <thead><tr><th><input type="checkbox" onclick="toggleAllReports(this)"></th><th>æ™‚é–“</th><th>å·¥å–®</th><th>å·¥åº</th><th>äººæ™‚</th></tr></thead>
                        <tbody id="admin-report-body"></tbody>
                    </table>
                </div>
                <button class="large-btn btn-back" style="margin-top:20px;" onclick="clearCompletedLogs()">æ¸…é™¤ç´€éŒ„</button>
            </div>
        </div>

        <!-- ç•«é¢ 2: å¾…è¾¦æ’éšŠ -->
        <div id="screen-queue" class="screen">
            <h1 id="queue-title"></h1>
            <button class="refresh-btn" onclick="forceReload()">ğŸ”„ åˆ·æ–°</button>
            <div style="font-size: 1rem; color: #00bcd4; margin-bottom: 10px;" data-i18n="select_job_prompt">ğŸ‘† è«‹é»æ“Šæ¬²é–‹å§‹çš„å·¥å–®</div>
            <select id="master-wo-select" class="large-select" onchange="filterQueue()">
                <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
            </select>
            <div id="queue-list-container"></div>
            <div class="last-updated" id="last-update-time"></div>
        </div>

        <!-- ç•«é¢ 2.5: è¼¸å…¥äººæ•¸ -->
        <div id="screen-manpower" class="screen">
            <h1 style="color: #ffd700;" data-i18n="manpower_input_title">è¼¸å…¥äººæ•¸</h1>
            <div style="font-size: 1.2rem;">
                <span data-i18n="working_wo">å·¥å–®</span>: <span id="manpower-woid" style="font-weight: bold; color: #00bcd4;"></span>
            </div>
            <div style="margin: 20px auto; max-width: 400px;">
                <div class="pin-display" id="manpower-input-display" style="letter-spacing: normal; color: #ffd700;">0</div>
            </div>
            <div id="manpower-keypad-container" class="keypad-grid"></div>
        </div>

        <!-- ç•«é¢ 3: æ­£åœ¨è¨ˆæ™‚ -->
        <div id="screen-working" class="screen">
            <h1 class="working-status">ğŸŸ¢ <span data-i18n="working_in_progress">æ­£åœ¨é€²è¡Œä¸­</span></h1>
            <div style="font-size: 1.5rem; margin-top: 10px;">
                <span data-i18n="working_wo">å·¥å–®</span>: <span id="working-woid" style="font-weight: bold;"></span>
            </div>
            <div style="font-size: 2.5rem; color: #ffd700; margin: 20px 0;">
                <span data-i18n="manpower_count">äººæ•¸</span>: <span id="manpower-display"></span>
            </div>
            <div style="font-size: 3.5rem; color: #00bcd4;">
                <span data-i18n="elapsed_time">å·²è€—æ™‚</span>: <span id="elapsed-time">00:00:00</span>
            </div>
            <div style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
                <button class="large-btn btn-adjust" style="width: 90%; margin-bottom: 10px;" onclick="adjustManpower()">
                    <span data-i18n="btn_adjust_manpower">ğŸ‘¥ èª¿æ•´äººæ•¸</span>
                </button>
                <button class="large-btn btn-back" style="width: 90%; margin-bottom: 10px;" onclick="backToQueue()">
                    <span data-i18n="btn_back_list">â¬… æš«é›¢ / è¿”å›åˆ—è¡¨</span>
                </button>
                <button class="large-btn btn-confirm" style="background-color: orange; width: 90%; font-size: 1.8rem;" onclick="endJob()">
                    <span data-i18n="btn_finish">å®Œæˆå·¥å–®</span>
                </button>
            </div>
        </div>

        <!-- ç•«é¢ 4: æ•¸é‡è¼¸å…¥ -->
        <div id="screen-finish" class="screen">
            <h1 style="color: #ff9800;" data-i18n="finish_prompt">æ­¥é©Ÿ 4: è¼¸å…¥æ•¸é‡</h1>
            <div style="font-size: 1.2rem;">
                <span data-i18n="finish_wo">å·¥å–®</span>: <span id="finish-woid" style="font-weight: bold; color: #ffd700;"></span>
            </div>
            <div style="margin: 10px auto; max-width: 400px;">
                <div id="finish-instruction" style="font-size: 1.5rem; color: #00bcd4; margin-bottom: 10px; min-height: 40px; white-space: pre-line;"></div>
                <div class="pin-display" id="qty-input-display" style="letter-spacing: normal; color: #ffd700;">0</div>
            </div>
            <div id="finish-keypad-container" class="keypad-grid"></div>
        </div>
    </div>

    <script>
        // ğŸš¨ é—œéµï¼šè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„ Google Apps Script Webhook URL
        const GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbyP9sYjwQ3pM7MMkrbiWTaUKmIeUcWhtWzPEqyhBlpHds7NfK6I49TTbEg4DWGsutBytA/exec'; 
        const SECURITY_TOKEN = "MES_LITE_2025"; 
        const VERSION = "V2.4";

        let state = {
            currentScreen: 'login', currentPIN: '', currentUser: null, language: 'zh',
            activeSessions: {}, currentViewingWoId: null, currentWoOperationName: null, 
            currentManpower: 0, finishStep: 0, 
            finishData: { qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0, qty_good: 0 },
            currentTypedValue: '0', startTimeISO: null, isSubmitting: false 
        };

        let timerInterval = null;
        let appQueue = []; let completedLogs = []; let mwoHistory = [];
        let autoRefreshInterval = null;

        const defaultQueue = [
            { wo_id: 'WC-TEST-Q1', master_wo_id: 'MWO-TEST', product_name_zh: 'æ¸¬è©¦-é®­é­šåˆ†åˆ‡', product_name_vn: 'Test-CÃ¡ há»“i', operation_name_zh: 'åˆ†åˆ‡/åˆ†æ–™', operation_name_vn: 'Cáº¯t lÃ¡t', queue_rank: 1, standard_time_hr: 1.0 },
            { wo_id: 'WC-TEST-Q2', master_wo_id: 'MWO-TEST', product_name_zh: 'æ¸¬è©¦-çœŸç©ºåŒ…è£', product_name_vn: 'Test-ÄÃ³ng gÃ³i', operation_name_zh: 'çœŸç©ºåŒ…è£', operation_name_vn: 'ÄÃ³ng gÃ³i HK', queue_rank: 2, standard_time_hr: 0.5 }
        ];

        const i18n = {
            zh: {
                login_prompt: 'è«‹è¼¸å…¥ 4 ä½è­˜åˆ¥ç¢¼', pin_error: 'PIN ç¢¼éŒ¯èª¤ï¼', select_job_prompt: 'ğŸ‘† è«‹é»æ“Šæ¬²é–‹å§‹çš„å·¥å–®', job_start_error: 'å•Ÿå‹•å¤±æ•—', working_wo: 'å·¥å–®', manpower_count: 'äººæ•¸', elapsed_time: 'å·²è€—æ™‚', working_in_progress: 'æ­£åœ¨é€²è¡Œä¸­', 
                manpower_input_title: 'æ­¥é©Ÿ 2: è¼¸å…¥äººæ•¸', manpower_error: 'äººæ•¸å¿…é ˆå¤§æ–¼ 0',
                finish_prompt: 'æ­¥é©Ÿ 4: è¼¸å…¥æ•¸é‡', finish_wo: 'å·¥å–®', finish_step1: 'âŒ ä¸è‰¯å“/æè€—é‡é‡ (KG)', finish_step2: 'ä¸‹å·´é‡é‡ (KG)', finish_step3: 'å°¾æ®µé‡é‡ (KG)', finish_step4: 'âœ… ä¸­å¾Œæ®µç¸½é‡ (KG)', finish_step5_good: 'âœ… è‰¯å“æ•¸é‡ (PCS/KG)', finish_step5_reject: 'âŒ ä¸è‰¯å“æ•¸é‡ (PCS/KG)', btn_finish: 'å®Œæˆå·¥å–®', btn_confirm_submit: 'ç¢ºèªæäº¤', missing_data: 'æ•¸æ“šä¸å®Œæ•´', api_error: 'é€£ç·šéŒ¯èª¤', no_job_in_queue: 'ğŸ“­ ç›®å‰æ²’æœ‰å¾…è¾¦å·¥å–®', btn_back_list: 'â¬… æš«é›¢ / è¿”å›åˆ—è¡¨', running_status: 'é€²è¡Œä¸­',
                btn_adjust_manpower: 'ğŸ‘¥ èª¿æ•´äººæ•¸', confirm_summary_title: 'ğŸ“‹ è«‹ç¢ºèªè³‡æ–™:', confirm_btn_text: 'ç¢ºèªé€å‡º'
            },
            vn: {
                login_prompt: 'NHáº¬P MÃƒ PIN', pin_error: 'Sai mÃ£ PIN!', select_job_prompt: 'ğŸ‘† CHá»ŒN CÃ”NG VIá»†C', job_start_error: 'Lá»—i!', working_wo: 'ÄÆ¡n hÃ ng', manpower_count: 'Sá»‘ ngÆ°á»i', elapsed_time: 'ÄÃ£ cháº¡y giá»', working_in_progress: 'ÄANG THá»°C HIá»†N', 
                manpower_input_title: 'NHáº¬P Sá» NGÆ¯á»œI', manpower_error: 'Sá»‘ ngÆ°á»i > 0',
                finish_prompt: 'NHáº¬P Sá» LÆ¯á»¢NG', finish_wo: 'ÄÆ¡n hÃ ng', finish_step1: 'âŒ CÃ‚N Náº¶NG Há»NG', finish_step2: 'CÃ‚N Náº¶NG Cáº°M', finish_step3: 'CÃ‚N Náº¶NG ÄUÃ”I', finish_step4: 'âœ… Tá»”NG CÃ‚N Náº¶NG', finish_step5_good: 'âœ… Sá»‘ lÆ°á»£ng tá»‘t', finish_step5_reject: 'âŒ Sá»‘ lÆ°á»£ng há»ng', btn_finish: 'HoÃ n thÃ nh', btn_confirm_submit: 'XÃC NHáº¬N Gá»¬I', missing_data: 'Thiáº¿u dá»¯ liá»‡u', api_error: 'Lá»—i káº¿t ná»‘i', no_job_in_queue: 'KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng', btn_back_list: 'â¬… Quay láº¡i', running_status: 'Running',
                btn_adjust_manpower: 'ğŸ‘¥ Thay Ä‘á»•i nhÃ¢n lá»±c', confirm_summary_title: 'ğŸ“‹ XÃ¡c nháº­n dá»¯ liá»‡u:', confirm_btn_text: 'Nháº¥n XÃ¡c nháº­n'
            }
        };

        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- Loading Overlay ---
        function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

        // --- Init & Storage ---
        function saveQueueToStorage() {
            localStorage.setItem('mes_lite_queue', JSON.stringify(appQueue));
        }
        function saveLogsToStorage() {
            localStorage.setItem('mes_lite_logs', JSON.stringify(completedLogs));
        }
        function saveMWOHistoryToStorage() {
            localStorage.setItem('mes_mwo_history', JSON.stringify(mwoHistory));
        }
        function saveSessionsToStorage() {
            localStorage.setItem('mes_active_sessions', JSON.stringify(state.activeSessions));
        }
        function saveAppStateToStorage() {
            localStorage.setItem('mes_app_state', JSON.stringify({
                currentViewingWoId: state.currentViewingWoId,
                currentWoOperationName: state.currentWoOperationName,
                currentManpower: state.currentManpower
            }));
        }

        function initApp() {
            // 1. Load Queue: å¼·åˆ¶æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
            const storedQueue = localStorage.getItem('mes_lite_queue');
            if (storedQueue) { 
                try {
                    const parsed = JSON.parse(storedQueue);
                    if (!Array.isArray(parsed) || parsed.length === 0) { 
                        appQueue = [...defaultQueue]; 
                        saveQueueToStorage(); 
                    } else { 
                        appQueue = parsed; 
                    }
                } catch (e) {
                    appQueue = [...defaultQueue];
                    saveQueueToStorage();
                }
            } else { 
                appQueue = [...defaultQueue]; 
                saveQueueToStorage(); 
            }
            
            const storedLogs = localStorage.getItem('mes_lite_logs');
            if (storedLogs) completedLogs = JSON.parse(storedLogs);

            const storedMWOHistory = localStorage.getItem('mes_mwo_history');
            if (storedMWOHistory) mwoHistory = JSON.parse(storedMWOHistory);

            const storedSessions = localStorage.getItem('mes_active_sessions');
            if (storedSessions) state.activeSessions = JSON.parse(storedSessions);

            const storedAppState = localStorage.getItem('mes_app_state');
            if (storedAppState) {
                const savedState = JSON.parse(storedAppState);
                if (savedState.currentViewingWoId) state.currentViewingWoId = savedState.currentViewingWoId;
                if (savedState.currentWoOperationName) state.currentWoOperationName = savedState.currentWoOperationName;
                if (savedState.currentManpower) state.currentManpower = savedState.currentManpower;
            }

            document.getElementById('api-base-url-display').textContent = GAS_WEBHOOK_URL; 
            if (GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') document.getElementById('url-alert-box').style.display = 'block';
            
            renderKeypad('keypad', 'PIN'); 
            updateUI();

            // 2. å•Ÿå‹•è‡ªå‹•æ›´æ–° (æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡ Storageï¼Œå¯¦ç¾è·¨åˆ†é åŒæ­¥)
            if(autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (state.currentScreen === 'queue') {
                    loadQueue(); // éœé»˜é‡è¼‰
                }
            }, 5000);
            
            // 3. è·¨åˆ†é ç›£è½
            window.addEventListener('storage', (e) => {
                if (e.key === 'mes_lite_queue' && state.currentScreen === 'queue') {
                    loadQueue();
                }
            });
        }

        function saveAll() {
            saveQueueToStorage();
            saveLogsToStorage();
            saveMWOHistoryToStorage();
            saveSessionsToStorage();
            saveAppStateToStorage();
        }

        function resetAllData() {
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿé€™æœƒåˆªé™¤æœ¬æ©Ÿæ‰€æœ‰å·¥å–®ã€ç´€éŒ„å’Œè¨­å®šï¼Œä¸¦æ¢å¾©é è¨­å€¼ã€‚")) {
                localStorage.clear();
                location.reload();
            }
        }

        function forceReload() {
            // æ‰‹å‹•å¼·åˆ¶é‡è¼‰æ•¸æ“š
            const storedQueue = localStorage.getItem('mes_lite_queue');
            if (storedQueue) {
                try {
                   appQueue = JSON.parse(storedQueue);
                } catch(e) {
                   appQueue = [...defaultQueue];
                   saveQueueToStorage();
                }
                loadQueue();
                // é¡¯ç¤ºè¼•é‡æç¤º
                const btn = document.querySelector('.refresh-btn');
                const originalText = btn.textContent;
                btn.textContent = "å·²åˆ·æ–°";
                setTimeout(() => btn.textContent = originalText, 1000);
            } else {
                initApp(); // é‡æ–°åˆå§‹åŒ–
                alert("è³‡æ–™å·²é‡ç½®");
            }
        }

        // --- UI ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            state.currentScreen = screenId.replace('screen-', '');
            
            const navBar = document.getElementById('nav-bar');
            if (state.currentScreen === 'login') {
                navBar.style.display = 'none';
                renderKeypad('keypad', 'PIN');
                state.currentPIN = '';
                document.getElementById('pin-input').textContent = '';
            } else {
                navBar.style.display = 'flex';
                let title = "MES Lite";
                if(state.currentScreen === 'queue') title = "å¾…è¾¦æ’ç¨‹";
                if(state.currentScreen === 'planner') title = "ç”Ÿç®¡æ§åˆ¶å°";
                if(state.currentScreen === 'working') title = "è¨ˆæ™‚ä¸­";
                
                // V2.4 FIX: å®‰å…¨æª¢æŸ¥ nav-title-display æ˜¯å¦å­˜åœ¨
                const titleEl = document.getElementById('nav-title-display');
                if(titleEl) titleEl.textContent = title;
            }

            if (state.currentScreen === 'queue') loadQueue();
            if (state.currentScreen === 'planner') {
                renderPlannerQueue(); updateMWOHistoryDropdown();
                if (document.getElementById('sub-items-container').children.length === 0) addSubItemRow();
            }
            saveAll();
        }

        function updateUI() {
            const currentLang = state.language;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang] && i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
            });
            if (state.currentUser && state.currentUser.name_zh) {
                const greeting = currentLang === 'vn' ? `ChÃ o Ã”ng ${state.currentUser.name_vn}` : `ä½ å¥½ï¼Œ${state.currentUser.name_zh}`;
                document.getElementById('queue-title').textContent = greeting;
            }
        }

        function goHome() {
            if (state.currentUser && state.currentUser.user_pin === '9999') { showScreen('screen-planner'); switchPlannerTab('tab-queue'); } 
            else { backToQueue(); }
        }

        // --- Planner ---
        function switchPlannerTab(tabId) {
            document.querySelectorAll('.planner-tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            const activeBtnId = tabId === 'tab-queue' ? 'btn-tab-queue' : 'btn-tab-report';
            document.getElementById(activeBtnId).classList.add('active');

            if (tabId === 'tab-queue') { renderPlannerQueue(); updateMWOHistoryDropdown(); }
            if (tabId === 'tab-report') renderPlannerReport();
        }

        function renderPlannerQueue() {
            const tbody = document.getElementById('admin-queue-body');
            tbody.innerHTML = '';
            
            const countEl = document.getElementById('queue-count');
            if(countEl) countEl.textContent = appQueue.length;

            if (appQueue.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">ç„¡è³‡æ–™</td></tr>';
                return;
            }
            
            const html = appQueue.map((job, index) => `
                <tr>
                    <td>${escapeHtml(job.master_wo_id)}</td>
                    <td>${escapeHtml(job.product_name_zh)}</td>
                    <td>${escapeHtml(job.operation_name_zh)}</td>
                    <td><button class="btn-delete" onclick="deleteWorkOrder(${index})">åˆªé™¤</button></td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
        }

        function addSubItemRow(prod = '', op = '') {
            const container = document.getElementById('sub-items-container');
            const div = document.createElement('div');
            div.className = 'sub-item-row';
            div.innerHTML = `<input type="text" class="admin-input prod-input" placeholder="ç”¢å“åç¨±" value="${escapeHtml(prod)}"><input type="text" class="admin-input op-input" placeholder="å·¥åºåç¨±" value="${escapeHtml(op)}"><button class="btn-delete" onclick="this.parentElement.remove()">X</button>`;
            container.appendChild(div);
        }

        function updateMWOHistoryDropdown() {
            const select = document.getElementById('mwo-history-select');
            select.innerHTML = '<option value="">-- é¸æ“‡ç¯„æœ¬ --</option>';
            [...mwoHistory].reverse().forEach(template => {
                const option = document.createElement('option');
                option.value = template.mwo_id;
                option.textContent = `${template.mwo_id} (${template.items.length} é …)`;
                select.appendChild(option);
            });
        }

        function loadMWOFromHistory() {
            const selectedMWO = document.getElementById('mwo-history-select').value;
            if (!selectedMWO) return;
            const template = mwoHistory.find(t => t.mwo_id === selectedMWO);
            if (!template) return;
            document.getElementById('batch-mwo').value = template.mwo_id + "-" + Math.floor(Math.random()*1000); 
            document.getElementById('sub-items-container').innerHTML = '';
            template.items.forEach(item => addSubItemRow(item.prod, item.op));
        }

        function deleteTemplate() {
            const selectedMWO = document.getElementById('mwo-history-select').value;
            if (!selectedMWO) { alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç¯„æœ¬"); return; }
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¯„æœ¬ ${selectedMWO} å—ï¼Ÿ`)) {
                mwoHistory = mwoHistory.filter(t => t.mwo_id !== selectedMWO);
                saveMWOHistoryToStorage();
                updateMWOHistoryDropdown();
                document.getElementById('mwo-history-select').value = "";
            }
        }

        function saveBatchTemplateOnly() {
            const mwo = document.getElementById('batch-mwo').value;
            if (!mwo) { alert("è«‹è¼¸å…¥ç¸½å·¥å–® ID"); return; }
            const templateItems = [];
            document.querySelectorAll('.sub-item-row').forEach((row) => {
                const prod = row.querySelector('.prod-input').value;
                const op = row.querySelector('.op-input').value;
                if (prod && op) templateItems.push({ prod: prod, op: op });
            });
            if (templateItems.length > 0) {
                const existIdx = mwoHistory.findIndex(x => x.mwo_id === mwo);
                if (existIdx >= 0) {
                    if(!confirm(`ç¯„æœ¬ ${mwo} å·²å­˜åœ¨ï¼Œè¦†è“‹ï¼Ÿ`)) return;
                    mwoHistory[existIdx] = { mwo_id: mwo, items: templateItems };
                } else {
                    mwoHistory.push({ mwo_id: mwo, items: templateItems });
                }
                saveMWOHistoryToStorage(); updateMWOHistoryDropdown();
                alert(`ç¯„æœ¬ ${mwo} å·²å„²å­˜ï¼`);
            }
        }

        function saveBatchWorkOrder() {
            const mwo = document.getElementById('batch-mwo').value;
            if (!mwo) { alert("è«‹è¼¸å…¥ç¸½å·¥å–® ID"); return; }
            let addedCount = 0; const templateItems = [];
            document.querySelectorAll('.sub-item-row').forEach((row, index) => {
                const prod = row.querySelector('.prod-input').value;
                const op = row.querySelector('.op-input').value;
                if (prod && op) {
                    const uniqueId = `${mwo}-Q${Date.now()}-${index}`;
                    appQueue.push({
                        wo_id: uniqueId, master_wo_id: mwo, 
                        product_name_zh: prod, product_name_vn: prod, 
                        operation_name_zh: op, operation_name_vn: op, 
                        queue_rank: appQueue.length + 1, standard_time_hr: 1.0
                    });
                    templateItems.push({ prod: prod, op: op });
                    addedCount++;
                }
            });
            if (addedCount > 0) {
                const existIdx = mwoHistory.findIndex(x => x.mwo_id === mwo);
                if (existIdx < 0) mwoHistory.push({ mwo_id: mwo, items: templateItems });
                saveAll(); renderPlannerQueue(); updateMWOHistoryDropdown();
                alert(`æˆåŠŸæ–°å¢ ${addedCount} ç­†å·¥å–®ï¼`);
                document.getElementById('batch-mwo').value = '';
                document.getElementById('sub-items-container').innerHTML = '';
                addSubItemRow(); 
            } else { alert("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹é …ç›®"); }
        }

        function deleteWorkOrder(index) {
            if (confirm("åˆªé™¤æ­¤å·¥å–®ï¼Ÿ")) { appQueue.splice(index, 1); saveAll(); renderPlannerQueue(); }
        }

        function renderPlannerReport() {
            const tbody = document.getElementById('admin-report-body');
            tbody.innerHTML = '';
            [...completedLogs].reverse().forEach((log, index) => {
                const time = new Date(log.endTime).toLocaleString();
                const realIndex = completedLogs.length - 1 - index;
                tbody.innerHTML += `<tr><td><input type="checkbox" class="report-checkbox" data-index="${realIndex}"></td><td>${time}</td><td>${escapeHtml(log.wo_id)}</td><td>${escapeHtml(log.operation_name)}</td><td>${parseFloat(log.totalManHours).toFixed(2)}</td></tr>`;
            });
        }

        function toggleAllReports(source) { document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = source.checked); }

        function calculateReport() {
            const checkboxes = document.querySelectorAll('.report-checkbox:checked');
            if (checkboxes.length === 0) { alert("è«‹å…ˆå‹¾é¸é …ç›®"); return; }
            let totalHours = 0, totalGood = 0, totalReject = 0;
            checkboxes.forEach(cb => {
                const log = completedLogs[cb.getAttribute('data-index')];
                totalHours += parseFloat(log.totalManHours || 0);
                totalGood += parseFloat(log.qty_good || 0);
                totalReject += parseFloat(log.qty_reject || 0);
            });
            document.getElementById('sum-manhours').textContent = totalHours.toFixed(2);
            document.getElementById('sum-good').textContent = totalGood.toFixed(2);
            document.getElementById('sum-reject').textContent = totalReject.toFixed(2);
            document.getElementById('report-summary').style.display = 'block';
        }

        function clearCompletedLogs() {
            if (confirm("æ¸…é™¤ç´€éŒ„ï¼Ÿ")) { completedLogs = []; saveAll(); renderPlannerReport(); document.getElementById('report-summary').style.display = 'none'; }
        }

        function logout() { state.currentUser = null; showScreen('screen-login'); }

        // --- Keypad & Input ---
        function renderKeypad(targetElementId, targetInputType) {
            state.inputTarget = targetInputType;
            const layout = ['7', '8', '9', '4', '5', '6', '1', '2', '3', 'C', '0', 'OK'];
            const keypadDiv = document.getElementById(targetElementId);
            keypadDiv.innerHTML = '';
            layout.forEach(key => {
                const btn = document.createElement('div');
                btn.className = 'large-btn';
                if (key === 'OK') { btn.className += ' btn-confirm'; btn.textContent = 'ç¢ºèª'; } 
                else { btn.textContent = key; }
                btn.style.width = '100%'; 
                btn.onclick = () => handleKeypadInput(key);
                keypadDiv.appendChild(btn);
            });
        }

        function handleKeypadInput(key) {
            if (state.isSubmitting && key === 'OK') return;
            if (state.finishStep === 7) { if (key === 'OK') handleConfirmKey(); return; }

            let currentInput = (state.currentScreen === 'login') ? state.currentPIN : state.currentTypedValue;
            let displayEl = document.getElementById((state.currentScreen === 'login') ? 'pin-input' : (state.currentScreen === 'manpower' ? 'manpower-input-display' : 'qty-input-display'));
            document.getElementById('login-error').textContent = ''; 

            if (key >= '0' && key <= '9') {
                if (currentInput.length < 8) currentInput = (currentInput === '0' || currentInput === '') ? key : currentInput + key;
            } else if (key === 'C') {
                currentInput = (state.currentScreen === 'login') ? '' : '0';
            } else if (key === 'OK') {
                if (state.currentScreen === 'login') validateLogin(currentInput);
                else if (state.currentScreen === 'manpower') confirmManpower(parseInt(currentInput));
                else if (state.currentScreen === 'finish') processFinishStep(parseFloat(currentInput));
                return;
            }
            
            if (state.currentScreen === 'login') {
                state.currentPIN = currentInput;
                displayEl.textContent = '*'.repeat(currentInput.length);
            } else {
                state.currentTypedValue = currentInput;
                displayEl.textContent = currentInput;
            }
        }

        // --- Logic ---
        function validateLogin(pin) {
            if (pin === '9999') { showScreen('screen-planner'); switchPlannerTab('tab-queue'); return; }
            if (pin.length !== 4) { document.getElementById('login-error').textContent = i18n[state.language].pin_error; return; }
            let user = (pin === '1234') ? { user_pin: pin, name_zh: 'é˜®æ°ç¾', name_vn: 'Nguyá»…n Thá»‹ Má»¹', language: 'vn' } : 
                       (pin === '5678') ? { user_pin: pin, name_zh: 'é™³ç¶“ç†', name_vn: 'Tráº§n Quáº£n LÃ½', language: 'zh' } : null;
            if (!user) { document.getElementById('login-error').textContent = i18n[state.language].pin_error; return; }
            state.currentUser = user; state.language = user.language; updateUI(); showScreen('screen-queue');
        }

        function loadQueue() {
            // å®‰å…¨è®€å–
            const storedQueue = localStorage.getItem('mes_lite_queue');
            if (storedQueue) {
                 try { appQueue = JSON.parse(storedQueue); } catch(e) { appQueue = []; }
            }

            const masterWOs = [...new Set(appQueue.map(item => item.master_wo_id))];
            const select = document.getElementById('master-wo-select');
            const currentSelection = select.value;
            select.innerHTML = `<option value="ALL">${state.language === 'vn' ? 'Táº¥t cáº£' : 'å…¨éƒ¨é¡¯ç¤º'}</option>`;
            masterWOs.forEach(mwo => {
                const option = document.createElement('option');
                option.value = mwo; option.textContent = mwo; select.appendChild(option);
            });
            if (masterWOs.includes(currentSelection)) select.value = currentSelection;
            filterQueue();
        }

        function filterQueue() {
            const selected = document.getElementById('master-wo-select').value;
            const list = document.getElementById('queue-list-container');
            list.innerHTML = '';
            
            list.style.display = 'grid';

            const filtered = appQueue.filter(job => selected === 'ALL' || job.master_wo_id === selected);
            
            if (filtered.length > 0) {
                const html = filtered.map(job => {
                    const prod = state.language === 'vn' ? job.product_name_vn : job.product_name_zh;
                    const op = state.language === 'vn' ? job.operation_name_vn : job.operation_name_zh;
                    const isActive = state.activeSessions[job.wo_id] !== undefined;
                    const activeClass = isActive ? 'active-job' : '';
                    const badge = isActive ? `<div class="status-badge">${i18n[state.language].running_status}</div>` : '';
                    
                    const safeWoId = escapeHtml(job.wo_id);
                    const safeOp = escapeHtml(op);
                    
                    return `<div class="queue-item ${activeClass}" onclick="selectJob('${safeWoId}', '${safeOp}')">
                        <span class="q-num">Q${job.queue_rank}</span>
                        <div style="flex-grow:1;">
                            <span class="main-lang">${escapeHtml(prod)}</span>
                            <span class="aux-lang">${safeOp}</span>
                        </div>
                        <div class="wo-details">å–®è™Ÿ: ${escapeHtml(job.master_wo_id)}</div>
                        <div class="wo-details" style="color:#b2dfdb;">å·¥æ™‚: ${job.standard_time_hr} Hr | ç‹€æ…‹: ${isActive ? 'é€²è¡Œä¸­' : 'å¾…è¾¦'}</div>
                        ${badge}</div>`;
                }).join('');
                
                list.innerHTML = html;
            } else { 
                list.innerHTML = `<div class="empty-message">${i18n[state.language].no_job_in_queue}</div>`;
                list.style.display = 'block';
            }
            // æ›´æ–°æ™‚é–“æˆ³è¨˜
            const timeEl = document.getElementById('last-update-time');
            if(timeEl) timeEl.textContent = "Updated: " + new Date().toLocaleTimeString();
        }

        function selectJob(woId, operationName) {
            state.currentViewingWoId = woId; state.currentWoOperationName = operationName;
            
            if (state.activeSessions[woId]) {
                const session = state.activeSessions[woId];
                state.currentManpower = session.manpower;
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('working-woid').textContent = woId;
                document.getElementById('manpower-display').textContent = session.manpower;
                saveAll(); 
                showScreen('screen-working'); updateTimer();
            } else {
                state.currentTypedValue = '0';
                document.getElementById('manpower-woid').textContent = woId;
                document.getElementById('manpower-input-display').textContent = '0';
                renderKeypad('manpower-keypad-container', 'MANPOWER_INPUT');
                showScreen('screen-manpower');
            }
        }

        function adjustManpower() {
            state.currentTypedValue = '0';
            document.getElementById('manpower-woid').textContent = state.currentViewingWoId;
            document.getElementById('manpower-input-display').textContent = '0';
            renderKeypad('manpower-keypad-container', 'MANPOWER_INPUT');
            showScreen('screen-manpower');
        }

        function confirmManpower(value) {
            if (value <= 0) { alert(i18n[state.language].manpower_error); return; }
            if (state.activeSessions[state.currentViewingWoId]) {
                const session = state.activeSessions[state.currentViewingWoId];
                const now = Date.now();
                session.accumulatedManHours = (session.accumulatedManHours || 0) + ((now - session.lastUpdateTime) / 3600000.0) * session.manpower;
                session.lastUpdateTime = now; session.manpower = value;
                state.currentManpower = value;
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('working-woid').textContent = state.currentViewingWoId;
                document.getElementById('manpower-display').textContent = state.currentManpower;
                saveAll(); 
                showScreen('screen-working');
            } else {
                state.currentManpower = value;
                startJobSession();
            }
        }

        function startJobSession() {
            const now = Date.now();
            state.activeSessions[state.currentViewingWoId] = {
                startTime: now, lastUpdateTime: now, startTimeISO: new Date(now).toISOString(),
                manpower: state.currentManpower, operationName: state.currentWoOperationName, accumulatedManHours: 0
            };
            saveAll(); 
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            document.getElementById('working-woid').textContent = state.currentViewingWoId;
            document.getElementById('manpower-display').textContent = state.currentManpower;
            showScreen('screen-working');
        }

        function backToQueue() {
            if (timerInterval) clearInterval(timerInterval);
            state.currentViewingWoId = null; showScreen('screen-queue');
        }

        function updateTimer() {
            const session = state.activeSessions[state.currentViewingWoId];
            if (!session) return;
            const elapsed = Date.now() - session.startTime;
            const seconds = Math.floor(elapsed / 1000);
            const h = String(Math.floor(seconds/3600)).padStart(2,'0');
            const m = String(Math.floor((seconds%3600)/60)).padStart(2,'0');
            const s = String(seconds%60).padStart(2,'0');
            document.getElementById('elapsed-time').textContent = `${h}:${m}:${s}`;
        }

        function endJob() { startFinishFlow(); }

        function startFinishFlow() {
            if (timerInterval) clearInterval(timerInterval);
            state.currentTypedValue = '0';
            document.getElementById('finish-woid').textContent = state.currentViewingWoId;
            const isSlicing = state.currentWoOperationName && state.currentWoOperationName.includes('åˆ†åˆ‡');
            state.finishStep = isSlicing ? 1 : 5;
            document.getElementById('finish-instruction').innerHTML = `<span class="main-lang">${i18n[state.language][isSlicing ? 'finish_step1' : 'finish_step5_good']}</span>`;
            state.finishData = { qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0, qty_good: 0 };
            document.getElementById('qty-input-display').textContent = '0';
            renderKeypad('finish-keypad-container', 'QTY_INPUT');
            showScreen('screen-finish');
        }

        function processFinishStep(value) {
            const instruction = document.getElementById('finish-instruction');
            const lang = state.language;
            if (state.finishStep >= 1 && state.finishStep <= 4) {
                if (state.finishStep === 1) { state.finishData.qty_reject = value; state.finishStep = 2; instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step2}</span>`; }
                else if (state.finishStep === 2) { state.finishData.actual_collar_qty = value; state.finishStep = 3; instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step3}</span>`; }
                else if (state.finishStep === 3) { state.finishData.actual_tail_qty = value; state.finishStep = 4; instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step4}</span>`; }
                else if (state.finishStep === 4) { state.finishData.qty_good = value; state.finishStep = 7; showSummary(); return; }
            } else if (state.finishStep === 5) {
                state.finishData.qty_good = value; state.finishStep = 6; instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step5_reject}</span>`;
            } else if (state.finishStep === 6) {
                state.finishData.qty_reject = value; state.finishStep = 7; showSummary(); return;
            }
            if (state.finishStep !== 7) { state.currentTypedValue = '0'; document.getElementById('qty-input-display').textContent = '0'; }
        }

        function showSummary() {
            const instruction = document.getElementById('finish-instruction');
            const lang = state.language;
            let summaryHTML = `<div style="font-size:0.9rem; text-align:left; line-height:1.5; padding:10px; background:#112233; border-radius:10px;">
                ${i18n[lang].confirm_summary_title}<br>
                ----------------<br>
                ${i18n[lang].finish_step5_good}: <b style="color:#4caf50; font-size:1.2rem;">${state.finishData.qty_good}</b><br>
                ${i18n[lang].finish_step5_reject}: <b style="color:#ff5722; font-size:1.2rem;">${state.finishData.qty_reject}</b><br>`;
            if (state.finishData.actual_collar_qty > 0) {
                summaryHTML += `ä¸‹å·´: <b>${state.finishData.actual_collar_qty}</b> | å°¾æ®µ: <b>${state.finishData.actual_tail_qty}</b><br>`;
            }
            summaryHTML += `----------------<br><span style="color:#00e676; font-weight:bold;">${i18n[lang].confirm_btn_text}</span></div>`;
            instruction.innerHTML = summaryHTML;
            document.getElementById('qty-input-display').textContent = '';
        }

        function handleConfirmKey() {
            if (state.finishStep === 7) confirmFinishWithYields();
        }

        async function confirmFinishWithYields() {
            if (GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') { alert("ğŸš¨ éŒ¯èª¤: è«‹æ›¿æ› GAS URL!"); return; }
            if (state.isSubmitting) return; 
            
            showLoading(); // é¡¯ç¤ºè½‰åœˆåœˆ
            state.isSubmitting = true;
            
            const session = state.activeSessions[state.currentViewingWoId];
            if (!session) { alert("éŒ¯èª¤ï¼šç„¡å·¥å–®è³‡è¨Š"); hideLoading(); state.isSubmitting = false; return; }

            // è¨ˆç®—é‚è¼¯ç§»åˆ° try å…§ (é˜²æ­¢ NaN å´©æ½°)
            try {
                const now = Date.now();
                // é˜²å‘†ï¼šç¢ºä¿æ•¸å€¼æœ‰æ•ˆ
                const lastUpdate = session.lastUpdateTime || now;
                const manpower = session.manpower || 1;
                
                const totalManHours = (session.accumulatedManHours || 0) + ((now - lastUpdate) / 3600000.0) * manpower;
                
                const effectiveDurationMs = (totalManHours / manpower) * 3600000.0;
                // é˜²å‘†ï¼šé¿å… Invalid Date
                const effectiveStartTimeISO = !isNaN(effectiveDurationMs) ? new Date(now - effectiveDurationMs).toISOString() : new Date().toISOString();
    
                const postData = {
                    token: SECURITY_TOKEN, supervisor_pin: state.currentUser.user_pin, operation_name: session.operationName,
                    manpower_count: session.manpower, wo_id: state.currentViewingWoId,
                    start_time: effectiveStartTimeISO, qty_good: state.finishData.qty_good, qty_reject: state.finishData.qty_reject,
                    actual_collar_qty: state.finishData.actual_collar_qty, actual_tail_qty: state.finishData.actual_tail_qty
                };

                const response = await fetch(GAS_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(postData) });
                const data = await response.json();
                
                if (data.success) {
                    completedLogs.push({ ...postData, endTime: new Date().toISOString(), totalManHours: totalManHours });
                    saveLogsToStorage();
                    delete state.activeSessions[state.currentViewingWoId];
                    saveAll();
                    state.currentViewingWoId = null; state.finishData = {}; 
                    showScreen('screen-queue');
                } else { 
                    alert(`æäº¤å¤±æ•—: ${data.message}`); 
                }
            } catch (error) { 
                alert(`${i18n[state.language].api_error}: ${error.message}`); 
                showScreen('screen-queue'); 
            } finally { 
                state.isSubmitting = false; 
                hideLoading(); 
            }
        }

        document.addEventListener('DOMContentLoaded', () => { initApp(); });
    </script>
</body>
</html>