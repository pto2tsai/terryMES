<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MES Lite ç°¡æ˜“å·¥æ™‚æ¡é›†</title>
    <style>
        /* ---------------------------------- */
        /* CSS: éŸ¿æ‡‰å¼æ¥µç°¡é¢¨æ ¼ */
        /* ---------------------------------- */
        :root {
            --bg-color: #0b1a2c;
            --text-color: #ffffff;
            --primary-color: #00bcd4;
            --btn-bg: #1a3449;
            --btn-active: #007bff;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #ff5722;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            text-align: center;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            width: 100%;
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .screen {
            display: none;
            min-height: 90vh; 
            padding-bottom: 50px;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        /* é€šç”¨å¤§æŒ‰éˆ•æ¨£å¼ */
        .large-btn {
            padding: 15px;
            margin: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            background-color: var(--btn-bg);
            color: white;
            transition: all 0.2s;
            line-height: 1.3;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .large-btn:active {
            background-color: var(--btn-active);
            transform: scale(0.98);
        }

        /* ç¦ç”¨æ¨£å¼ */
        .large-btn.disabled {
            background-color: #555;
            border-color: #777;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .large-select {
            width: 95%;
            font-size: 1.5rem;
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--btn-bg);
            color: white;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            appearance: none; /* ç§»é™¤é è¨­ç®­é ­ */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300bcd4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 20px auto;
        }

        /* å·¥å–®åˆ—è¡¨å®¹å™¨ - ç¶²æ ¼ä½ˆå±€ */
        #queue-list-container {
            display: grid;
            gap: 15px;
            padding: 5px;
        }

        .queue-item {
            text-align: left;
            border-color: var(--success-color);
            position: relative;
            padding: 20px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .queue-item.active-job {
            background-color: #1b5e20;
            border-color: #66bb6a;
            border-width: 3px;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #00e676;
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
        }
        
        .queue-item.active-job .status-badge {
            display: block;
        }

        .main-lang {
            font-size: 1.4rem;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .aux-lang {
            font-size: 1rem;
            color: #ccc;
            display: block;
        }

        .pin-display {
            font-size: 3rem;
            letter-spacing: 10px;
            margin: 20px auto;
            height: 60px;
            line-height: 60px;
            border-bottom: 3px dashed var(--primary-color);
            color: #ffd700;
            max-width: 90%;
        }

        .error {
            color: var(--error-color);
            font-size: 1.2rem;
            margin-top: 10px;
            font-weight: bold;
        }

        /* æ•¸å­—éµç›¤ä½ˆå±€ */
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* æ‰‹æ©Ÿé è¨­ 3æ¬„ */
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: 10px auto;
        }

        .btn-confirm {
            background-color: var(--success-color); 
            border-color: var(--success-color);
        }

        .btn-back {
            background-color: #607d8b;
            border-color: #78909c;
        }
        
        .diagnostic-info {
            font-size: 0.7rem;
            color: #7fffd4; 
            margin-top: 10px;
        }
        .url-alert { 
            background-color: #581515; 
            border: 2px solid var(--error-color); 
            padding: 10px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            font-size: 1rem; 
            color: white; 
            text-align: left; 
            font-weight: bold; 
            display: none;
        }

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ (Media Queries) --- */

        /* å¹³æ¿èˆ‡æ¡Œé¢ (å¯¬åº¦å¤§æ–¼ 768px) */
        @media (min-width: 768px) {
            h1 { font-size: 2.5rem; }
            .large-btn { font-size: 1.8rem; padding: 25px; }
            .pin-display { font-size: 4rem; height: 80px; line-height: 80px; }
            
            /* å¹³æ¿æ¨¡å¼ä¸‹ï¼Œå·¥å–®åˆ—è¡¨é¡¯ç¤ºç‚º 2 æ¬„ */
            #queue-list-container {
                grid-template-columns: repeat(2, 1fr); 
            }
            
            /* éµç›¤åœ¨å¹³æ¿ä¸Šæ”¹ç‚º 4 æ¬„ (æ›´å¯¬) æˆ–ä¿æŒ 3 æ¬„ä½†æ›´å¤§ */
            .keypad-grid {
                gap: 15px;
                max-width: 600px;
            }
        }

        /* æ‰‹æ©Ÿç›´å‘ (å¯¬åº¦å°æ–¼ 768px) */
        @media (max-width: 767px) {
            .container { padding: 5px; }
            h1 { font-size: 1.5rem; }
            
            /* æ‰‹æ©Ÿæ¨¡å¼ä¸‹ï¼Œå·¥å–®åˆ—è¡¨ç‚ºå–®æ¬„ */
            #queue-list-container {
                grid-template-columns: 1fr; 
            }
            
            .large-btn {
                padding: 15px;
                font-size: 1.2rem;
                margin: 5px;
            }
            .queue-item {
                min-height: 100px; /* ç¨å¾®ç¸®å°é«˜åº¦ */
            }
            .pin-display {
                font-size: 2.5rem;
                letter-spacing: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- ç•«é¢ 1: ç™»å…¥ -->
        <div id="screen-login" class="screen" style="display: block;">
            <h1>MES LITE ç™»å…¥ ğŸ”’</h1>
            <div style="font-size: 1.2rem; margin-bottom: 20px;">
                <span data-i18n="login_prompt">è«‹è¼¸å…¥æ‚¨çš„ 4 ä½è­˜åˆ¥ç¢¼ (PIN)</span>
            </div>
            
            <div class="pin-display" id="pin-input">****</div>
            
            <div id="login-error" class="error"></div>
            
            <div class="diagnostic-info">
                GAS Webhook URL: <span id="api-base-url-display">N/A</span>
            </div>
            <div id="url-alert-box" class="url-alert">
                ğŸš¨ **é‡è¦!** è«‹å°‡ç¨‹å¼ç¢¼ä¸­çš„ `YOUR_GAS_WEBHOOK_URL` æ›¿æ›ç‚ºæ­¥é©Ÿä¸€ç²å¾—çš„å¯¦éš› URLã€‚
            </div>

             <div id="keypad" class="keypad-grid"></div>
        </div>

        <!-- ç•«é¢ 2: å¾…è¾¦æ’éšŠ -->
        <div id="screen-queue" class="screen">
            <h1 id="queue-title"></h1>
            <div style="font-size: 1rem; color: #00bcd4; margin-bottom: 10px;" data-i18n="select_job_prompt">
                ğŸ‘† è«‹é»æ“Šæ¬²é–‹å§‹çš„å·¥å–® (CHá»ŒN CÃ”NG VIá»†C)
            </div>

            <!-- æ–°å¢ï¼šç¸½å·¥å–®é¸æ“‡ (ä¸‹æ‹‰é¸å–®) -->
            <select id="master-wo-select" class="large-select" onchange="filterQueue()">
                <option value="ALL">å…¨éƒ¨é¡¯ç¤º (Hiá»ƒn thá»‹ táº¥t cáº£)</option>
                <!-- é¸é …å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </select>
            
            <div id="queue-list-container">
                <!-- æ¨¡æ“¬å·¥å–®åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ç•«é¢ 2.5: è¼¸å…¥äººæ•¸ -->
        <div id="screen-manpower" class="screen">
            <h1 style="color: #ffd700;" data-i18n="manpower_input_title">è¼¸å…¥äººæ•¸ (NHáº¬P Sá» NGÆ¯á»œI)</h1>
            <div style="font-size: 1.2rem;">
                <span data-i18n="working_wo">å·¥å–®</span>: <span id="manpower-woid" style="font-weight: bold; color: #00bcd4;"></span>
            </div>

            <div style="margin: 20px auto; max-width: 400px;">
                <div class="pin-display" id="manpower-input-display" style="letter-spacing: normal; color: #ffd700;">0</div>
            </div>
            
            <div id="manpower-keypad-container" class="keypad-grid"></div>
        </div>

        <!-- ç•«é¢ 3: æ­£åœ¨è¨ˆæ™‚ -->
        <div id="screen-working" class="screen">
            <h1 class="working-status">ğŸŸ¢ <span data-i18n="working_in_progress">æ­£åœ¨é€²è¡Œä¸­</span></h1>
            <div style="font-size: 1.5rem; margin-top: 10px;">
                <span data-i18n="working_wo">å·¥å–®</span>: <span id="working-woid" style="font-weight: bold;"></span>
            </div>
            <div style="font-size: 2.5rem; color: #ffd700; margin: 20px 0;">
                <span data-i18n="manpower_count">äººæ•¸</span>: <span id="manpower-display">4</span>
            </div>
            <div style="font-size: 3.5rem; color: #00bcd4;">
                <span data-i18n="elapsed_time">å·²è€—æ™‚</span>: <span id="elapsed-time">00:00:00</span>
            </div>
            <div style="margin-top: 30px; display: flex; flex-direction: column; align-items: center;">
                <button class="large-btn btn-back" style="width: 90%; margin-bottom: 15px;" onclick="backToQueue()">
                    <span data-i18n="btn_back_list">â¬… æš«é›¢ / è¿”å›åˆ—è¡¨</span> (Quay láº¡i)
                </button>

                <button class="large-btn btn-confirm" style="background-color: orange; width: 90%; font-size: 1.8rem;" onclick="endJob()">
                    <span data-i18n="btn_finish">å®Œæˆå·¥å–®</span> (HOÃ€N THÃ€NH)
                </button>
            </div>
        </div>

        <!-- ç•«é¢ 4: æ•¸é‡è¼¸å…¥ -->
        <div id="screen-finish" class="screen">
            <h1 style="color: #ff9800;" data-i18n="finish_prompt">æ­¥é©Ÿ 4: è¼¸å…¥æ•¸é‡ (NHáº¬P Sá» LÆ¯á»¢NG)</h1>
            <div style="font-size: 1.2rem;">
                <span data-i18n="finish_wo">å·¥å–®</span>: <span id="finish-woid" style="font-weight: bold; color: #ffd700;"></span>
            </div>

            <div style="margin: 10px auto; max-width: 400px;">
                <div id="finish-instruction" style="font-size: 1.5rem; color: #00bcd4; margin-bottom: 10px; min-height: 40px;">
                    <!-- é€™è£¡æ˜¯å‹•æ…‹æŒ‡ä»¤ -->
                </div>
                
                <div class="pin-display" id="qty-input-display" style="letter-spacing: normal; color: #ffd700;">0</div>
            </div>
            
            <div id="finish-keypad-container" class="keypad-grid"></div>
        </div>
    </div>

    <script>
        // ----------------------------------
        // JAVASCRIPT: é‚è¼¯èˆ‡ GAS Webhook æºé€š
        // ----------------------------------

        // ğŸš¨ é—œéµï¼šè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„ Google Apps Script Webhook URL
        const GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbyP9sYjwQ3pM7MMkrbiWTaUKmIeUcWhtWzPEqyhBlpHds7NfK6I49TTbEg4DWGsutBytA/exec'; 
        const SECURITY_TOKEN = "MES_LITE_2025"; 
        
        let state = {
            currentScreen: 'login',
            currentPIN: '',
            currentUser: null,
            language: 'zh',
            activeSessions: {}, 
            currentViewingWoId: null,
            currentWoOperationName: null, 
            currentManpower: 0, 
            finishStep: 0, 
            finishData: { qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0, qty_good: 0 },
            currentTypedValue: '0',
            startTimeISO: null,
            isSubmitting: false 
        };

        let timerInterval = null;

        // æ¨¡æ“¬çš„å·¥å–®æ•¸æ“š (åŒ…å«ç¸½å·¥å–® ID ä»¥ä¾›ç¯©é¸)
        const mockQueue = [
            { wo_id: 'WC001-Q1', master_wo_id: 'MWO-A', product_name_zh: 'é®­é­šåˆ†åˆ‡æ‰¹æ¬¡', product_name_vn: 'CÃ¡ há»“i lÃ´ A', operation_name_zh: 'åˆ†åˆ‡/åˆ†æ–™', operation_name_vn: 'Cáº¯t lÃ¡t', queue_rank: 1, standard_time_hr: 1.2 },
            { wo_id: 'WC001-Q3', master_wo_id: 'MWO-A', product_name_zh: 'ä¸­æ®µåšåˆ‡', product_name_vn: 'LÃ¡t giá»¯a dÃ y', operation_name_zh: 'é‡é‡é¸åˆ¥', operation_name_vn: 'PhÃ¢n loáº¡i', queue_rank: 3, standard_time_hr: 0.3 },
            { wo_id: 'WC002-Q1', master_wo_id: 'MWO-B', product_name_zh: 'é®ªé­šåˆ†å¡Š', product_name_vn: 'CÃ¡ ngá»« cáº¯t khá»‘i', operation_name_zh: 'çœŸç©ºåŒ…è£', operation_name_vn: 'ÄÃ³ng gÃ³i HK', queue_rank: 5, standard_time_hr: 0.8 },
            { wo_id: 'WC003-Q2', master_wo_id: 'MWO-C', product_name_zh: 'è¦ä»åŠ å·¥', product_name_vn: 'TÃ´m cháº¿ biáº¿n', operation_name_zh: 'å‰æ®¼', operation_name_vn: 'BÃ³c vá»', queue_rank: 2, standard_time_hr: 0.5 }
        ];

        // é›™èªå­—å…¸
        const i18n = {
            zh: {
                login_prompt: 'è«‹è¼¸å…¥ 4 ä½è­˜åˆ¥ç¢¼ (PIN)', pin_error: 'PIN ç¢¼éŒ¯èª¤ï¼', select_job_prompt: 'ğŸ‘† è«‹é»æ“Šæ¬²é–‹å§‹çš„å·¥å–®', job_start_error: 'å·¥å–®å•Ÿå‹•å¤±æ•—!', working_wo: 'å·¥å–®', manpower_count: 'äººæ•¸', elapsed_time: 'å·²è€—æ™‚', working_in_progress: 'æ­£åœ¨é€²è¡Œä¸­', 
                manpower_input_title: 'æ­¥é©Ÿ 2: è¼¸å…¥äººæ•¸', manpower_error: 'äººæ•¸å¿…é ˆå¤§æ–¼ 0',
                finish_prompt: 'æ­¥é©Ÿ 4: è¼¸å…¥æ•¸é‡', finish_wo: 'å·¥å–®', finish_step1: 'âŒ ä¸è‰¯å“/æè€—é‡é‡ (KG)', finish_step2: 'ä¸‹å·´é‡é‡ (KG)', finish_step3: 'å°¾æ®µé‡é‡ (KG)', finish_step4: 'âœ… ä¸­å¾Œæ®µç¸½é‡ (KG)', finish_step5_good: 'âœ… è‰¯å“æ•¸é‡ (PCS/KG)', finish_step5_reject: 'âŒ ä¸è‰¯å“æ•¸é‡ (PCS/KG)', btn_finish: 'å®Œæˆå·¥å–®', btn_confirm_submit: 'ç¢ºèªæäº¤', missing_data: 'æ•¸æ“šä¸å®Œæ•´', api_error: 'é€£ç·šéŒ¯èª¤', no_job_in_queue: 'ç›®å‰æ²’æœ‰å¾…è¾¦å·¥å–®', btn_back_list: 'â¬… æš«é›¢ / è¿”å›åˆ—è¡¨', running_status: 'é€²è¡Œä¸­'
            },
            vn: {
                login_prompt: 'NHáº¬P MÃƒ Äá»ŠNH DANH (PIN)', pin_error: 'MÃ£ PIN sai!', select_job_prompt: 'ğŸ‘† CHá»ŒN CÃ”NG VIá»†C', job_start_error: 'Lá»—i báº¯t Ä‘áº§u!', working_wo: 'ÄÆ¡n hÃ ng', manpower_count: 'Sá»‘ ngÆ°á»i', elapsed_time: 'ÄÃ£ cháº¡y giá»', working_in_progress: 'ÄANG THá»°C HIá»†N', 
                manpower_input_title: 'BÆ¯á»šC 2: NHáº¬P Sá» NGÆ¯á»œI', manpower_error: 'Sá»‘ ngÆ°á»i > 0',
                finish_prompt: 'BÆ¯á»šC 4: NHáº¬P Sá» LÆ¯á»¢NG', finish_wo: 'ÄÆ¡n hÃ ng', finish_step1: 'âŒ Sá» CÃ‚N Náº¶NG Há»NG (KG)', finish_step2: 'Sá» CÃ‚N Náº¶NG Cáº°M (KG)', finish_step3: 'Sá» CÃ‚N Náº¶NG ÄUÃ”I (KG)', finish_step4: 'âœ… Tá»”NG CÃ‚N Náº¶NG GIá»®A/SAU (KG)', finish_step5_good: 'âœ… Sá»‘ lÆ°á»£ng tá»‘t (PCS/KG)', finish_step5_reject: 'âŒ Sá»‘ lÆ°á»£ng há»ng (PCS/KG)', btn_finish: 'HoÃ n thÃ nh', btn_confirm_submit: 'XÃC NHáº¬N Gá»¬I', missing_data: 'Thiáº¿u dá»¯ liá»‡u', api_error: 'Lá»—i káº¿t ná»‘i', no_job_in_queue: 'KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng', btn_back_list: 'â¬… Quay láº¡i', running_status: 'Running'
            }
        };

        // --- UI Functions ---

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            state.currentScreen = screenId.replace('screen-', '');
            
            if (state.currentScreen === 'login') {
                renderKeypad('keypad', 'PIN');
                state.currentPIN = '';
            } else if (state.currentScreen === 'queue') {
                loadQueue();
            }
        }

        function updateUI() {
            const currentLang = state.language;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang] && i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
            });

            if (state.currentUser) {
                const greeting = currentLang === 'vn' ? `ChÃ o Ã”ng ${state.currentUser.name_vn}!` : `æ‚¨å¥½ï¼Œ${state.currentUser.name_zh}ä¸»ç®¡!`;
                document.getElementById('queue-title').textContent = greeting;
            }
        }

        // --- Keypad Functions ---
        function renderKeypad(targetElementId, targetInputType) {
            state.inputTarget = targetInputType;
            const layout = ['7', '8', '9', 'C', '4', '5', '6', '0', '1', '2', '3', 'OK'];
            const keypadDiv = document.getElementById(targetElementId);
            keypadDiv.innerHTML = '';
            
            layout.forEach(key => {
                const btn = document.createElement('div');
                btn.className = 'large-btn';
                if (key === 'OK') btn.className += ' btn-confirm';
                btn.textContent = key;
                // é©æ‡‰æ–°çš„ grid ä½ˆå±€ï¼ŒæŒ‰éˆ•æœ¬èº«ä¸éœ€è¦å›ºå®šå¯¬åº¦
                btn.style.width = '100%'; 
                btn.onclick = () => handleKeypadInput(key);
                keypadDiv.appendChild(btn);
            });
        }

        function handleKeypadInput(key) {
            if (state.isSubmitting && key === 'OK') return;

            let displayElementId;
            let currentInput;

            if (state.currentScreen === 'login') {
                displayElementId = 'pin-input';
                currentInput = state.currentPIN;
            } else if (state.currentScreen === 'manpower') { 
                displayElementId = 'manpower-input-display';
                currentInput = state.currentTypedValue;
            } else { 
                displayElementId = 'qty-input-display';
                currentInput = state.currentTypedValue;
            }
            
            document.getElementById('login-error').textContent = ''; 

            if (key >= '0' && key <= '9') {
                if (currentInput.length < 8) {
                    currentInput = (currentInput === '0' || currentInput === '') ? key : currentInput + key;
                }
            } else if (key === 'C') {
                currentInput = '0';
            } else if (key === 'OK') {
                if (state.currentScreen === 'login') {
                    validateLogin(currentInput);
                } else if (state.currentScreen === 'manpower') { 
                    confirmManpower(parseInt(currentInput));
                } else if (state.currentScreen === 'finish') {
                    processFinishStep(parseFloat(currentInput));
                }
                return;
            }
            
            if (state.currentScreen === 'login') {
                state.currentPIN = currentInput;
                document.getElementById(displayElementId).textContent = currentInput.padEnd(4, '*').replace(/./g, '*').substring(0, 4);
            } else {
                state.currentTypedValue = currentInput;
                document.getElementById(displayElementId).textContent = currentInput;
            }
        }

        // --- Logic ---

        function validateLogin(pin) {
            if (pin.length !== 4) {
                 document.getElementById('login-error').textContent = i18n[state.language].pin_error;
                 return;
            }
            let user;
            if (pin === '1234') {
                 user = { user_pin: pin, name_zh: 'é˜®æ°ç¾', name_vn: 'Nguyá»…n Thá»‹ Má»¹', language: 'vn' };
            } else if (pin === '5678') {
                 user = { user_pin: pin, name_zh: 'é™³ç¶“ç†', name_vn: 'Tráº§n Quáº£n LÃ½', language: 'zh' };
            } else {
                 document.getElementById('login-error').textContent = i18n[state.language].pin_error;
                 return;
            }
            state.currentUser = user;
            state.language = user.language; 
            updateUI();
            showScreen('screen-queue');
        }

        function loadQueue() {
            // 1. æå–æ‰€æœ‰ç¸½å·¥å–® ID è£½ä½œä¸‹æ‹‰é¸å–®
            const masterWOs = [...new Set(mockQueue.map(item => item.master_wo_id))];
            const select = document.getElementById('master-wo-select');
            
            // ä¿å­˜ç•¶å‰é¸æ“‡ (é˜²æ­¢åˆ·æ–°å¾Œé‡ç½®)
            const currentSelection = select.value;
            
            // æ¸…ç©ºä¸¦é‡å»ºé¸é …
            select.innerHTML = `<option value="ALL">${state.language === 'vn' ? 'Táº¥t cáº£ (å…¨éƒ¨)' : 'å…¨éƒ¨é¡¯ç¤º'}</option>`;
            masterWOs.forEach(mwo => {
                const option = document.createElement('option');
                option.value = mwo;
                option.textContent = mwo;
                select.appendChild(option);
            });

            // æ¢å¾©é¸æ“‡ (å¦‚æœé‚„å­˜åœ¨)
            if (masterWOs.includes(currentSelection)) {
                select.value = currentSelection;
            }

            // 2. åŸ·è¡Œéæ¿¾èˆ‡æ¸²æŸ“
            filterQueue();
        }

        // æ–°å¢ï¼šå·¥å–®éæ¿¾åŠŸèƒ½
        function filterQueue() {
            const selectedMasterWO = document.getElementById('master-wo-select').value;
            const listContainer = document.getElementById('queue-list-container');
            listContainer.innerHTML = '';

            // æ ¹æ“šä¸‹æ‹‰é¸å–®ç¯©é¸
            const filteredQueue = mockQueue.filter(job => {
                return selectedMasterWO === 'ALL' || job.master_wo_id === selectedMasterWO;
            });
            
            if (filteredQueue.length > 0) {
                filteredQueue.forEach(job => {
                    const prodName = state.language === 'vn' ? 
                        `${job.product_name_vn} (${job.product_name_zh})` : 
                        `${job.product_name_zh} (${job.product_name_vn})`;
                    const opName = job.operation_name_zh || "æœªçŸ¥å·¥åº"; 
                    
                    const isActive = state.activeSessions[job.wo_id] !== undefined;
                    const activeClass = isActive ? 'active-job' : '';
                    const badge = isActive ? `<div class="status-badge">${i18n[state.language].running_status}</div>` : '';

                    const html = `
                        <div class="large-btn queue-item ${activeClass}" onclick="selectJob('${job.wo_id}', '${opName}')">
                            <div style="font-size: 0.8em; color: #aaa; margin-bottom: 5px;">${job.master_wo_id}</div>
                            <span class="q-num">Q${job.queue_rank}</span>
                            <span class="main-lang">${prodName}</span>
                            <span class="aux-lang">${opName}</span>
                            ${badge}
                        </div>
                    `;
                    listContainer.innerHTML += html;
                });
            } else {
                 listContainer.innerHTML = `<p style="font-size:1.2em; color: #ccc; grid-column: 1 / -1;">${i18n[state.language].no_job_in_queue}</p>`;
            }
        }

        function selectJob(woId, operationName) {
            state.currentViewingWoId = woId; 
            state.currentWoOperationName = operationName; 
            
            if (state.activeSessions[woId]) {
                const session = state.activeSessions[woId];
                state.currentManpower = session.manpower;
                
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                
                document.getElementById('working-woid').textContent = woId;
                document.getElementById('manpower-display').textContent = session.manpower;
                
                showScreen('screen-working');
                updateTimer(); 
            } else {
                state.currentTypedValue = '0';
                document.getElementById('manpower-woid').textContent = woId;
                document.getElementById('manpower-input-display').textContent = '0';
                
                renderKeypad('manpower-keypad-container', 'MANPOWER_INPUT');
                showScreen('screen-manpower'); 
            }
        }

        function confirmManpower(value) {
            if (value <= 0) {
                alert(i18n[state.language].manpower_error);
                return;
            }
            state.currentManpower = value;
            startJobSession();
        }

        function startJobSession() {
            const now = Date.now();
            state.activeSessions[state.currentViewingWoId] = {
                startTime: now,
                startTimeISO: new Date(now).toISOString(),
                manpower: state.currentManpower,
                operationName: state.currentWoOperationName
            };

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            document.getElementById('working-woid').textContent = state.currentViewingWoId;
            document.getElementById('manpower-display').textContent = state.currentManpower;

            showScreen('screen-working');
        }

        function backToQueue() {
            if (timerInterval) clearInterval(timerInterval);
            state.currentViewingWoId = null; 
            showScreen('screen-queue');
        }

        function updateTimer() {
            const session = state.activeSessions[state.currentViewingWoId];
            if (!session) return;

            const elapsed = Date.now() - session.startTime;
            const seconds = Math.floor(elapsed / 1000);
            const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const remainingSeconds = String(seconds % 60).padStart(2, '0');
            
            document.getElementById('elapsed-time').textContent = `${hours}:${minutes}:${remainingSeconds}`;
        }

        function endJob() {
            startFinishFlow();
        }

        function startFinishFlow() {
            if (timerInterval) clearInterval(timerInterval);
            state.currentTypedValue = '0';
            document.getElementById('finish-woid').textContent = state.currentViewingWoId;
            
            const isSlicing = state.currentWoOperationName && state.currentWoOperationName.includes('åˆ†åˆ‡');

            if (isSlicing) {
                state.finishStep = 1; 
                document.getElementById('finish-instruction').innerHTML = `<span class="main-lang">${i18n[state.language].finish_step1}</span>`;
            } else {
                state.finishStep = 5; 
                document.getElementById('finish-instruction').innerHTML = `<span class="main-lang">${i18n[state.language].finish_step5_good}</span>`;
            }
            
            state.finishData = { qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0, qty_good: 0 };
            document.getElementById('qty-input-display').textContent = '0';

            renderKeypad('finish-keypad-container', 'QTY_INPUT');
            showScreen('screen-finish');
        }

        function processFinishStep(value) {
            const instruction = document.getElementById('finish-instruction');
            const lang = state.language;

            if (state.finishStep >= 1 && state.finishStep <= 4) {
                if (state.finishStep === 1) { 
                    state.finishData.qty_reject = value;
                    state.finishStep = 2;
                    instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step2}</span>`;
                } else if (state.finishStep === 2) { 
                    state.finishData.actual_collar_qty = value;
                    state.finishStep = 3;
                    instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step3}</span>`;
                } else if (state.finishStep === 3) { 
                    state.finishData.actual_tail_qty = value;
                    state.finishStep = 4;
                    instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step4}</span>`;
                } else if (state.finishStep === 4) { 
                    state.finishData.qty_good = value;
                    confirmFinishWithYields();
                    return;
                }
            } else if (state.finishStep === 5) { 
                state.finishData.qty_good = value;
                state.finishStep = 6;
                instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step5_reject}</span>`;
            } else if (state.finishStep === 6) { 
                 state.finishData.qty_reject = value;
                 confirmFinishWithYields(); 
                 return;
            }
            
            state.currentTypedValue = '0';
            document.getElementById('qty-input-display').textContent = '0';
        }

        async function confirmFinishWithYields() {
            if (GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') {
                alert("ğŸš¨ éŒ¯èª¤: è«‹å…ˆæ›¿æ›ç¨‹å¼ç¢¼ä¸­çš„ GAS Webhook URL!");
                return;
            }

            if (state.isSubmitting) return; 
            state.isSubmitting = true;
            
            const session = state.activeSessions[state.currentViewingWoId];
            if (!session) {
                alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å·¥å–®è³‡è¨Š");
                state.isSubmitting = false;
                return;
            }

            const postData = {
                token: SECURITY_TOKEN,
                supervisor_pin: state.currentUser.user_pin,
                operation_name: session.operationName,
                manpower_count: session.manpower,
                wo_id: state.currentViewingWoId,
                start_time: session.startTimeISO, 
                qty_good: state.finishData.qty_good,
                qty_reject: state.finishData.qty_reject,
                actual_collar_qty: state.finishData.actual_collar_qty, 
                actual_tail_qty: state.finishData.actual_tail_qty     
            };
            
            try {
                const response = await fetch(GAS_WEBHOOK_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(postData)
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`${i18n[state.language].btn_confirm_submit} æˆåŠŸ! ${data.message}`);
                } else {
                    alert(`æäº¤å¤±æ•—: ${data.message}`);
                }
                
                delete state.activeSessions[state.currentViewingWoId];
                state.currentViewingWoId = null;
                
                state.finishData = {};
                showScreen('screen-queue');

            } catch (error) {
                alert(`${i18n[state.language].api_error}: ${error.message}`);
                showScreen('screen-queue'); 
            } finally {
                state.isSubmitting = false; 
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('api-base-url-display').textContent = GAS_WEBHOOK_URL; 
            if (GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') {
                document.getElementById('url-alert-box').style.display = 'block';
            }
            renderKeypad('keypad', 'PIN'); 
            updateUI();
        });
    </script>
</body>
</html>