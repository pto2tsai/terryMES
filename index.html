<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MES Lite V6.3 Config Fix</title>
    <style>
        /* ---------------------------------- */
        /* CSS: V6.3 è¨­å®šä¿®å¾©ç‰ˆ */
        /* ---------------------------------- */
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --primary: #2196f3; --accent: #00bcd4; --success: #4caf50; --warning: #ff9800; --danger: #f44336;
            --nav-height: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; flex-direction: row; overflow: hidden; }
        
        .nav-bar { width: var(--nav-width); height: 100vh; background-color: #000; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 1000; border-right: 1px solid #333; flex-shrink: 0; }
        .nav-btn { background: none; border: none; cursor: pointer; padding: 15px 5px; margin-bottom: 20px; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; gap: 5px; width: 100%; }
        .nav-btn svg { width: 32px; height: 32px; fill: currentColor; }
        .nav-btn span { font-size: 0.75rem; font-weight: bold; }
        .nav-btn:active { color: var(--accent); background: #222; }
        .version-tag { font-size: 0.6rem; color: #444; margin-top: auto; margin-bottom: 10px; writing-mode: vertical-lr; }

        .container { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .screen { display: none; width: 100%; max-width: 600px; padding-bottom: 20px; }
        
        .pin-display { font-size: 3rem; letter-spacing: 10px; color: var(--accent); margin-bottom: 20px; height: 60px; line-height: 60px; text-align: center; border-bottom: 2px solid #333; width: 100%; }
        .circle-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 0 auto 20px auto; width: 100%; max-width: 350px; }
        .circle-btn { width: 80px; height: 80px; border-radius: 50%; background-color: #2a2a2a; color: white; font-size: 2rem; font-weight: bold; border: 2px solid #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto; }
        .circle-btn:active { background-color: #555; border-color: #888; transform: translateY(2px); }
        .circle-btn.ok { background-color: var(--success); color: #000; }
        .circle-btn.clear { color: var(--danger); }

        .large-btn { width: 100%; padding: 15px; margin: 8px 0; font-size: 1.3rem; font-weight: bold; border-radius: 10px; border: none; cursor: pointer; color: white; background-color: var(--bg-card); box-shadow: 0 4px 0 rgba(0,0,0,0.5); position: relative; }
        .large-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-confirm { background-color: var(--success); color: #000; }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: #424242; border: 1px solid #555; }

        .queue-item { background: #1e1e1e; border: 1px solid #444; border-left: 6px solid #444; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .queue-item.active-job { background: #1b5e20; border-color: #66bb6a; border-left-color: #00e676; }
        .q-info h3 { margin: 0 0 5px 0; font-size: 1.3rem; color: white; }
        .q-info p { margin: 0; color: #bbb; font-size: 1rem; }

        .admin-dashboard-layout { display: flex; flex-direction: column; gap: 20px; height: 100%; }
        .admin-panel { background-color: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid #333; flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .admin-input { width: 100%; padding: 12px 15px; background: #2b2b2b; border: 1px solid #555; color: white; font-size: 1.1rem; border-radius: 6px; margin-bottom: 10px;}
        .sub-items-wrapper { flex: 1; overflow-y: auto; margin: 15px 0; min-height: 150px; border: 1px dashed #444; padding: 10px; border-radius: 8px; }
        .sub-item-row { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 10px; margin-bottom: 8px; }
        .btn-row-delete { background: #333; border: 1px solid #555; color: #ff5252; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .template-area { background: #151515; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border-left: 4px solid var(--primary); }
        .template-select { flex: 1; }
        .admin-actions { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-top: auto; padding-top: 10px;}

        /* Modal */
        #config-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; justify-content: center; padding: 20px; }
        .config-box { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #555; max-width: 500px; margin: 0 auto; width: 100%; }
        .config-input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #555; color: #00e676; font-family: monospace; font-size: 0.9rem; }

        /* Loading */
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (min-width: 769px) {
            .container { max-width: 1200px; margin: 20px 0; height: 95vh; border-radius: 20px; padding-left: 80px; width: 100%; background-color: var(--bg-card); box-shadow: 0 0 30px rgba(0,0,0,0.8); }
            .nav-bar { position: absolute; left: 0; top: 0; height: 100%; width: 80px; border-radius: 20px 0 0 20px; }
            .admin-dashboard-layout { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; height: 100%; overflow: hidden; }
            .login-box, #screen-queue, #screen-manpower, #screen-working, #screen-finish { max-width: 600px; margin: 0 auto; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login -->
        <div id="screen-login" class="screen" style="display: block;">
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                <h2 style="color:var(--accent); letter-spacing:2px;">MES LITE <span style="font-size:0.8rem; color:#555;">V6.3</span></h2>
                <div style="color:#888; margin-bottom: 10px;">è«‹è¼¸å…¥è­˜åˆ¥ç¢¼ / ENTER PIN</div>
                <div id="pin-display" class="pin-display">_ _ _ _</div>
                <div id="login-msg" style="color: var(--danger); height: 20px; margin-bottom:10px;"></div>
                <div id="login-keypad"></div>
                <div style="margin-top:20px; font-size:0.8rem; color:#444;">Status: <span id="cloud-status">Init...</span></div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="testConnection()" style="background:none; border:1px solid #444; color:#888; border-radius:4px; padding:5px 10px; cursor:pointer;">â˜ï¸ æ¸¬è©¦é€£ç·š (Open URL)</button>
                    <button onclick="openConfig()" style="background:none; border:1px solid #444; color:var(--primary); border-radius:4px; padding:5px 10px; cursor:pointer;">âš™ï¸ è¨­å®šç¶²å€</button>
                </div>
            </div>
        </div>

        <!-- Config Modal -->
        <div id="config-modal">
            <div class="config-box">
                <h3>âš™ï¸ è¨­å®šå¾Œç«¯ç¶²å€</h3>
                <p style="font-size:0.8rem; color:#aaa;">è«‹è²¼ä¸Š Google Apps Script éƒ¨ç½²ç¶²å€ (ä»¥ /exec çµå°¾)</p>
                <textarea id="config-url-input" class="config-input" rows="3"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="large-btn btn-secondary" onclick="closeConfig()">å–æ¶ˆ</button>
                    <button class="large-btn btn-confirm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜ä¸¦æ¸¬è©¦</button>
                </div>
            </div>
        </div>

        <!-- Queue -->
        <div id="screen-queue" class="screen">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2 style="margin:0; color:var(--primary);">ğŸ“‹ å¾…è¾¦å·¥å–®</h2>
                <div style="color:var(--accent); font-weight:bold;"><span id="user-name">User</span></div>
            </div>
            <div class="cloud-status" id="last-sync-time" style="color:#666; font-size:0.8rem; margin-bottom:5px;"></div>
            <div id="active-section" style="margin-bottom:20px; display:none;">
                <div style="font-size:0.9rem; color:var(--success); margin-bottom:5px; font-weight:bold;">ğŸ”¥ é€²è¡Œä¸­</div>
                <div id="active-list"></div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div style="font-size:0.9rem; color:#888;">å¾…è¾¦äº‹é …</div>
                <button onclick="syncData()" style="background:none; border:1px solid #555; color:#888; border-radius:4px; padding:4px 8px; font-size:0.8rem;">ğŸ”„ åŒæ­¥</button>
            </div>
            <div id="queue-list"></div>
        </div>

        <!-- Manpower -->
        <div id="screen-manpower" class="screen">
            <h2 id="manpower-title" style="text-align:center; color:var(--accent);">ğŸ‘¥ é–‹å·¥è¨­å®š</h2>
            <div id="manpower-display" class="pin-display">0</div>
            <div id="manpower-keypad"></div>
            <button class="large-btn btn-secondary" onclick="showScreen('queue')">å–æ¶ˆ</button>
        </div>

        <!-- Working -->
        <div id="screen-working" class="screen" style="display:flex; flex-direction:column;">
            <div style="background:#222; padding:15px; border-radius:15px; text-align:center; border:1px solid #444; margin-bottom:10px;">
                <h2 id="work-prod" style="margin:10px 0; font-size:1.8rem; color:white;">Product</h2>
                <div id="work-op" style="color:var(--accent); font-size:1.4rem; font-weight:bold;">Op</div>
                <div id="work-id" style="color:#555; font-size:0.8rem; margin-top:10px;">ID</div>
                <div id="work-req-data" style="color:#ff9800; font-size:0.9rem; margin-top:5px; display:none;">âš ï¸ çµæŸæ™‚éœ€è¼¸å…¥æ•¸æ“š</div>
            </div>
            <div style="text-align:center; margin:20px 0;">
                <div id="timer" style="font-size:4rem; font-weight:bold; color:var(--accent);">00:00:00</div>
                <div style="color:#888; margin-top:10px;">äººæ•¸: <span id="work-man" style="color:white; font-weight:bold;">4</span></div>
            </div>
            <div style="margin-top:auto;">
                <button class="large-btn btn-confirm" onclick="endJob()" style="height:80px; font-size:1.8rem;">ğŸ å®Œæˆ</button>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <button class="large-btn btn-secondary" onclick="adjustManpower()">ğŸ‘¥ èª¿æ•´</button>
                    <button class="large-btn btn-secondary" onclick="showScreen('queue')">â¬… æš«é›¢</button>
                </div>
            </div>
        </div>

        <!-- Finish -->
        <div id="screen-finish" class="screen">
            <div id="finish-instruction" style="font-size:1.5rem; text-align:center; margin-bottom:10px; color:var(--accent); font-weight:bold;"></div>
            <div id="qty-display" class="pin-display">0</div>
            <div id="finish-summary" style="text-align:left; background:#222; padding:15px; border-radius:8px; margin-bottom:20px; display:none;"></div>
            <div id="finish-keypad"></div>
        </div>

        <!-- Admin -->
        <div id="screen-admin" class="screen" style="width:100%; max-width:none; height:100%;">
            <div class="admin-dashboard-layout">
                <div class="admin-panel">
                    <div class="template-area">
                        <label style="color:#aaa; font-size:0.8rem;">ğŸ“‚ ç¯„æœ¬ç®¡ç†</label>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <select id="admin-template" class="admin-input" style="margin:0; flex:1;" onchange="loadTemplate()"><option value="">-- è¼‰å…¥ç¯„æœ¬ --</option></select>
                            <button class="btn-row-delete" style="width:50px; background:var(--danger); border:none;" onclick="deleteTemplate()">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <h3>â• å»ºç«‹å·¥å–®</h3>
                    <input id="admin-mwo" class="admin-input" placeholder="ç¸½å·¥å–®è™Ÿ">
                    <input type="number" id="admin-weight" class="admin-input" placeholder="åŸæ–™ç¸½é‡ (KG)">
                    <div class="checkbox-wrapper"><input type="checkbox" id="admin-req-data"><label for="admin-req-data" style="color:#fff; font-size:0.9rem; cursor:pointer;">è¦æ±‚ç¾å ´è¼¸å…¥ç”Ÿç”¢æ•¸æ“š</label></div>
                    <div style="border-top:1px solid #333; margin:15px 0; padding-top:10px; flex:1; display:flex; flex-direction:column;">
                        <label style="color:#888; font-size:0.9rem;">å·¥åºæ¸…å–®</label>
                        <div id="admin-sub-items" class="sub-items-wrapper"></div>
                        <button onclick="addAdminRow()" style="width:100%; padding:10px; background:#333; color:#ccc; border:1px dashed #555; margin-top:10px;">+ æ–°å¢</button>
                    </div>
                    <div class="admin-actions">
                        <button class="large-btn btn-secondary" onclick="saveTemplate()">ğŸ’¾ å­˜ç¯„æœ¬</button>
                        <button class="large-btn btn-confirm" onclick="publishWorkOrders()">ğŸš€ ç™¼å¸ƒ</button>
                    </div>
                    <button class="large-btn btn-danger" style="margin-top:20px;" onclick="adminReset()">âš ï¸ é‡ç½®</button>
                </div>
                <div class="admin-panel" style="border-left:1px solid #333;">
                    <h3>â˜ï¸ é›²ç«¯æ’ç¨‹é è¦½ (<span id="queue-count">0</span>)</h3>
                    <div id="admin-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="showScreen('queue')"><svg viewBox="0 0 24 24"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"/></svg><span>å·¥å–®</span></button>
        <button class="nav-btn" onclick="logout()"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg><span>ç™»å‡º</span></button>
    </div>

    <div id="loading-mask"><div class="spinner"></div><div style="color:white; margin-top:10px;">é›²ç«¯åŒæ­¥ä¸­...</div></div>

    <script>
        // é è¨­ URL
        let GAS_URL = "YOUR_GAS_WEBHOOK_URL"; 
        const TOKEN = "MES_LITE_2025";

        let appData = { queue: [], activeJobs: {}, templates: [] };
        let uiState = { screen: 'login', pin: '', user: null, targetWoId: null, tempVal: '0', finishStep: 0, finishCache: {}, isAdjusting: false };
        let syncTimer = null;
        let offlineMode = false;

        function init() {
            // 1. è¼‰å…¥å„²å­˜çš„ URL
            const savedUrl = localStorage.getItem('mes_gas_url');
            if (savedUrl) GAS_URL = savedUrl;
            
            loadStorage();
            renderATMKeypad('login-keypad', handleLoginInput);
            renderATMKeypad('manpower-keypad', handleManpowerInput);
            renderATMKeypad('finish-keypad', handleFinishInput);
            
            const statusEl = document.getElementById('cloud-status');
            if (!savedUrl || GAS_URL.includes("YOUR")) {
                statusEl.textContent = "URL æœªè¨­å®š";
                statusEl.style.color = "orange";
            } else {
                statusEl.textContent = "Ready";
            }
            
            showScreen('login');
            
            // å˜—è©¦é¦–æ¬¡åŒæ­¥
            if (savedUrl && !GAS_URL.includes("YOUR")) syncData(true);
            
            syncTimer = setInterval(() => { if (uiState.user) syncData(true); }, 10000);
            setInterval(() => { if(uiState.screen === 'working') updateTimerDisplay(); }, 1000);
        }

        // --- Config ---
        function openConfig() {
            document.getElementById('config-url-input').value = GAS_URL;
            document.getElementById('config-modal').style.display = 'flex';
        }
        function closeConfig() { document.getElementById('config-modal').style.display = 'none'; }
        async function saveConfig() {
            const newUrl = document.getElementById('config-url-input').value.trim();
            if(!newUrl.startsWith("http")) return alert("ç¶²å€æ ¼å¼éŒ¯èª¤");
            
            GAS_URL = newUrl;
            localStorage.setItem('mes_gas_url', newUrl);
            closeConfig();
            
            const statusEl = document.getElementById('cloud-status');
            statusEl.textContent = "Testing...";
            
            alert("è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨æ¸¬è©¦é€£ç·š...");
            await syncData(false);
        }

        // --- CORE SYNC ---
        async function syncData(silent = false) {
            if(offlineMode && silent) return; 
            if(GAS_URL.includes("YOUR")) return;

            if (!silent) document.getElementById('loading-mask').style.display = 'flex';
            const cloudStatus = document.getElementById('cloud-status');
            if(cloudStatus) cloudStatus.textContent = "Syncing...";

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' }, 
                    body: JSON.stringify({ action: 'GET_STATE', token: TOKEN })
                });
                
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.success) {
                    appData.queue = data.queue || [];
                    const cloudMap = {};
                    if (data.active) {
                        data.active.forEach(j => {
                            cloudMap[j.wo_id] = j;
                            if (!appData.activeJobs[j.wo_id]) {
                                appData.activeJobs[j.wo_id] = { ...j, lastUpdate: Date.now(), accTime: j.accTime || 0 };
                            }
                        });
                    }
                    Object.keys(appData.activeJobs).forEach(id => { if(!cloudMap[id]) delete appData.activeJobs[id]; });

                    saveStorage();
                    if(cloudStatus) { cloudStatus.textContent = "Connected âœ…"; cloudStatus.style.color = "#4caf50"; }
                    
                    offlineMode = false;
                    if (uiState.screen === 'queue') renderQueue();
                    if (uiState.screen === 'admin') renderAdminList();
                }
            } catch (e) {
                console.warn("Sync failed", e);
                if(cloudStatus) { cloudStatus.textContent = "ğŸ”´ é›¢ç·šæ¨¡å¼"; cloudStatus.style.color = "red"; }
                offlineMode = true;
            } finally {
                if (!silent) document.getElementById('loading-mask').style.display = 'none';
            }
        }

        async function sendAction(payload) {
            if(offlineMode) { alert("ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ï¼Œæ“ä½œå·²æš«å­˜æ–¼æœ¬æ©Ÿ (Mock Success)ã€‚"); return true; }

            document.getElementById('loading-mask').style.display = 'flex';
            payload.token = TOKEN;
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST', redirect: 'follow', headers: {'Content-Type': 'text/plain'}, body: JSON.stringify(payload)
                });
                const text = await res.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { throw new Error("Server response invalid"); }

                if (data.success) { await syncData(true); return true; }
                else { alert("Server Error: " + data.message); return false; }
            } catch (e) {
                console.error(e);
                offlineMode = true;
                alert("é€£ç·šå¤±æ•—ï¼Œåˆ‡æ›è‡³é›¢ç·šæ¨¡å¼ã€‚è³‡æ–™å·²æš«å­˜ã€‚");
                document.getElementById('cloud-status').textContent = "ğŸ”´ é›¢ç·šæ¨¡å¼";
                return true; 
            } finally {
                document.getElementById('loading-mask').style.display = 'none';
            }
        }
        
        function testConnection() {
             const win = window.open(GAS_URL, '_blank');
             if(!win) alert("è«‹å…è¨±å½ˆå‡ºè¦–çª—");
        }

        // --- Storage ---
        function loadStorage() {
            try {
                const raw = localStorage.getItem('mes_v6_data');
                if (raw) appData = JSON.parse(raw);
                if (!appData.templates) appData.templates = [];
                if (Array.isArray(appData.activeJobs)) appData.activeJobs = {};
            } catch(e) { console.error(e); }
        }
        function saveStorage() { localStorage.setItem('mes_v6_data', JSON.stringify(appData)); }

        // --- Nav ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(e => e.style.display = 'none');
            document.getElementById('screen-' + id).style.display = 'block';
            uiState.screen = id;
            const nav = document.querySelector('.nav-bar');
            if (id === 'login') nav.style.display = 'none'; else nav.style.display = 'flex';
            if (id === 'queue') { renderQueue(); syncData(true); }
            if (id === 'admin') renderAdminCreate();
        }

        function logout() { if(confirm("ç™»å‡º?")) { uiState.user = null; showScreen('login'); } }

        // --- Login ---
        function handleLoginInput(k) {
            if (k === 'C') uiState.pin = '';
            else if (k === 'OK') {
                if (uiState.pin === '9999') { uiState.user = {name:'Admin'}; showScreen('admin'); }
                else if (['1234','5678'].includes(uiState.pin)) {
                    uiState.user = {name:'ä¸»ç®¡', pin:uiState.pin};
                    document.getElementById('user-name').textContent = uiState.user.name;
                    showScreen('queue');
                } else { alert("å¯†ç¢¼éŒ¯èª¤"); uiState.pin = ''; }
            } else if (uiState.pin.length < 4) uiState.pin += k;
            document.getElementById('pin-display').textContent = uiState.pin.length > 0 ? 'â—'.repeat(uiState.pin.length) : '_ _ _ _';
        }

        // --- Queue ---
        function renderQueue() {
            const list = document.getElementById('queue-list');
            const activeList = document.getElementById('active-list');
            list.innerHTML = ''; activeList.innerHTML = '';
            let hasActive = false;

            Object.values(appData.activeJobs).forEach(job => {
                const div = document.createElement('div');
                div.className = 'queue-item active-job';
                div.innerHTML = `<div class="q-info"><h3>${job.prod} - ${job.op}</h3><p>ğŸ‘¥ ${job.manpower} | ${job.master}</p></div><div style="font-size:1.5rem;">â–¶ï¸</div>`;
                div.onclick = () => openWorkingScreen(job.wo_id);
                activeList.appendChild(div); hasActive = true;
            });
            document.getElementById('active-section').style.display = hasActive ? 'block' : 'none';

            appData.queue.forEach(job => {
                const div = document.createElement('div');
                div.className = 'queue-item';
                div.innerHTML = `<div class="q-info"><h3>${job.prod_zh} - ${job.op_zh}</h3><p>${job.master}</p></div>`;
                div.onclick = () => prepareJob(job.wo_id);
                list.appendChild(div);
            });
        }

        // --- Work Flow ---
        function prepareJob(id) {
            uiState.targetWoId = id; uiState.isAdjusting = false; uiState.tempVal = '0';
            document.getElementById('manpower-display').textContent = '0';
            showScreen('manpower');
        }
        function adjustManpower() {
            uiState.isAdjusting = true; uiState.tempVal = '0';
            document.getElementById('manpower-display').textContent = '0';
            showScreen('manpower');
        }
        function handleManpowerInput(k) {
            if(k === 'C') uiState.tempVal = '0';
            else if(k === 'OK') {
                const val = parseInt(uiState.tempVal);
                if(val > 0) { if(uiState.isAdjusting) doUpdateManpower(val); else doStartJob(val); }
                else alert("> 0");
            } else uiState.tempVal = (uiState.tempVal === '0' ? k : uiState.tempVal + k);
            document.getElementById('manpower-display').textContent = uiState.tempVal;
        }

        async function doStartJob(mp) {
            const job = appData.queue.find(j => j.wo_id === uiState.targetWoId);
            // å…ˆå¯«å…¥æœ¬åœ°
            const now = Date.now();
            appData.activeJobs[uiState.targetWoId] = { 
                wo_id: uiState.targetWoId, master: job.master, prod: job.prod_zh, op: job.op_zh,
                manpower: mp, req_data: job.req_data, startISO: new Date(now).toISOString(), lastUpdate: now, accTime: 0 
            };
            saveStorage();
            
            const ok = await sendAction({
                action: 'START_JOB', wo_id: uiState.targetWoId, master: job.master, prod: job.prod_zh, op: job.op_zh,
                pin: uiState.user.pin, manpower: mp, start_time: new Date().toISOString(), req_data: job.req_data
            });
            openWorkingScreen(uiState.targetWoId);
        }

        async function doUpdateManpower(mp) {
            const job = appData.activeJobs[uiState.targetWoId];
            const now = Date.now();
            const newAcc = (job.accTime||0) + ((now - (job.lastUpdate||Date.parse(job.startISO)))/3600000 * job.manpower);
            job.manpower = mp; job.lastUpdate = now; job.accTime = newAcc;
            saveStorage();

            const ok = await sendAction({
                action: 'UPDATE_JOB', wo_id: uiState.targetWoId, manpower: mp, start_time: new Date().toISOString(), acc_time: newAcc
            });
            openWorkingScreen(uiState.targetWoId);
        }

        function openWorkingScreen(id) {
            uiState.targetWoId = id;
            const job = appData.activeJobs[id];
            if(!job) { showScreen('queue'); return; }
            document.getElementById('work-prod').textContent = job.prod;
            document.getElementById('work-op').textContent = job.op;
            document.getElementById('work-id').textContent = id;
            document.getElementById('work-man').textContent = job.manpower;
            document.getElementById('work-req-data').style.display = job.req_data ? 'block' : 'none';
            updateTimerDisplay(); showScreen('working');
        }

        function updateTimerDisplay() {
            const job = appData.activeJobs[uiState.targetWoId];
            if(!job) return;
            const last = new Date(job.startISO).getTime();
            const diff = Math.floor((Date.now() - last)/1000);
            const h = String(Math.floor(diff/3600)).padStart(2,'0');
            const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
            const s = String(diff%60).padStart(2,'0');
            document.getElementById('timer').textContent = `${h}:${m}:${s}`;
        }

        function endJob() {
            const job = appData.activeJobs[uiState.targetWoId];
            const qJob = appData.queue.find(q => q.wo_id === uiState.targetWoId);
            const isSlicing = job.op.indexOf('åˆ†åˆ‡') >= 0;
            const isReq = job.req_data || (qJob && qJob.req_data);
            uiState.finishStep = (isSlicing || isReq) ? 1 : 99;
            uiState.finishCache = { good:0, reject:0, collar:0, tail:0 };
            uiState.tempVal = '0';
            updateFinishUI(); showScreen('finish');
        }

        function updateFinishUI() {
            const s = uiState.finishStep;
            const instr = document.getElementById('finish-instruction');
            const disp = document.getElementById('qty-display');
            const sum = document.getElementById('finish-summary');
            const kbd = document.getElementById('finish-keypad');
            sum.style.display = 'none'; kbd.style.display = 'grid'; disp.style.display = 'block';

            if (s===1) instr.textContent = "âŒ æè€— (KG)";
            else if (s===2) instr.textContent = "ä¸‹å·´é‡é‡ (KG)";
            else if (s===3) instr.textContent = "å°¾æ®µé‡é‡ (KG)";
            else if (s===4) instr.textContent = "âœ… è‰¯å“/ç¸½é‡ (KG)";
            else if (s===99) {
                instr.textContent = "ç¢ºèªé€å‡º?";
                disp.style.display = 'none'; sum.style.display = 'block';
                sum.innerHTML = `<div style='text-align:center;color:#4caf50;'>è‰¯å“: ${uiState.finishCache.good} | æè€—: ${uiState.finishCache.reject}</div><div style='text-align:center;margin-top:10px;'>æŒ‰ OK çµæŸ</div>`;
            }
            if (s!==99) disp.textContent = uiState.tempVal;
        }

        function handleFinishInput(k) {
            if (k==='C') { uiState.tempVal = '0'; updateFinishUI(); return; }
            if (k==='OK') {
                const val = parseFloat(uiState.tempVal);
                const s = uiState.finishStep;
                if (s===99) { doFinish(); return; }
                if (s===1) uiState.finishCache.reject = val;
                if (s===2) uiState.finishCache.collar = val;
                if (s===3) uiState.finishCache.tail = val;
                if (s===4) uiState.finishCache.good = val;
                uiState.tempVal = '0';
                if (s===1) uiState.finishStep = 2;
                else if (s===2) uiState.finishStep = 3;
                else if (s===3) uiState.finishStep = 4;
                else if (s===4) uiState.finishStep = 99;
                updateFinishUI(); return;
            }
            uiState.tempVal = (uiState.tempVal==='0'?k:uiState.tempVal+k); updateFinishUI();
        }

        async function doFinish() {
            const job = appData.activeJobs[uiState.targetWoId];
            const now = Date.now();
            const totalMs = (job.accTime||0) + ((now - (job.lastUpdate||Date.parse(job.startISO))) * job.manpower);
            const totalHrs = totalMs / 3600000.0;
            
            // å…ˆæœ¬åœ°æ›´æ–°
            delete appData.activeJobs[uiState.targetWoId];
            appData.queue = appData.queue.filter(q => q.wo_id !== uiState.targetWoId);
            saveStorage();

            await sendAction({
                action: 'FINISH_JOB', wo_id: uiState.targetWoId, op: job.op, pin: job.pin, manpower: job.manpower,
                total_hours: totalHrs.toFixed(3), 
                qty_good: uiState.finishCache.good, qty_reject: uiState.finishCache.reject,
                collar: uiState.finishCache.collar, tail: uiState.finishCache.tail
            });
            showScreen('queue');
        }

        // --- Admin ---
        function renderAdminCreate() {
            if(!document.getElementById('admin-sub-items').innerHTML) addAdminRow();
            updateTemplateDropdown(); renderAdminList();
        }
        function updateTemplateDropdown() {
            const sel = document.getElementById('admin-template');
            sel.innerHTML = '<option value="">-- è¼‰å…¥ç¯„æœ¬ --</option>';
            appData.templates.forEach((t, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = t.name; sel.appendChild(opt); });
        }
        function addAdminRow(prod='', op='') {
            const div = document.createElement('div'); div.className='sub-item-row';
            div.innerHTML = `<input class="admin-input prod" placeholder="ç”¢å“"><input class="admin-input op" placeholder="å·¥åº"><button class="btn-row-delete" onclick="this.parentElement.remove()">X</button>`;
            document.getElementById('admin-sub-items').appendChild(div);
        }
        function renderAdminList() {
            document.getElementById('admin-list').innerHTML = appData.queue.map(q => `<div style="border-bottom:1px solid #333; padding:5px;">${q.master} - ${q.op_zh}</div>`).join('');
        }
        function adminReset() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        
        function saveTemplate() {
            const mwo = document.getElementById('admin-mwo').value;
            if(!mwo) return alert("No ID");
            const items = [];
            document.querySelectorAll('.sub-item-row').forEach(r => {
                const p=r.querySelector('.prod').value, o=r.querySelector('.op').value;
                if(p&&o) items.push({prod:p, op:o});
            });
            if(items.length===0) return alert("Empty");
            appData.templates.push({name:mwo, items:items});
            saveStorage(); updateTemplateDropdown(); alert("Saved");
        }
        function loadTemplate() {
            const idx = document.getElementById('admin-template').value;
            if(idx==="") return;
            const t = appData.templates[idx];
            document.getElementById('admin-mwo').value = t.name;
            document.getElementById('admin-sub-items').innerHTML = '';
            t.items.forEach(i => addAdminRow(i.prod, i.op));
        }
        function deleteTemplate() {
             const idx = document.getElementById('admin-template').value;
             if(idx==="") return alert("Select first");
             if(confirm("Delete?")) {
                 appData.templates.splice(idx, 1); saveStorage(); updateTemplateDropdown();
                 document.getElementById('admin-template').value = "";
             }
        }
        function publishWorkOrders() {
            const mwo = document.getElementById('admin-mwo').value;
            if(!mwo) return alert("No ID");
            const jobs = [];
            const w = document.getElementById('admin-weight').value;
            const req = document.getElementById('admin-req-data').checked;
            document.querySelectorAll('.sub-item-row').forEach((r,i) => {
                const p=r.querySelector('.prod').value, o=r.querySelector('.op').value;
                if(p&&o) jobs.push({ wo_id:`${mwo}-${Date.now()}-${i}`, master:mwo, prod_zh:p, op_zh:o, rank:i+1, st:1, total_weight:w, req_data:req });
            });
            // æœ¬åœ°å…ˆæ›´æ–°ï¼Œé”åˆ°å³æ™‚æ•ˆæœ
            appData.queue = [...appData.queue, ...jobs];
            saveStorage();
            renderAdminList();
            
            sendAction({ action: 'ADD_JOBS', jobs: jobs });
            alert("Sent");
            document.getElementById('admin-mwo').value = '';
            document.getElementById('admin-sub-items').innerHTML = '';
            addAdminRow();
        }

        function renderATMKeypad(id, cb) {
            const el = document.getElementById(id); el.innerHTML=''; el.className='circle-keypad';
            ['1','2','3','4','5','6','7','8','9','C','0','OK'].forEach(k => {
                const b = document.createElement('div'); b.textContent=k;
                b.className = `circle-btn ${k==='OK'?'ok':(k==='C'?'clear':'')}`;
                b.onclick = () => cb(k); el.appendChild(b);
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>