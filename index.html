<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MES Lite ç°¡æ˜“å·¥æ™‚æ¡é›†</title>
    <style>
        /* ---------------------------------- */
        /* CSS: éŸ¿æ‡‰å¼æ¥µç°¡é¢¨æ ¼ */
        /* ---------------------------------- */
        :root {
            --bg-color: #0b1a2c;
            --text-color: #ffffff;
            --primary-color: #00bcd4;
            --btn-bg: #1a3449;
            --btn-active: #007bff;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #ff5722;
            --panel-bg: #112233;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            text-align: center;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            width: 100%;
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-top: 70px; /* å¢åŠ é ‚éƒ¨ç©ºé–“çµ¦åŠ å¤§çš„å°èˆªåˆ— */
        }

        .screen {
            display: none;
            min-height: 90vh; 
            padding-bottom: 50px;
        }

        /* é ‚éƒ¨å°èˆªåˆ— (åŠ å¤§ç‰ˆ) */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px; /* é«˜åº¦å¢åŠ  */
            background-color: #081220;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .nav-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            font-weight: bold;
        }

        .nav-icons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px; /* å¢åŠ é»æ“Šç¯„åœ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .nav-btn:active {
            background-color: rgba(255,255,255,0.1);
        }

        /* åœ–ç¤ºåŠ å¤§ */
        .nav-btn svg {
            width: 32px;
            height: 32px;
            fill: currentColor;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        /* é€šç”¨å¤§æŒ‰éˆ•æ¨£å¼ */
        .large-btn {
            padding: 12px;
            margin: 5px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background-color: var(--btn-bg);
            color: white;
            transition: all 0.2s;
            line-height: 1.3;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .large-btn:active {
            background-color: var(--btn-active);
            transform: scale(0.98);
        }

        /* ç¦ç”¨æ¨£å¼ */
        .large-btn.disabled {
            background-color: #555;
            border-color: #777;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .large-select {
            width: 95%;
            font-size: 1.2rem;
            padding: 10px;
            margin-bottom: 15px;
            background-color: var(--btn-bg);
            color: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300bcd4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 16px auto;
        }

        /* å·¥å–®åˆ—è¡¨å®¹å™¨ - ç¶²æ ¼ä½ˆå±€ */
        #queue-list-container {
            display: grid;
            gap: 10px;
            padding: 5px;
        }

        /* å·¥å–®åœ–æ¡†ç¸®å°å„ªåŒ– */
        .queue-item {
            text-align: left;
            border-color: var(--success-color);
            position: relative;
            padding: 10px 15px; 
            min-height: auto;   
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-radius: 8px;
            border: 2px solid var(--success-color);
            background-color: var(--btn-bg);
            cursor: pointer;
        }

        .queue-item.active-job {
            background-color: #1b5e20;
            border-color: #66bb6a;
            border-width: 3px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #00e676;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
        }
        
        .queue-item.active-job .status-badge {
            display: block;
        }

        .q-num {
            font-size: 1.4rem;
            font-weight: bold; 
            color: var(--primary-color);
            margin-right: 10px;
        }

        .main-lang {
            font-size: 1.2rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 2px;
        }
        
        .aux-lang {
            font-size: 0.9rem;
            color: #ccc;
            display: block;
        }

        .pin-display {
            font-size: 3rem;
            letter-spacing: 10px;
            margin: 20px auto;
            height: 60px;
            line-height: 60px;
            border-bottom: 3px dashed var(--primary-color);
            color: #ffd700;
            max-width: 90%;
        }

        .error {
            color: var(--error-color);
            font-size: 1.2rem;
            margin-top: 10px;
            font-weight: bold;
        }

        /* æ•¸å­—éµç›¤ä½ˆå±€ */
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px;
            width: 100%;
            max-width: 500px;
            margin: 10px auto;
        }

        .btn-confirm {
            background-color: var(--success-color); 
            border-color: var(--success-color);
        }

        .btn-back {
            background-color: #607d8b;
            border-color: #78909c;
        }
        
        .btn-adjust {
            background-color: #3f51b5;
            border-color: #5c6bc0;
        }

        .diagnostic-info {
            font-size: 0.7rem;
            color: #7fffd4; 
            margin-top: 10px;
        }
        .url-alert { 
            background-color: #581515; 
            border: 2px solid var(--error-color); 
            padding: 10px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            font-size: 1rem; 
            color: white; 
            text-align: left; 
            font-weight: bold; 
            display: none;
        }

        /* --- ç”Ÿç®¡ç•«é¢å°ˆç”¨æ¨£å¼ --- */
        .planner-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .tab-btn {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 15px;
            font-size: 1.1rem;
            border-radius: 20px;
            cursor: pointer;
        }
        .tab-btn.active {
            background-color: var(--primary-color);
            color: #000;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .admin-table th, .admin-table td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }
        .admin-table th {
            background-color: var(--primary-color);
            color: black;
        }
        .admin-table tr:nth-child(even) {
            background-color: #1a3449;
        }
        
        .admin-panel {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
        }
        .admin-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px 0;
            background: #000;
            border: 1px solid #555;
            color: white;
            font-size: 1rem;
        }
        .sub-item-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 5px;
            margin-bottom: 5px;
            align-items: center;
        }
        .btn-delete {
            background-color: #e91e63;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-add-line {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
        }
        .summary-box {
            background-color: var(--success-color);
            color: black;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* æ­·å²è¨˜éŒ„é¸æ“‡å€ */
        .history-section {
            border-top: 1px solid #444;
            margin-top: 15px;
            padding-top: 15px;
        }

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ (Media Queries) --- */

        /* å¹³æ¿èˆ‡æ¡Œé¢ (å¯¬åº¦å¤§æ–¼ 768px) */
        @media (min-width: 768px) {
            h1 { font-size: 2.5rem; }
            .large-btn { font-size: 1.6rem; padding: 20px; }
            .pin-display { font-size: 4rem; height: 80px; line-height: 80px; }
            
            /* å¹³æ¿æ¨¡å¼ä¸‹ï¼Œå·¥å–®åˆ—è¡¨é¡¯ç¤ºç‚º 2 æ¬„ */
            #queue-list-container {
                grid-template-columns: repeat(2, 1fr); 
            }
            
            .keypad-grid {
                gap: 15px;
                max-width: 600px;
            }
            
            .admin-table { font-size: 1.1rem; }
        }

        /* æ‰‹æ©Ÿç›´å‘ (å¯¬åº¦å°æ–¼ 768px) */
        @media (max-width: 767px) {
            .container { padding: 5px; } /* å·²ç¶“æœ‰ padding-top: 70px */
            h1 { font-size: 1.5rem; }
            
            /* æ‰‹æ©Ÿæ¨¡å¼ä¸‹ï¼Œå·¥å–®åˆ—è¡¨ç‚ºå–®æ¬„ */
            #queue-list-container {
                grid-template-columns: 1fr; 
            }
            
            .large-btn {
                padding: 12px;
                font-size: 1.2rem;
                margin: 5px;
            }
            .pin-display {
                font-size: 2.5rem;
                letter-spacing: 5px;
            }
            .admin-table th, .admin-table td { padding: 5px; font-size: 0.8rem; }
            
            .sub-item-row {
                grid-template-columns: 1fr; /* æ‰‹æ©Ÿä¸Šè®“è¼¸å…¥æ¡†å‚ç›´æ’åˆ— */
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªåˆ— (é è¨­éš±è—ï¼Œç™»å…¥å¾Œé¡¯ç¤º) -->
    <div id="nav-bar" class="nav-bar" style="display:none;">
        <div class="nav-icons">
            <button class="nav-btn" onclick="backToQueue()" title="è¿”å›åˆ—è¡¨ (Back)">
                <!-- è¿”å›åœ–ç¤º -->
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <button class="nav-btn" onclick="goHome()" title="å›åˆ°ä¸»ç•«é¢ (Home)">
                <!-- é¦–é åœ–ç¤º -->
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            </button>
        </div>
        <div class="nav-title" id="nav-title-display">MES Lite</div>
        <div class="nav-icons">
            <button class="nav-btn" onclick="logout()" title="ç™»å‡º (Logout)">
                <!-- ç™»å‡ºåœ–ç¤º -->
                <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </button>
        </div>
    </div>

    <div class="container">

        <!-- ç•«é¢ 1: ç™»å…¥ -->
        <div id="screen-login" class="screen" style="display: block;">
            <h1>MES LITE ç™»å…¥ ğŸ”’</h1>
            <div style="font-size: 1.2rem; margin-bottom: 20px;">
                <span data-i18n="login_prompt">è«‹è¼¸å…¥æ‚¨çš„ 4 ä½è­˜åˆ¥ç¢¼ (PIN)</span>
                <br><span style="font-size: 0.8em; color: #aaa;">(ç”Ÿç®¡: 9999)</span>
            </div>
            
            <div class="pin-display" id="pin-input">****</div>
            
            <div id="login-error" class="error"></div>
            
            <div class="diagnostic-info">
                GAS Webhook URL: <span id="api-base-url-display">N/A</span>
            </div>
            <div id="url-alert-box" class="url-alert">
                ğŸš¨ **é‡è¦!** è«‹å°‡ç¨‹å¼ç¢¼ä¸­çš„ `YOUR_GAS_WEBHOOK_URL` æ›¿æ›ç‚ºæ­¥é©Ÿä¸€ç²å¾—çš„å¯¦éš› URLã€‚
            </div>

             <div id="keypad" class="keypad-grid"></div>
        </div>

        <!-- ç•«é¢ 1.5: ç”Ÿç®¡ä¸»é é¢ (Planner Dashboard) -->
        <div id="screen-planner" class="screen">
            <h1>ğŸ“‹ ç”Ÿç®¡æ§åˆ¶å°</h1>
            <div class="planner-tabs">
                <button class="tab-btn active" onclick="switchPlannerTab('tab-queue')">å·¥å–®ç·¨è¼¯</button>
                <button class="tab-btn" onclick="switchPlannerTab('tab-report')">å ±è¡¨è¼¸å‡º</button>
            </div>

            <!-- Tab 1: å·¥å–®ç·¨è¼¯ (æ‰¹æ¬¡å»ºç«‹) -->
            <div id="tab-queue" class="planner-tab-content">
                <div class="admin-panel">
                    <h3>â• å»ºç«‹ç¸½å·¥å–® (æ‰¹æ¬¡)</h3>
                    
                    <!-- æ­·å²è¨˜éŒ„è®€å–åŠŸèƒ½ -->
                    <div class="history-section">
                        <label style="font-size: 0.9rem; color: #aaa;">ğŸ“‚ å¾æ­·å²è¨˜éŒ„è¼‰å…¥:</label>
                        <select id="mwo-history-select" class="large-select" style="font-size:1rem; padding:8px;" onchange="loadMWOFromHistory()">
                            <option value="">-- é¸æ“‡æ­·å²å·¥å–® --</option>
                        </select>
                    </div>

                    <label>ç¸½å·¥å–® ID (Master WO):</label>
                    <input type="text" id="batch-mwo" class="admin-input" placeholder="ä¾‹å¦‚: MWO-20251202-A">
                    
                    <h4>å­å·¥å–®é …ç›® (å“é … & å·¥åº)</h4>
                    <div id="sub-items-container">
                        <!-- å‹•æ…‹ç”Ÿæˆè¼¸å…¥åˆ— -->
                    </div>
                    <button class="btn-add-line" onclick="addSubItemRow()">+ æ–°å¢é …ç›®</button>
                    
                    <div style="margin-top: 20px;">
                        <button class="large-btn btn-confirm" style="width:100%; font-size:1.2rem;" onclick="saveBatchWorkOrder()">ç¢ºèªä¸¦é€å‡ºç¸½å·¥å–®</button>
                    </div>
                </div>

                <h3>ç›®å‰æ’ç¨‹æ¸…å–®</h3>
                <div style="overflow-x:auto;">
                    <table class="admin-table" id="admin-queue-table">
                        <thead>
                            <tr>
                                <th>ç¸½å·¥å–®</th>
                                <th>ç”¢å“</th>
                                <th>å·¥åº</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-queue-body">
                            <!-- JS ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: å ±è¡¨è¼¸å‡º -->
            <div id="tab-report" class="planner-tab-content" style="display:none;">
                <div class="admin-panel">
                    <h3>ğŸ“Š å·²å®Œæˆç´€éŒ„ (æœ¬æ©Ÿæš«å­˜)</h3>
                    <p style="font-size:0.8rem; color:#aaa;">å‹¾é¸é …ç›®ä»¥è¨ˆç®—ç¸½åˆ</p>
                    <button class="large-btn" style="width:100%; font-size:1.2rem; background-color:#2196f3;" onclick="calculateReport()">è¨ˆç®—é¸å–é …ç›®ç¸½å·¥æ™‚</button>
                </div>

                <div id="report-summary" class="summary-box" style="display:none;">
                    ç¸½äººæ™‚: <span id="sum-manhours">0</span> å°æ™‚<br>
                    è‰¯å“ç¸½é‡: <span id="sum-good">0</span> KG<br>
                    æè€—ç¸½é‡: <span id="sum-reject">0</span> KG
                </div>

                <div style="overflow-x:auto;">
                    <table class="admin-table" id="admin-report-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onclick="toggleAllReports(this)"></th>
                                <th>æ™‚é–“</th>
                                <th>å·¥å–®</th>
                                <th>å·¥åº</th>
                                <th>äººæ™‚</th>
                            </tr>
                        </thead>
                        <tbody id="admin-report-body">
                            <!-- JS ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <button class="large-btn btn-back" style="margin-top:20px;" onclick="clearCompletedLogs()">æ¸…é™¤å·²åŒ¯å‡ºç´€éŒ„</button>
            </div>
        </div>

        <!-- ç•«é¢ 2: å¾…è¾¦æ’éšŠ -->
        <div id="screen-queue" class="screen">
            <h1 id="queue-title"></h1>
            <div style="font-size: 1rem; color: #00bcd4; margin-bottom: 10px;" data-i18n="select_job_prompt">
                ğŸ‘† è«‹é»æ“Šæ¬²é–‹å§‹çš„å·¥å–® (CHá»ŒN CÃ”NG VIá»†C)
            </div>

            <!-- ç¸½å·¥å–®é¸æ“‡ (ä¸‹æ‹‰é¸å–®) -->
            <select id="master-wo-select" class="large-select" onchange="filterQueue()">
                <option value="ALL">å…¨éƒ¨é¡¯ç¤º (Hiá»ƒn thá»‹ táº¥t cáº£)</option>
            </select>
            
            <div id="queue-list-container">
                <!-- æ¨¡æ“¬å·¥å–®åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ç•«é¢ 2.5: è¼¸å…¥äººæ•¸ -->
        <div id="screen-manpower" class="screen">
            <h1 style="color: #ffd700;" data-i18n="manpower_input_title">è¼¸å…¥äººæ•¸ (NHáº¬P Sá» NGÆ¯á»œI)</h1>
            <div style="font-size: 1.2rem;">
                <span data-i18n="working_wo">å·¥å–®</span>: <span id="manpower-woid" style="font-weight: bold; color: #00bcd4;"></span>
            </div>

            <div style="margin: 20px auto; max-width: 400px;">
                <div class="pin-display" id="manpower-input-display" style="letter-spacing: normal; color: #ffd700;">0</div>
            </div>
            
            <div id="manpower-keypad-container" class="keypad-grid"></div>
        </div>

        <!-- ç•«é¢ 3: æ­£åœ¨è¨ˆæ™‚ -->
        <div id="screen-working" class="screen">
            <h1 class="working-status">ğŸŸ¢ <span data-i18n="working_in_progress">æ­£åœ¨é€²è¡Œä¸­</span></h1>
            <div style="font-size: 1.5rem; margin-top: 10px;">
                <span data-i18n="working_wo">å·¥å–®</span>: <span id="working-woid" style="font-weight: bold;"></span>
            </div>
            <div style="font-size: 2.5rem; color: #ffd700; margin: 20px 0;">
                <span data-i18n="manpower_count">äººæ•¸</span>: <span id="manpower-display">4</span>
            </div>
            <div style="font-size: 3.5rem; color: #00bcd4;">
                <span data-i18n="elapsed_time">å·²è€—æ™‚</span>: <span id="elapsed-time">00:00:00</span>
            </div>
            <div style="margin-top: 30px; display: flex; flex-direction: column; align-items: center;">
                <button class="large-btn btn-adjust" style="width: 90%; margin-bottom: 15px;" onclick="adjustManpower()">
                    <span data-i18n="btn_adjust_manpower">ğŸ‘¥ èª¿æ•´äººæ•¸ / Change Manpower</span>
                </button>

                <button class="large-btn btn-back" style="width: 90%; margin-bottom: 15px;" onclick="backToQueue()">
                    <span data-i18n="btn_back_list">â¬… æš«é›¢ / è¿”å›åˆ—è¡¨</span> (Quay láº¡i)
                </button>

                <button class="large-btn btn-confirm" style="background-color: orange; width: 90%; font-size: 1.8rem;" onclick="endJob()">
                    <span data-i18n="btn_finish">å®Œæˆå·¥å–®</span> (HOÃ€N THÃ€NH)
                </button>
            </div>
        </div>

        <!-- ç•«é¢ 4: æ•¸é‡è¼¸å…¥ -->
        <div id="screen-finish" class="screen">
            <h1 style="color: #ff9800;" data-i18n="finish_prompt">æ­¥é©Ÿ 4: è¼¸å…¥æ•¸é‡ (NHáº¬P Sá» LÆ¯á»¢NG)</h1>
            <div style="font-size: 1.2rem;">
                <span data-i18n="finish_wo">å·¥å–®</span>: <span id="finish-woid" style="font-weight: bold; color: #ffd700;"></span>
            </div>

            <div style="margin: 10px auto; max-width: 400px;">
                <div id="finish-instruction" style="font-size: 1.5rem; color: #00bcd4; margin-bottom: 10px; min-height: 40px; white-space: pre-line;">
                    <!-- é€™è£¡æ˜¯å‹•æ…‹æŒ‡ä»¤ -->
                </div>
                
                <div class="pin-display" id="qty-input-display" style="letter-spacing: normal; color: #ffd700;">0</div>
            </div>
            
            <div id="finish-keypad-container" class="keypad-grid"></div>
        </div>
    </div>

    <script>
        // ----------------------------------
        // JAVASCRIPT: é‚è¼¯èˆ‡ GAS Webhook æºé€š
        // ----------------------------------

        // ğŸš¨ é—œéµï¼šè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„ Google Apps Script Webhook URL
        const GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbyP9sYjwQ3pM7MMkrbiWTaUKmIeUcWhtWzPEqyhBlpHds7NfK6I49TTbEg4DWGsutBytA/exec'; 
        const SECURITY_TOKEN = "MES_LITE_2025"; 
        
        let state = {
            currentScreen: 'login',
            currentPIN: '',
            currentUser: null,
            language: 'zh',
            activeSessions: {}, 
            currentViewingWoId: null,
            currentWoOperationName: null, 
            currentManpower: 0, 
            finishStep: 0, 
            finishData: { qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0, qty_good: 0 },
            currentTypedValue: '0',
            startTimeISO: null,
            isSubmitting: false 
        };

        let timerInterval = null;

        // é è¨­å·¥å–®è³‡æ–™
        const defaultQueue = [
            { wo_id: 'WC001-Q1', master_wo_id: 'MWO-A', product_name_zh: 'é®­é­šåˆ†åˆ‡æ‰¹æ¬¡', product_name_vn: 'CÃ¡ há»“i lÃ´ A', operation_name_zh: 'åˆ†åˆ‡/åˆ†æ–™', operation_name_vn: 'Cáº¯t lÃ¡t', queue_rank: 1, standard_time_hr: 1.2 },
            { wo_id: 'WC001-Q3', master_wo_id: 'MWO-A', product_name_zh: 'ä¸­æ®µåšåˆ‡', product_name_vn: 'LÃ¡t giá»¯a dÃ y', operation_name_zh: 'é‡é‡é¸åˆ¥', operation_name_vn: 'PhÃ¢n loáº¡i', queue_rank: 3, standard_time_hr: 0.3 }
        ];

        // å¯¦éš›ä½¿ç”¨çš„å·¥å–®åˆ—è¡¨
        let appQueue = [];
        // å·²å®Œæˆçš„ç´€éŒ„
        let completedLogs = [];
        // ç¸½å·¥å–®æ­·å²è¨˜éŒ„ (MWO History)
        let mwoHistory = [];

        // é›™èªå­—å…¸
        const i18n = {
            zh: {
                login_prompt: 'è«‹è¼¸å…¥ 4 ä½è­˜åˆ¥ç¢¼ (PIN)', pin_error: 'PIN ç¢¼éŒ¯èª¤ï¼', select_job_prompt: 'ğŸ‘† è«‹é»æ“Šæ¬²é–‹å§‹çš„å·¥å–®', job_start_error: 'å·¥å–®å•Ÿå‹•å¤±æ•—!', working_wo: 'å·¥å–®', manpower_count: 'äººæ•¸', elapsed_time: 'å·²è€—æ™‚', working_in_progress: 'æ­£åœ¨é€²è¡Œä¸­', 
                manpower_input_title: 'æ­¥é©Ÿ 2: è¼¸å…¥äººæ•¸', manpower_error: 'äººæ•¸å¿…é ˆå¤§æ–¼ 0',
                finish_prompt: 'æ­¥é©Ÿ 4: è¼¸å…¥æ•¸é‡', finish_wo: 'å·¥å–®', finish_step1: 'âŒ ä¸è‰¯å“/æè€—é‡é‡ (KG)', finish_step2: 'ä¸‹å·´é‡é‡ (KG)', finish_step3: 'å°¾æ®µé‡é‡ (KG)', finish_step4: 'âœ… ä¸­å¾Œæ®µç¸½é‡ (KG)', finish_step5_good: 'âœ… è‰¯å“æ•¸é‡ (PCS/KG)', finish_step5_reject: 'âŒ ä¸è‰¯å“æ•¸é‡ (PCS/KG)', btn_finish: 'å®Œæˆå·¥å–®', btn_confirm_submit: 'ç¢ºèªæäº¤', missing_data: 'æ•¸æ“šä¸å®Œæ•´', api_error: 'é€£ç·šéŒ¯èª¤', no_job_in_queue: 'ç›®å‰æ²’æœ‰å¾…è¾¦å·¥å–®', btn_back_list: 'â¬… æš«é›¢ / è¿”å›åˆ—è¡¨', running_status: 'é€²è¡Œä¸­',
                btn_adjust_manpower: 'ğŸ‘¥ èª¿æ•´äººæ•¸ / Change Manpower',
                confirm_summary_title: 'ğŸ“‹ è«‹ç¢ºèªè³‡æ–™ (Please Confirm):',
                confirm_btn_text: 'OK éµç¢ºèªé€å‡º'
            },
            vn: {
                login_prompt: 'NHáº¬P MÃƒ Äá»ŠNH DANH (PIN)', pin_error: 'MÃ£ PIN sai!', select_job_prompt: 'ğŸ‘† CHá»ŒN CÃ”NG VIá»†C', job_start_error: 'Lá»—i báº¯t Ä‘áº§u!', working_wo: 'ÄÆ¡n hÃ ng', manpower_count: 'Sá»‘ ngÆ°á»i', elapsed_time: 'ÄÃ£ cháº¡y giá»', working_in_progress: 'ÄANG THá»°C HIá»†N', 
                manpower_input_title: 'BÆ¯á»šC 2: NHáº¬P Sá» NGÆ¯á»œI', manpower_error: 'Sá»‘ ngÆ°á»i > 0',
                finish_prompt: 'BÆ¯á»šC 4: NHáº¬P Sá» LÆ¯á»¢NG', finish_wo: 'ÄÆ¡n hÃ ng', finish_step1: 'âŒ Sá» CÃ‚N Náº¶NG Há»NG (KG)', finish_step2: 'Sá» CÃ‚N Náº¶NG Cáº°M (KG)', finish_step3: 'Sá» CÃ‚N Náº¶NG ÄUÃ”I (KG)', finish_step4: 'âœ… Tá»”NG CÃ‚N Náº¶NG GIá»®A/SAU (KG)', finish_step5_good: 'âœ… Sá»‘ lÆ°á»£ng tá»‘t (PCS/KG)', finish_step5_reject: 'âŒ Sá»‘ lÆ°á»£ng há»ng (PCS/KG)', btn_finish: 'HoÃ n thÃ nh', btn_confirm_submit: 'XÃC NHáº¬N Gá»¬I', missing_data: 'Thiáº¿u dá»¯ liá»‡u', api_error: 'Lá»—i káº¿t ná»‘i', no_job_in_queue: 'KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng', btn_back_list: 'â¬… Quay láº¡i', running_status: 'Running',
                btn_adjust_manpower: 'ğŸ‘¥ Thay Ä‘á»•i nhÃ¢n lá»±c',
                confirm_summary_title: 'ğŸ“‹ XÃ¡c nháº­n dá»¯ liá»‡u:',
                confirm_btn_text: 'Nháº¥n OK Ä‘á»ƒ gá»­i'
            }
        };

        // --- åˆå§‹åŒ–èˆ‡ Storage ---
        function initApp() {
            // è®€å– LocalStorage
            const storedQueue = localStorage.getItem('mes_lite_queue');
            if (storedQueue) {
                appQueue = JSON.parse(storedQueue);
            } else {
                appQueue = [...defaultQueue]; 
                saveQueueToStorage();
            }

            const storedLogs = localStorage.getItem('mes_lite_logs');
            if (storedLogs) {
                completedLogs = JSON.parse(storedLogs);
            }

            const storedMWOHistory = localStorage.getItem('mes_mwo_history');
            if (storedMWOHistory) {
                mwoHistory = JSON.parse(storedMWOHistory);
            }

            document.getElementById('api-base-url-display').textContent = GAS_WEBHOOK_URL; 
            if (GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') {
                document.getElementById('url-alert-box').style.display = 'block';
            }
            renderKeypad('keypad', 'PIN'); 
            updateUI();
        }

        function saveQueueToStorage() {
            localStorage.setItem('mes_lite_queue', JSON.stringify(appQueue));
        }
        function saveLogsToStorage() {
            localStorage.setItem('mes_lite_logs', JSON.stringify(completedLogs));
        }
        function saveMWOHistoryToStorage() {
            localStorage.setItem('mes_mwo_history', JSON.stringify(mwoHistory));
        }

        // --- UI Functions ---

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            state.currentScreen = screenId.replace('screen-', '');
            
            // è™•ç†å°èˆªåˆ—é¡¯ç¤º
            const navBar = document.getElementById('nav-bar');
            if (state.currentScreen === 'login') {
                navBar.style.display = 'none';
                renderKeypad('keypad', 'PIN');
                state.currentPIN = '';
            } else {
                navBar.style.display = 'flex';
                let title = "MES Lite";
                if(state.currentScreen === 'queue') title = "å¾…è¾¦æ’ç¨‹";
                if(state.currentScreen === 'planner') title = "ç”Ÿç®¡æ§åˆ¶å°";
                if(state.currentScreen === 'working') title = "è¨ˆæ™‚ä¸­";
                document.getElementById('nav-title-display').textContent = title;
            }

            if (state.currentScreen === 'queue') {
                loadQueue();
            } else if (state.currentScreen === 'planner') {
                renderPlannerQueue();
                updateMWOHistoryDropdown(); // æ›´æ–°æ­·å²è¨˜éŒ„ä¸‹æ‹‰é¸å–®
                // å¦‚æœæ²’æœ‰è¡Œï¼ŒåŠ ä¸€è¡Œé è¨­
                if (document.getElementById('sub-items-container').children.length === 0) {
                    addSubItemRow();
                }
            }
        }

        function updateUI() {
            const currentLang = state.language;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang] && i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
            });

            if (state.currentUser && state.currentUser.name_zh) {
                const greeting = currentLang === 'vn' ? `ChÃ o Ã”ng ${state.currentUser.name_vn}!` : `æ‚¨å¥½ï¼Œ${state.currentUser.name_zh}ä¸»ç®¡!`;
                document.getElementById('queue-title').textContent = greeting;
            }
        }

        // --- å°èˆªåˆ—åŠŸèƒ½ ---
        function goHome() {
            if (state.currentUser && state.currentUser.user_pin === '9999') {
                showScreen('screen-planner');
                switchPlannerTab('tab-queue');
            } else {
                backToQueue();
            }
        }

        // --- ç”Ÿç®¡ (Planner) åŠŸèƒ½ ---

        function switchPlannerTab(tabId) {
            document.querySelectorAll('.planner-tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tabId === 'tab-queue') {
                renderPlannerQueue();
                updateMWOHistoryDropdown();
            }
            if (tabId === 'tab-report') renderPlannerReport();
        }

        function renderPlannerQueue() {
            const tbody = document.getElementById('admin-queue-body');
            tbody.innerHTML = '';
            appQueue.forEach((job, index) => {
                const row = `<tr>
                    <td>${job.master_wo_id}</td>
                    <td>${job.product_name_zh}</td>
                    <td>${job.operation_name_zh}</td>
                    <td><button class="btn-delete" onclick="deleteWorkOrder(${index})">åˆªé™¤</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // å‹•æ…‹æ–°å¢å­é …ç›®è¼¸å…¥åˆ—
        function addSubItemRow(prod = '', op = '') {
            const container = document.getElementById('sub-items-container');
            const div = document.createElement('div');
            div.className = 'sub-item-row';
            div.innerHTML = `
                <input type="text" class="admin-input prod-input" placeholder="ç”¢å“åç¨± (å¦‚: ä¸­æ®µåšåˆ‡)" value="${prod}">
                <input type="text" class="admin-input op-input" placeholder="å·¥åºåç¨± (å¦‚: çœŸç©ºåŒ…è£)" value="${op}">
                <button class="btn-delete" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        // æ­·å²å·¥å–®åŠŸèƒ½
        function updateMWOHistoryDropdown() {
            const select = document.getElementById('mwo-history-select');
            select.innerHTML = '<option value="">-- é¸æ“‡æ­·å²å·¥å–® --</option>';
            // åè½‰é¡¯ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
            [...mwoHistory].reverse().forEach(template => {
                const option = document.createElement('option');
                option.value = template.mwo_id;
                // é¡¯ç¤º MWO ID å’Œç¬¬ä¸€å€‹ç”¢å“åç¨±ä½œç‚ºæç¤º
                const desc = `${template.mwo_id} (${template.items.length} é …)`;
                option.textContent = desc;
                select.appendChild(option);
            });
        }

        function loadMWOFromHistory() {
            const selectedMWO = document.getElementById('mwo-history-select').value;
            if (!selectedMWO) return;

            const template = mwoHistory.find(t => t.mwo_id === selectedMWO);
            if (!template) return;

            // å¡«å……è³‡æ–™åˆ°ç·¨è¼¯å€
            document.getElementById('batch-mwo').value = template.mwo_id + "-COPY"; // è‡ªå‹•åŠ å¾Œç¶´é¿å…é‡è¤‡
            const container = document.getElementById('sub-items-container');
            container.innerHTML = ''; // æ¸…ç©ºç¾æœ‰
            
            template.items.forEach(item => {
                addSubItemRow(item.prod, item.op);
            });
        }

        function saveBatchWorkOrder() {
            const mwo = document.getElementById('batch-mwo').value;
            const rows = document.querySelectorAll('.sub-item-row');
            
            if (!mwo) {
                alert("è«‹è¼¸å…¥ç¸½å·¥å–® ID");
                return;
            }

            let addedCount = 0;
            const templateItems = [];

            rows.forEach((row, index) => {
                const prod = row.querySelector('.prod-input').value;
                const op = row.querySelector('.op-input').value;
                
                if (prod && op) {
                    const newJob = {
                        wo_id: `${mwo}-Q${appQueue.length + 1 + index}`, 
                        master_wo_id: mwo,
                        product_name_zh: prod,
                        product_name_vn: prod, 
                        operation_name_zh: op,
                        operation_name_vn: op,
                        queue_rank: appQueue.length + 1 + index,
                        standard_time_hr: 1.0
                    };
                    appQueue.push(newJob);
                    templateItems.push({ prod: prod, op: op });
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveQueueToStorage();
                
                // å„²å­˜åˆ°æ­·å²è¨˜éŒ„ (å¦‚æœ ID ä¸é‡è¤‡)
                const exists = mwoHistory.some(t => t.mwo_id === mwo);
                if (!exists) {
                    mwoHistory.push({ mwo_id: mwo, items: templateItems });
                    saveMWOHistoryToStorage();
                }

                renderPlannerQueue();
                updateMWOHistoryDropdown();
                alert(`æˆåŠŸæ–°å¢ ${addedCount} ç­†å·¥å–®ï¼ä¸¦å·²å„²å­˜è‡³æ­·å²è¨˜éŒ„ã€‚`);
                
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('batch-mwo').value = '';
                document.getElementById('sub-items-container').innerHTML = '';
                addSubItemRow(); 
            } else {
                alert("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å®Œæ•´çš„å­é …ç›®");
            }
        }

        function deleteWorkOrder(index) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å·¥å–®å—ï¼Ÿ")) {
                appQueue.splice(index, 1);
                saveQueueToStorage();
                renderPlannerQueue();
            }
        }

        function renderPlannerReport() {
            const tbody = document.getElementById('admin-report-body');
            tbody.innerHTML = '';
            // åå‘é¡¯ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
            [...completedLogs].reverse().forEach((log, index) => {
                const time = new Date(log.endTime).toLocaleString();
                const realIndex = completedLogs.length - 1 - index;
                
                const row = `<tr>
                    <td><input type="checkbox" class="report-checkbox" data-index="${realIndex}"></td>
                    <td>${time}</td>
                    <td>${log.wo_id}</td>
                    <td>${log.operation_name}</td>
                    <td>${parseFloat(log.totalManHours).toFixed(2)}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function toggleAllReports(source) {
            const checkboxes = document.querySelectorAll('.report-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function calculateReport() {
            const checkboxes = document.querySelectorAll('.report-checkbox:checked');
            let totalHours = 0;
            let totalGood = 0;
            let totalReject = 0;

            if (checkboxes.length === 0) {
                alert("è«‹å…ˆå‹¾é¸é …ç›®");
                return;
            }

            checkboxes.forEach(cb => {
                const index = cb.getAttribute('data-index');
                const log = completedLogs[index];
                totalHours += parseFloat(log.totalManHours || 0);
                totalGood += parseFloat(log.qty_good || 0);
                totalReject += parseFloat(log.qty_reject || 0);
            });

            document.getElementById('sum-manhours').textContent = totalHours.toFixed(2);
            document.getElementById('sum-good').textContent = totalGood.toFixed(2);
            document.getElementById('sum-reject').textContent = totalReject.toFixed(2);
            document.getElementById('report-summary').style.display = 'block';
        }

        function clearCompletedLogs() {
            if (confirm("é€™å°‡æ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰å·²å®Œæˆç´€éŒ„ (ç„¡æ³•å¾©åŸ)ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                completedLogs = [];
                saveLogsToStorage();
                renderPlannerReport();
                document.getElementById('report-summary').style.display = 'none';
            }
        }

        function logout() {
            state.currentUser = null;
            showScreen('screen-login');
        }

        // --- Keypad Functions ---
        function renderKeypad(targetElementId, targetInputType) {
            state.inputTarget = targetInputType;
            // ä¿®æ­£ï¼šæ¨™æº–è¨ˆç®—æ©Ÿ/é›»è©±æ’åˆ—
            const layout = ['7', '8', '9', '4', '5', '6', '1', '2', '3', 'C', '0', 'OK'];
            const keypadDiv = document.getElementById(targetElementId);
            keypadDiv.innerHTML = '';
            
            layout.forEach(key => {
                const btn = document.createElement('div');
                btn.className = 'large-btn';
                if (key === 'OK') btn.className += ' btn-confirm';
                btn.textContent = key;
                btn.style.width = '100%'; 
                btn.onclick = () => handleKeypadInput(key);
                keypadDiv.appendChild(btn);
            });
        }

        function handleKeypadInput(key) {
            if (state.isSubmitting && key === 'OK') return;

            let displayElementId;
            let currentInput;

            if (state.currentScreen === 'login') {
                displayElementId = 'pin-input';
                currentInput = state.currentPIN;
            } else if (state.currentScreen === 'manpower') { 
                displayElementId = 'manpower-input-display';
                currentInput = state.currentTypedValue;
            } else { 
                displayElementId = 'qty-input-display';
                currentInput = state.currentTypedValue;
            }
            
            document.getElementById('login-error').textContent = ''; 

            if (key >= '0' && key <= '9') {
                if (currentInput.length < 8) {
                    currentInput = (currentInput === '0' || currentInput === '') ? key : currentInput + key;
                }
            } else if (key === 'C') {
                currentInput = '0';
            } else if (key === 'OK') {
                if (state.currentScreen === 'login') {
                    validateLogin(currentInput);
                } else if (state.currentScreen === 'manpower') { 
                    confirmManpower(parseInt(currentInput));
                } else if (state.currentScreen === 'finish') {
                    processFinishStep(parseFloat(currentInput));
                }
                return;
            }
            
            if (state.currentScreen === 'login') {
                state.currentPIN = currentInput;
                document.getElementById(displayElementId).textContent = currentInput.padEnd(4, '*').replace(/./g, '*').substring(0, 4);
            } else {
                state.currentTypedValue = currentInput;
                document.getElementById(displayElementId).textContent = currentInput;
            }
        }

        // --- Logic ---

        function validateLogin(pin) {
            if (pin === '9999') {
                showScreen('screen-planner');
                switchPlannerTab('tab-queue');
                return;
            }

            if (pin.length !== 4) {
                 document.getElementById('login-error').textContent = i18n[state.language].pin_error;
                 return;
            }
            let user;
            if (pin === '1234') {
                 user = { user_pin: pin, name_zh: 'é˜®æ°ç¾', name_vn: 'Nguyá»…n Thá»‹ Má»¹', language: 'vn' };
            } else if (pin === '5678') {
                 user = { user_pin: pin, name_zh: 'é™³ç¶“ç†', name_vn: 'Tráº§n Quáº£n LÃ½', language: 'zh' };
            } else {
                 document.getElementById('login-error').textContent = i18n[state.language].pin_error;
                 return;
            }
            state.currentUser = user;
            state.language = user.language; 
            updateUI();
            showScreen('screen-queue');
        }

        function loadQueue() {
            const masterWOs = [...new Set(appQueue.map(item => item.master_wo_id))];
            const select = document.getElementById('master-wo-select');
            
            const currentSelection = select.value;
            
            select.innerHTML = `<option value="ALL">${state.language === 'vn' ? 'Táº¥t cáº£ (å…¨éƒ¨)' : 'å…¨éƒ¨é¡¯ç¤º'}</option>`;
            masterWOs.forEach(mwo => {
                const option = document.createElement('option');
                option.value = mwo;
                option.textContent = mwo;
                select.appendChild(option);
            });

            if (masterWOs.includes(currentSelection)) {
                select.value = currentSelection;
            }

            filterQueue();
        }

        function filterQueue() {
            const selectedMasterWO = document.getElementById('master-wo-select').value;
            const listContainer = document.getElementById('queue-list-container');
            listContainer.innerHTML = '';

            const filteredQueue = appQueue.filter(job => {
                return selectedMasterWO === 'ALL' || job.master_wo_id === selectedMasterWO;
            });
            
            if (filteredQueue.length > 0) {
                filteredQueue.forEach(job => {
                    const prodName = state.language === 'vn' ? 
                        `${job.product_name_vn} (${job.product_name_zh})` : 
                        `${job.product_name_zh} (${job.product_name_vn})`;
                    const opName = job.operation_name_zh || "æœªçŸ¥å·¥åº"; 
                    
                    const isActive = state.activeSessions[job.wo_id] !== undefined;
                    const activeClass = isActive ? 'active-job' : '';
                    const badge = isActive ? `<div class="status-badge">${i18n[state.language].running_status}</div>` : '';

                    const html = `
                        <div class="queue-item ${activeClass}" onclick="selectJob('${job.wo_id}', '${opName}')">
                            <span class="q-num">Q${job.queue_rank}</span>
                            <div style="flex-grow:1;">
                                <span class="main-lang">${prodName}</span>
                                <span class="aux-lang">${opName}</span>
                            </div>
                            <div style="font-size: 0.8em; color: #aaa;">${job.master_wo_id}</div>
                            ${badge}
                        </div>
                    `;
                    listContainer.innerHTML += html;
                });
            } else {
                 listContainer.innerHTML = `<p style="font-size:1.2em; color: #ccc; grid-column: 1 / -1;">${i18n[state.language].no_job_in_queue}</p>`;
            }
        }

        function selectJob(woId, operationName) {
            state.currentViewingWoId = woId; 
            state.currentWoOperationName = operationName; 
            
            if (state.activeSessions[woId]) {
                const session = state.activeSessions[woId];
                state.currentManpower = session.manpower;
                
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                
                document.getElementById('working-woid').textContent = woId;
                document.getElementById('manpower-display').textContent = session.manpower;
                
                showScreen('screen-working');
                updateTimer(); 
            } else {
                state.currentTypedValue = '0';
                document.getElementById('manpower-woid').textContent = woId;
                document.getElementById('manpower-input-display').textContent = '0';
                
                renderKeypad('manpower-keypad-container', 'MANPOWER_INPUT');
                showScreen('screen-manpower'); 
            }
        }

        function adjustManpower() {
            state.currentTypedValue = '0';
            document.getElementById('manpower-woid').textContent = state.currentViewingWoId;
            document.getElementById('manpower-input-display').textContent = '0';
            
            renderKeypad('manpower-keypad-container', 'MANPOWER_INPUT');
            showScreen('screen-manpower'); 
        }

        function confirmManpower(value) {
            if (value <= 0) {
                alert(i18n[state.language].manpower_error);
                return;
            }
            
            if (state.activeSessions[state.currentViewingWoId]) {
                const session = state.activeSessions[state.currentViewingWoId];
                const now = Date.now();
                
                const segmentMs = now - session.lastUpdateTime;
                const segmentHours = (segmentMs / 3600000.0) * session.manpower;
                session.accumulatedManHours = (session.accumulatedManHours || 0) + segmentHours;
                
                session.lastUpdateTime = now; 
                session.manpower = value;     
                
                state.currentManpower = value;
                
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                
                document.getElementById('working-woid').textContent = state.currentViewingWoId;
                document.getElementById('manpower-display').textContent = state.currentManpower;
                showScreen('screen-working');
                
            } else {
                state.currentManpower = value;
                startJobSession();
            }
        }

        function startJobSession() {
            const now = Date.now();
            state.activeSessions[state.currentViewingWoId] = {
                startTime: now,      
                lastUpdateTime: now, 
                startTimeISO: new Date(now).toISOString(),
                manpower: state.currentManpower,
                operationName: state.currentWoOperationName,
                accumulatedManHours: 0 
            };

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            document.getElementById('working-woid').textContent = state.currentViewingWoId;
            document.getElementById('manpower-display').textContent = state.currentManpower;

            showScreen('screen-working');
        }

        function backToQueue() {
            if (timerInterval) clearInterval(timerInterval);
            state.currentViewingWoId = null; 
            showScreen('screen-queue');
        }

        function updateTimer() {
            const session = state.activeSessions[state.currentViewingWoId];
            if (!session) return;

            const elapsed = Date.now() - session.startTime;
            const seconds = Math.floor(elapsed / 1000);
            const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const remainingSeconds = String(seconds % 60).padStart(2, '0');
            
            document.getElementById('elapsed-time').textContent = `${hours}:${minutes}:${remainingSeconds}`;
        }

        function endJob() {
            startFinishFlow();
        }

        function startFinishFlow() {
            if (timerInterval) clearInterval(timerInterval);
            state.currentTypedValue = '0';
            document.getElementById('finish-woid').textContent = state.currentViewingWoId;
            
            const isSlicing = state.currentWoOperationName && state.currentWoOperationName.includes('åˆ†åˆ‡');

            if (isSlicing) {
                state.finishStep = 1; 
                document.getElementById('finish-instruction').innerHTML = `<span class="main-lang">${i18n[state.language].finish_step1}</span>`;
            } else {
                state.finishStep = 5; 
                document.getElementById('finish-instruction').innerHTML = `<span class="main-lang">${i18n[state.language].finish_step5_good}</span>`;
            }
            
            state.finishData = { qty_reject: 0, actual_collar_qty: 0, actual_tail_qty: 0, qty_good: 0 };
            document.getElementById('qty-input-display').textContent = '0';

            renderKeypad('finish-keypad-container', 'QTY_INPUT');
            showScreen('screen-finish');
        }

        function processFinishStep(value) {
            const instruction = document.getElementById('finish-instruction');
            const lang = state.language;

            // è™•ç†å››æ­¥é©Ÿ (åˆ†åˆ‡/åˆ†æ–™)
            if (state.finishStep >= 1 && state.finishStep <= 4) {
                if (state.finishStep === 1) { 
                    state.finishData.qty_reject = value;
                    state.finishStep = 2;
                    instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step2}</span>`;
                } else if (state.finishStep === 2) { 
                    state.finishData.actual_collar_qty = value;
                    state.finishStep = 3;
                    instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step3}</span>`;
                } else if (state.finishStep === 3) { 
                    state.finishData.actual_tail_qty = value;
                    state.finishStep = 4;
                    instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step4}</span>`;
                } else if (state.finishStep === 4) { 
                    state.finishData.qty_good = value;
                    
                    // æ–°å¢ï¼šé€²å…¥ç¬¬ 7 æ­¥ (ç¢ºèªç•«é¢)
                    state.finishStep = 7;
                    showSummary();
                    return;
                }
            } else if (state.finishStep === 5) { // è™•ç†æ¨™æº–å…©æ­¥é©Ÿ
                state.finishData.qty_good = value;
                state.finishStep = 6;
                instruction.innerHTML = `<span class="main-lang">${i18n[lang].finish_step5_reject}</span>`;
            } else if (state.finishStep === 6) { 
                 state.finishData.qty_reject = value;
                 // æ–°å¢ï¼šé€²å…¥ç¬¬ 7 æ­¥ (ç¢ºèªç•«é¢)
                 state.finishStep = 7;
                 showSummary();
                 return;
            }
            
            // å¦‚æœä¸æ˜¯ç¢ºèªæ­¥é©Ÿï¼Œæ‰é‡ç½®è¼¸å…¥æ¡†
            if (state.finishStep !== 7) {
                state.currentTypedValue = '0';
                document.getElementById('qty-input-display').textContent = '0';
            }
        }

        // æ–°å¢ï¼šé¡¯ç¤ºç¸½çµç•«é¢
        function showSummary() {
            const instruction = document.getElementById('finish-instruction');
            const lang = state.language;
            
            // æ§‹å»ºç¢ºèªè¨Šæ¯
            let summaryHTML = `<div style="font-size:0.8em; text-align:left; line-height:1.4;">
                ${i18n[lang].confirm_summary_title}<br>
                ----------------<br>
                ${i18n[lang].finish_step5_good}: <b>${state.finishData.qty_good}</b><br>
                ${i18n[lang].finish_step5_reject}: <b>${state.finishData.qty_reject}</b><br>`;
                
            if (state.finishData.actual_collar_qty > 0) {
                summaryHTML += `ä¸‹å·´: <b>${state.finishData.actual_collar_qty}</b> | å°¾æ®µ: <b>${state.finishData.actual_tail_qty}</b><br>`;
            }
            summaryHTML += `----------------<br><span style="color:#00e676">${i18n[lang].confirm_btn_text}</span></div>`;

            instruction.innerHTML = summaryHTML;
            // æ¸…ç©ºæ•¸å­—è¼¸å…¥é¡¯ç¤ºï¼Œä»¥å…æ··æ·†
            document.getElementById('qty-input-display').textContent = '---';
        }

        // è™•ç†ç¢ºèªéµé‚è¼¯
        function handleConfirmKey() {
            // å¦‚æœå·²ç¶“åœ¨ç¢ºèªæ­¥é©Ÿ (Step 7)ï¼ŒæŒ‰ä¸‹ OK å‰‡é€å‡º
            if (state.finishStep === 7) {
                confirmFinishWithYields();
            }
        }

        async function confirmFinishWithYields() {
            if (GAS_WEBHOOK_URL === 'YOUR_GAS_WEBHOOK_URL') {
                alert("ğŸš¨ éŒ¯èª¤: è«‹å…ˆæ›¿æ›ç¨‹å¼ç¢¼ä¸­çš„ GAS Webhook URL!");
                return;
            }

            if (state.isSubmitting) return; 
            state.isSubmitting = true;
            
            const session = state.activeSessions[state.currentViewingWoId];
            if (!session) {
                alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å·¥å–®è³‡è¨Š");
                state.isSubmitting = false;
                return;
            }

            const now = Date.now();
            const lastSegmentMs = now - session.lastUpdateTime;
            const lastSegmentHours = (lastSegmentMs / 3600000.0) * session.manpower;
            const totalManHours = (session.accumulatedManHours || 0) + lastSegmentHours;
            
            // åæ¨é‚è¼¯
            const effectiveDurationMs = (totalManHours / session.manpower) * 3600000.0;
            const effectiveStartTimeISO = new Date(now - effectiveDurationMs).toISOString();

            const postData = {
                token: SECURITY_TOKEN,
                supervisor_pin: state.currentUser.user_pin,
                operation_name: session.operationName,
                manpower_count: session.manpower,
                wo_id: state.currentViewingWoId,
                start_time: effectiveStartTimeISO, 
                qty_good: state.finishData.qty_good,
                qty_reject: state.finishData.qty_reject,
                actual_collar_qty: state.finishData.actual_collar_qty, 
                actual_tail_qty: state.finishData.actual_tail_qty     
            };
            
            try {
                const response = await fetch(GAS_WEBHOOK_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(postData)
                });
                const data = await response.json();
                
                if (data.success) {
                    // ç§»é™¤æˆåŠŸæç¤ºæ¡†ï¼Œç›´æ¥è·³è½‰
                    // alert(`${i18n[state.language].btn_confirm_submit} æˆåŠŸ! ${data.message}`);
                    
                    // ä¿å­˜å®Œæˆç´€éŒ„åˆ° LocalStorage ä¾›ç”Ÿç®¡æŸ¥è©¢
                    completedLogs.push({
                        ...postData,
                        endTime: new Date().toISOString(),
                        totalManHours: totalManHours
                    });
                    saveLogsToStorage();
                } else {
                    alert(`æäº¤å¤±æ•—: ${data.message}`);
                }
                
                delete state.activeSessions[state.currentViewingWoId];
                state.currentViewingWoId = null;
                
                state.finishData = {};
                showScreen('screen-queue');

            } catch (error) {
                alert(`${i18n[state.language].api_error}: ${error.message}`);
                showScreen('screen-queue'); 
            } finally {
                state.isSubmitting = false; 
            }
        }

        // ä¿®æ”¹ Keypad Handler ä»¥æ”¯æ´ç¢ºèªæ­¥é©Ÿ
        function handleKeypadInput(key) {
            if (state.isSubmitting && key === 'OK') return;

            // ç‰¹æ®Šè™•ç†ï¼šå¦‚æœåœ¨ç¢ºèªæ­¥é©Ÿï¼Œåªæœ‰ OK éµæœ‰æ•ˆ
            if (state.finishStep === 7) {
                if (key === 'OK') handleConfirmKey();
                return;
            }

            let displayElementId;
            let currentInput;

            if (state.currentScreen === 'login') {
                displayElementId = 'pin-input';
                currentInput = state.currentPIN;
            } else if (state.currentScreen === 'manpower') { 
                displayElementId = 'manpower-input-display';
                currentInput = state.currentTypedValue;
            } else { 
                displayElementId = 'qty-input-display';
                currentInput = state.currentTypedValue;
            }
            
            document.getElementById('login-error').textContent = ''; 

            if (key >= '0' && key <= '9') {
                if (currentInput.length < 8) {
                    currentInput = (currentInput === '0' || currentInput === '') ? key : currentInput + key;
                }
            } else if (key === 'C') {
                currentInput = '0';
            } else if (key === 'OK') {
                if (state.currentScreen === 'login') {
                    validateLogin(currentInput);
                } else if (state.currentScreen === 'manpower') { 
                    confirmManpower(parseInt(currentInput));
                } else if (state.currentScreen === 'finish') {
                    processFinishStep(parseFloat(currentInput));
                }
                return;
            }
            
            if (state.currentScreen === 'login') {
                state.currentPIN = currentInput;
                document.getElementById(displayElementId).textContent = currentInput.padEnd(4, '*').replace(/./g, '*').substring(0, 4);
            } else {
                state.currentTypedValue = currentInput;
                document.getElementById(displayElementId).textContent = currentInput;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
    </script>
</body>
</html>